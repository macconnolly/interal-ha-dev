# =============================================================================
# ZEN32 MODAL SCENE CONTROLLER PACKAGE - v4.0 (Production)
# =============================================================================
#
# DESIGN PHILOSOPHY:
#   1. THIN INTERFACE LAYER - Reads sensors, modifies helpers, triggers scripts
#   2. DRY (Don't Repeat Yourself) - Leverages 100% of existing infrastructure
#   3. PROGRESSIVE DISCLOSURE - Guests use 1x taps, power users discover Hold/2x
#
# ARCHITECTURAL PRINCIPLE:
#   ZEN32 should NEVER duplicate logic that exists elsewhere:
#   - Brightness calculations -> sensor.oal_real_time_monitor
#   - Override tracking -> sensor.oal_*_status
#   - Group management -> script.sonos_group_all_to_playing / ungroup_all
#   - Brightness adjustments -> script.oal_global_manual_brighter/dimmer
#   - Playing state -> binary_sensor.sonos_playing_status
#   - Coordinator -> sensor.sonos_current_playing_group_coordinator
#
# VERSION HISTORY:
#   v1.0 - Initial implementation with mixed Z-Wave/select entity approach
#   v1b  - Simplified gestures (removed Button 2/4 Hold/2x), smart group toggle
#   v3.0 - Production refactor with LED sequencer, brightness differentiation
#   v4.0 - DRY refactor: Best of v1b + v3, leverages existing infrastructure
#
# KEY IMPROVEMENTS v4.0:
#   - Uses binary_sensor.sonos_playing_status for playback detection
#   - Uses sensor.oal_system_status.active_zonal_overrides for manual detection
#   - Calls existing scripts (sonos_group_all_to_playing, oal_reset_soft)
#   - Logical track navigation: UP 2x = Next, DOWN 2x = Prev
#   - Keeps v1b smart group toggle on Button 3 Hold
#   - Simplified big button LED: Red=manual, White=on, Off=off
#   - Fixes v3.0 entity reference bugs (relay toggle via Z-Wave param)
#
# DEPENDENCIES:
#   - packages/OAL_lighting_control_package.yaml
#   - packages/sonos_package.yaml
#   - Z-Wave JS integration with ZEN32 configured
#
# =============================================================================
#
# BUTTON LAYOUT:
#   +---------------------------------+
#   |   +------------------------+    |
#   |   |     [5] LIGHTS         |    |  Toggle lights / Soft Reset / Movie
#   |   |    (BIG BUTTON)        |    |  LED: Red=override, White=on, OFF=off
#   |   +------------------------+    |
#   |                                 |
#   |   +----------+ +----------+     |
#   |   |[1] LIGHT | | [2] UP   |     |  Mode selector    Context increase
#   |   |  *LED    | |   *LED   |     |  (Yellow/OFF)     (Yellow/Blue)
#   |   +----------+ +----------+     |
#   |                                 |
#   |   +----------+ +----------+     |
#   |   |[3]VOLUME | | [4] DOWN |     |  Mode+Play/Pause  Context decrease
#   |   |  *LED    | |   *LED   |     |  (Blue/OFF)       (Yellow/Blue)
#   |   +----------+ +----------+     |
#   +---------------------------------+
#
# LED COLOR SCHEME:
#   LIGHT MODE:  [1] Yellow ON, [2] Yellow ON, [3] OFF,      [4] Yellow ON
#   VOLUME MODE: [1] OFF,       [2] Blue ON,   [3] Blue ON,  [4] Blue ON
#
# BIG BUTTON LED (simplified):
#   Red (bright)  = Any manual control (zonal overrides OR brightness offsets != 0)
#   White (medium) = Lights ON (adaptive mode)
#   Off           = Lights OFF
#
# GESTURE SPECIFICATION:
#
#   BRIGHTNESS MODE (Yellow LEDs):
#   Button 1 (LIGHT): 1x=No-op, Hold=-, 2x=WARMTH mode, 3x=Warm/cool toggle
#   Button 2 (UP):    1x=Brightness+, Hold=-, 2x=Full bright
#   Button 3 (VOL):   1x=VOLUME+Start, Hold=VOLUME+Favorites, 2x=VOLUME+Play/Pause, 3x=VOLUME+Group
#   Button 4 (DOWN):  1x=Brightness-, Hold=-, 2x=Min bright
#   Button 5 (BIG):   1x=Toggle lights, Hold=Reset, 2x=Config cycle, 3x=Sleep toggle
#
#   WARMTH MODE (Cyan LEDs):
#   Button 1 (LIGHT): 1x=BRIGHTNESS, Hold=BRIGHTNESS, 2x=No-op, 3x=Warm/cool toggle
#   Button 2 (UP):    1x=Warmer, Hold=-, 2x=Max warm (+1000K)
#   Button 3 (VOL):   1x=VOLUME+Start, Hold=VOLUME+Favorites, 2x=VOLUME+Play/Pause, 3x=VOLUME+Group
#   Button 4 (DOWN):  1x=Cooler, Hold=-, 2x=Max cool (-1000K)
#   Button 5 (BIG):   1x=Toggle lights, Hold=Reset, 2x=Config cycle, 3x=Sleep toggle
#
#   VOLUME MODE (Blue LEDs):
#   Button 1 (LIGHT): 1x=BRIGHTNESS, Hold=BRIGHTNESS, 2x=WARMTH, 3x=Warm/cool toggle
#   Button 2 (UP):    1x=Volume+, Hold=-, 2x=Next track
#   Button 3 (VOL):   1x=Start if idle, Hold=Cycle favorites, 2x=Play/Pause, 3x=Group toggle
#   Button 4 (DOWN):  1x=Volume-, Hold=-, 2x=Prev track
#   Button 5 (BIG):   1x=Toggle lights, Hold=Reset, 2x=Config cycle, 3x=Sleep toggle
#
#   CURATED FAVORITES (B3 Hold cycles): Songs → Daily Mix 1 → Daily Mix 2 (shuffle on)
#
# =============================================================================


# =============================================================================
# ENTITY REFERENCE (Z-Wave JS Integration)
# =============================================================================
#
# LED COLOR SELECT ENTITIES:
#   select.scene_controller_led_indicator_color_relay     (Button 5 - Big)
#   select.scene_controller_led_indicator_color_button_1  (LIGHT)
#   select.scene_controller_led_indicator_color_button_2  (UP)
#   select.scene_controller_led_indicator_color_button_3  (VOLUME)
#   select.scene_controller_led_indicator_color_button_4  (DOWN)
#   Options: White, Blue, Green, Red, Magenta, Yellow, Cyan
#
# LED TOGGLE SELECT ENTITIES:
#   select.scene_controller_led_indicator_relay              (Button 5 - Big)
#   select.scene_controller_led_indicator_button_1        (LIGHT)
#   select.scene_controller_led_indicator_button_2        (UP)
#   select.scene_controller_led_indicator_button_3        (VOLUME)
#   select.scene_controller_led_indicator_button_4        (DOWN)
#   Options: On when load is off, On when load is on, Always off, Always on
#
# LED BRIGHTNESS SELECT ENTITIES:
#   select.scene_controller_led_indicator_brightness_relay     (Button 5 - Big)
#   select.scene_controller_led_indicator_brightness_button_1  (LIGHT)
#   select.scene_controller_led_indicator_brightness_button_2  (UP)
#   select.scene_controller_led_indicator_brightness_button_3  (VOLUME)
#   select.scene_controller_led_indicator_brightness_button_4  (DOWN)
#   Options: Bright (100%), Medium (60%), Low (30%)
#
# LED FLASH CONTROL:
#   select.scene_controller_led_settings_indicator
#   Options: Enable, Disable (MUST be Disable for automation control)
#
# BUTTON EVENTS:
#   event.scene_controller_scene_001 (Button 1 - LIGHT)
#   event.scene_controller_scene_002 (Button 2 - UP)
#   event.scene_controller_scene_003 (Button 3 - VOLUME)
#   event.scene_controller_scene_004 (Button 4 - DOWN)
#   event.scene_controller_scene_005 (Button 5 - BIG)
#   Attribute event_type: KeyPressed, KeyPressed2x, KeyPressed3x, KeyHeldDown, KeyReleased
#
# Z-WAVE PARAMETERS (for big button toggle):
#   Parameter 1: Big button LED toggle (0=load off, 1=load on, 2=always off, 3=always on)
#
# =============================================================================





# =============================================================================
# INPUT HELPERS
# =============================================================================

input_select:
  zen32_control_mode:
    name: "ZEN32 Control Mode"
    options:
      - "brightness"
      - "volume"
      - "warmth"
    initial: "brightness"
    icon: mdi:toggle-switch-variant

input_datetime:
  zen32_mode_last_change:
    name: "ZEN32 Mode Last Change"
    has_date: true
    has_time: true
    icon: mdi:clock-check-outline

  zen32_last_button_press:
    name: "ZEN32 Last Button Press"
    has_date: true
    has_time: true
    icon: mdi:gesture-tap

input_number:
  sonos_favorite_index:
    name: "Sonos Favorite Index"
    min: 0
    max: 2  # 3 curated favorites: Songs, Daily Mix 1, Daily Mix 2
    step: 1
    initial: 0
    icon: mdi:playlist-music


# =============================================================================
# TEMPLATE SENSORS
# =============================================================================

template:
  - sensor:
      # -------------------------------------------------------------------------
      # Mode Status - Current mode with diagnostic attributes
      # -------------------------------------------------------------------------
      - name: "ZEN32 Mode Status"
        unique_id: zen32_mode_status
        state: "{{ states('input_select.zen32_control_mode') }}"
        icon: >
          {% set mode = states('input_select.zen32_control_mode') %}
          {{ 'mdi:music-circle' if mode == 'volume'
             else 'mdi:thermometer' if mode == 'warmth'
             else 'mdi:lightbulb-group' }}
        attributes:
          mode_color: >
            {% set mode = states('input_select.zen32_control_mode') %}
            {{ 'blue' if mode == 'volume' else 'cyan' if mode == 'warmth' else 'yellow' }}
          mode_color_value: >
            {% set mode = states('input_select.zen32_control_mode') %}
            {{ 1 if mode == 'volume' else 6 if mode == 'warmth' else 5 }}
          seconds_in_mode: >
            {% set last = states('input_datetime.zen32_mode_last_change') | as_datetime %}
            {{ ((now() - last).total_seconds() | int) if last else 0 }}
          is_brightness_mode: "{{ is_state('input_select.zen32_control_mode', 'brightness') }}"
          is_volume_mode: "{{ is_state('input_select.zen32_control_mode', 'volume') }}"
          is_warmth_mode: "{{ is_state('input_select.zen32_control_mode', 'warmth') }}"

      # -------------------------------------------------------------------------
      # Device ID - Auto-discovery for advanced scripts
      # -------------------------------------------------------------------------
      - name: "ZEN32 Controller Device ID"
        unique_id: zen32_controller_device_id
        state: "{{ device_id('event.scene_controller_scene_001') }}"
        availability: "{{ device_id('event.scene_controller_scene_001') is not none }}"
        icon: mdi:gesture-tap-button
        attributes:
          entity_source: "event.scene_controller_scene_001"

      # -------------------------------------------------------------------------
      # Sonos Favorites - Source list for cycling
      # -------------------------------------------------------------------------
      - name: "Sonos Favorites"
        unique_id: sonos_favorites
        state: "{{ (state_attr('media_player.living_room', 'source_list') | default([])) | length }}"
        icon: mdi:playlist-star
        attributes:
          items: >
            {% set sources = state_attr('media_player.living_room', 'source_list') | default([]) %}
            {{ dict(zip(range(sources|length)|list|map('string'), sources)) }}
          favorites_count: "{{ (state_attr('media_player.living_room', 'source_list') | default([])) | length }}"


# =============================================================================
# SCRIPTS - LED Control Infrastructure
# =============================================================================

script:
  # ---------------------------------------------------------------------------
  # LED Sequencer - Fire-and-forget sequential LED updates (no delays)
  # ---------------------------------------------------------------------------
  # ZEN32 Parameter Reference:
  #   Toggle: 1=relay, 2-5=buttons 1-4  (values: 0=off-when-on, 1=on-when-on, 2=always-off, 3=always-on)
  #   Color:  6=relay, 7-10=buttons 1-4 (values: 0=white, 1=blue, 2=green, 3=red, 4=magenta, 5=yellow, 6=cyan)
  #   Brightness: 11=relay, 12-15=buttons 1-4 (values: 0=bright, 1=medium, 2=low)
  #
  # NOTE: Z-Wave serializes ALL commands at the mesh level (~80-120ms per command).
  # No amount of HA-level parallelism can bypass this. Removing delays provides
  # the biggest performance win (saves 500-1000ms). HA queues select.select_option
  # calls internally, so we fire all commands without waiting.
  # ---------------------------------------------------------------------------
  zen32_led_sequencer:
    alias: "ZEN32 - LED Sequencer"
    description: "Rapid LED updates - fires all commands without delays"
    icon: mdi:led-strip-variant
    mode: restart
    max_exceeded: silent
    fields:
      buttons:
        description: "List of button configs: {button, color, toggle, brightness}"
        example: "[{button: 1, color: yellow, toggle: always_on, brightness: bright}]"
        required: false
      updates:
        description: "Legacy: List of {entity, option} dicts for raw entity control"
        required: false
    variables:
      _buttons: "{{ buttons | default([]) }}"
      _raw_updates: "{{ updates | default([]) }}"

      # Color normalization map
      _color_map:
        white: "White"
        blue: "Blue"
        green: "Green"
        red: "Red"
        magenta: "Magenta"
        yellow: "Yellow"
        cyan: "Cyan"

      # Toggle normalization map
      _toggle_map:
        always_on: "Always on"
        always_off: "Always off"
        on_when_on: "On when load is on"
        on_when_off: "On when load is off"

      # Brightness normalization map
      _brightness_map:
        bright: "Bright (100%)"
        medium: "Medium (60%)"
        low: "Low (30%)"

      # Expand button configs to entity/option pairs
      _button_updates: >
        {% set ns = namespace(items=[]) %}
        {% for btn in _buttons %}
          {% set suffix = 'relay' if btn.button in [5, '5', 'relay', 'big'] else 'button_' ~ btn.button %}
          {% if btn.color is defined %}
            {% set color_val = _color_map.get(btn.color | lower, btn.color) %}
            {% set ns.items = ns.items + [{'entity': 'select.scene_controller_led_indicator_color_' ~ suffix, 'option': color_val}] %}
          {% endif %}
          {% if btn.toggle is defined %}
            {% set toggle_val = _toggle_map.get(btn.toggle | lower | replace(' ', '_'), btn.toggle) %}
            {% set ns.items = ns.items + [{'entity': 'select.scene_controller_led_indicator_' ~ suffix, 'option': toggle_val}] %}
          {% endif %}
          {% if btn.brightness is defined %}
            {% set bright_val = _brightness_map.get(btn.brightness | lower, btn.brightness) %}
            {% set ns.items = ns.items + [{'entity': 'select.scene_controller_led_indicator_brightness_' ~ suffix, 'option': bright_val}] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}

      # Combine button-derived updates with raw updates
      _all_updates: "{{ _button_updates + _raw_updates }}"

    sequence:
      # Fire all commands as fast as possible - NO DELAYS
      # Z-Wave driver will queue and serialize, but we minimize HA overhead
      - repeat:
          for_each: "{{ _all_updates }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: "{{ repeat.item.entity }}"
              data:
                option: "{{ repeat.item.option }}"
              continue_on_error: true

  # ---------------------------------------------------------------------------
  # Set Single LED - Utility for individual button control
  # ---------------------------------------------------------------------------
  zen32_set_led:
    alias: "ZEN32 - Set Single LED"
    description: "Set color, toggle, and/or brightness for one button"
    icon: mdi:led-on
    mode: parallel
    max: 10
    fields:
      button:
        description: "Button number (1-4) or 5/'relay' for big button"
        example: 1
        required: true
      color:
        description: "LED color (case-insensitive)"
        example: "yellow"
        required: false
      toggle:
        description: "LED toggle state"
        example: "Always on"
        required: false
      brightness:
        description: "LED brightness level (only works for button 1 and 5/relay)"
        example: "Bright (100%)"
        required: false
    variables:
      # Normalize button identifier
      btn_suffix: >
        {% if button in [5, '5', 'relay', 'big'] %}relay{% else %}button_{{ button }}{% endif %}
      is_relay: "{{ button in [5, '5', 'relay', 'big'] }}"
      color_entity: "select.scene_controller_led_indicator_color_{{ btn_suffix }}"
      toggle_entity: "select.scene_controller_led_indicator_{{ btn_suffix }}"
      brightness_entity: "select.scene_controller_led_indicator_brightness_{{ btn_suffix }}"

      # Normalize color (case-insensitive)
      normalized_color: >
        {% set map = {'white': 'White', 'blue': 'Blue', 'green': 'Green', 'red': 'Red',
                      'magenta': 'Magenta', 'yellow': 'Yellow', 'cyan': 'Cyan'} %}
        {{ map.get(color | lower, 'White') if color is defined and color else none }}

      # Normalize toggle (case-insensitive)
      normalized_toggle: >
        {% set map = {'on_when_off': 'On when load is off', 'on when load is off': 'On when load is off',
                      'on_when_on': 'On when load is on', 'on when load is on': 'On when load is on',
                      'always_off': 'Always off', 'always off': 'Always off',
                      'always_on': 'Always on', 'always on': 'Always on'} %}
        {{ map.get(toggle | lower, toggle) if toggle is defined and toggle else none }}

      # Normalize brightness (case-insensitive)
      normalized_brightness: >
        {% set map = {'bright': 'Bright (100%)', 'bright (100%)': 'Bright (100%)',
                      'medium': 'Medium (60%)', 'medium (60%)': 'Medium (60%)',
                      'low': 'Low (30%)', 'low (30%)': 'Low (30%)'} %}
        {{ map.get(brightness | lower, brightness) if brightness is defined and brightness else none }}

    sequence:
      # Set color (works for all buttons)
      - if:
          - condition: template
            value_template: "{{ normalized_color is not none }}"
        then:
          - service: select.select_option
            target:
              entity_id: "{{ color_entity }}"
            data:
              option: "{{ normalized_color }}"
            continue_on_error: true

      # Set toggle - works for all buttons including relay
      - if:
          - condition: template
            value_template: "{{ normalized_toggle is not none }}"
        then:
          - service: select.select_option
            target:
              entity_id: "{{ toggle_entity }}"
            data:
              option: "{{ normalized_toggle }}"
            continue_on_error: true

      # Set brightness (works for all buttons)
      - if:
          - condition: template
            value_template: "{{ normalized_brightness is not none }}"
        then:
          - service: select.select_option
            target:
              entity_id: "{{ brightness_entity }}"
            data:
              option: "{{ normalized_brightness }}"
            continue_on_error: true

  # ---------------------------------------------------------------------------
  # Blink Confirmation - Visual feedback for actions
  # ---------------------------------------------------------------------------
  zen32_blink_confirm:
    alias: "ZEN32 - Blink Confirmation"
    description: "Blink button LED green to confirm action"
    icon: mdi:led-on
    mode: restart
    fields:
      button:
        description: "Button to blink (1-5)"
        example: 1
        required: true
      blink_count:
        description: "Number of blinks"
        example: 2
        default: 2
    variables:
      btn_suffix: >
        {% if button in [5, '5', 'relay', 'big'] %}relay{% else %}button_{{ button }}{% endif %}
      is_relay: "{{ button in [5, '5', 'relay', 'big'] }}"
      toggle_entity: "select.scene_controller_led_indicator_{{ btn_suffix }}"
      color_entity: "select.scene_controller_led_indicator_color_{{ btn_suffix }}"
      count: "{{ blink_count | default(2) | int }}"
    sequence:
      - repeat:
          count: "{{ count }}"
          sequence:
            # Turn off
            - service: select.select_option
              target:
                entity_id: "{{ toggle_entity }}"
              data:
                option: "Always off"
            - delay:
                milliseconds: 100
            # Set green
            - service: select.select_option
              target:
                entity_id: "{{ color_entity }}"
              data:
                option: "Green"
            # Turn on
            - service: select.select_option
              target:
                entity_id: "{{ toggle_entity }}"
              data:
                option: "Always on"
            - delay:
                milliseconds: 50


  # ---------------------------------------------------------------------------
  # Set Mode: BRIGHTNESS
  # ---------------------------------------------------------------------------
  # ---------------------------------------------------------------------------
  # Set Mode: BRIGHTNESS
  # ---------------------------------------------------------------------------
  zen32_set_mode_brightness:
    alias: "ZEN32 - Set BRIGHTNESS Mode"
    description: "Switch to BRIGHTNESS mode (state only)"
    icon: mdi:brightness-6
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.zen32_control_mode
        data:
          option: "brightness"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_mode_last_change
        data:
          datetime: "{{ now() }}"

  # ---------------------------------------------------------------------------
  # Set Mode: VOLUME
  # ---------------------------------------------------------------------------
  zen32_set_mode_volume:
    alias: "ZEN32 - Set VOLUME Mode"
    description: "Switch to VOLUME mode (state only)"
    icon: mdi:volume-high
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.zen32_control_mode
        data:
          option: "volume"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_mode_last_change
        data:
          datetime: "{{ now() }}"

  # ---------------------------------------------------------------------------
  # Set Mode: WARMTH
  # ---------------------------------------------------------------------------
  zen32_set_mode_warmth:
    alias: "ZEN32 - Set WARMTH Mode"
    description: "Switch to WARMTH mode (state only)"
    icon: mdi:thermometer
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.zen32_control_mode
        data:
          option: "warmth"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_mode_last_change
        data:
          datetime: "{{ now() }}"

  # ===========================================================================
  # COMPOSITE ACTION SCRIPTS (for centralized dispatcher)
  # ===========================================================================
  # These thin wrappers combine mode switch + action for clean dispatch.
  # The action_map references these by name for multi-step actions.
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # Enter Volume Mode + Start If Idle
  # ---------------------------------------------------------------------------
  zen32_enter_volume_start:
    alias: "ZEN32 - Enter Volume + Start"
    icon: mdi:play-circle
    mode: single
    sequence:
      - service: script.zen32_set_mode_volume
      - if:
          - condition: template
            value_template: "{{ not state_attr('binary_sensor.sonos_playing_status', 'is_playing') | default(false) }}"
        then:
          - service: script.zen32_sonos_start

  # ---------------------------------------------------------------------------
  # Enter Volume Mode + Cycle Favorites
  # ---------------------------------------------------------------------------
  zen32_enter_volume_favorites:
    alias: "ZEN32 - Enter Volume + Favorites"
    icon: mdi:playlist-star
    mode: single
    sequence:
      - service: script.zen32_set_mode_volume
      - service: script.zen32_cycle_sonos_favorite

  # ---------------------------------------------------------------------------
  # Enter Volume Mode + Play/Pause
  # ---------------------------------------------------------------------------
  zen32_enter_volume_play_pause:
    alias: "ZEN32 - Enter Volume + Play/Pause"
    icon: mdi:play-pause
    mode: single
    sequence:
      - service: script.zen32_set_mode_volume
      - service: script.zen32_sonos_play_pause

  # ---------------------------------------------------------------------------
  # Enter Volume Mode (if not already) + Group Toggle
  # ---------------------------------------------------------------------------
  zen32_enter_volume_group_toggle:
    alias: "ZEN32 - Enter Volume + Group Toggle"
    icon: mdi:speaker-multiple
    mode: single
    sequence:
      - if:
          - condition: template
            value_template: "{{ not is_state('input_select.zen32_control_mode', 'volume') }}"
        then:
          - service: script.zen32_set_mode_volume
      - service: script.zen32_sonos_smart_group_toggle

  # ---------------------------------------------------------------------------
  # Start Playback If Idle (no mode change)
  # ---------------------------------------------------------------------------
  zen32_start_if_idle:
    alias: "ZEN32 - Start If Idle"
    icon: mdi:play
    mode: single
    sequence:
      - if:
          - condition: template
            value_template: "{{ not state_attr('binary_sensor.sonos_playing_status', 'is_playing') | default(false) }}"
        then:
          - service: script.zen32_sonos_start

  # ---------------------------------------------------------------------------
  # Brightness Up (with lights-off handling)
  # ---------------------------------------------------------------------------
  zen32_brightness_up:
    alias: "ZEN32 - Brightness Up"
    icon: mdi:brightness-5
    mode: single
    sequence:
      - if:
          - condition: state
            entity_id: light.all_adaptive_lights
            state: "off"
        then:
          - service: light.turn_on
            target:
              entity_id: light.all_adaptive_lights
      - service: script.oal_global_manual_brighter

  # ---------------------------------------------------------------------------
  # Brightness Down (with lights-off handling)
  # ---------------------------------------------------------------------------
  zen32_brightness_down:
    alias: "ZEN32 - Brightness Down"
    icon: mdi:brightness-4
    mode: single
    sequence:
      - if:
          - condition: state
            entity_id: light.all_adaptive_lights
            state: "off"
        then:
          - service: light.turn_on
            target:
              entity_id: light.all_adaptive_lights
      - service: script.oal_global_manual_dimmer

  # ---------------------------------------------------------------------------
  # Sonos Volume Up
  # ---------------------------------------------------------------------------
  # Sonos Volume Up - Group-aware
  # ---------------------------------------------------------------------------
  zen32_sonos_volume_up:
    alias: "ZEN32 - Volume Up"
    icon: mdi:volume-plus
    mode: single
    sequence:
      - action: script.sonos_group_volume_adjust
        data:
          coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
          adjustment: 0.05

  # ---------------------------------------------------------------------------
  # Sonos Volume Down - Group-aware
  # ---------------------------------------------------------------------------
  zen32_sonos_volume_down:
    alias: "ZEN32 - Volume Down"
    icon: mdi:volume-minus
    mode: single
    sequence:
      - action: script.sonos_group_volume_adjust
        data:
          coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
          adjustment: -0.05

  # ---------------------------------------------------------------------------
  # Toggle All Lights
  # ---------------------------------------------------------------------------
  zen32_toggle_lights:
    alias: "ZEN32 - Toggle Lights"
    icon: mdi:lightbulb-group
    mode: single
    variables:
      all_lights: "{{ expand('light.all_adaptive_lights') | map(attribute='entity_id') | list }}"
      any_on: "{{ expand('light.all_adaptive_lights') | selectattr('state', 'eq', 'on') | list | length > 0 }}"
    sequence:
      - if: "{{ any_on }}"
        then:
          - service: light.turn_off
            target:
              entity_id: "{{ all_lights }}"
        else:
          - service: light.turn_on
            target:
              entity_id: "{{ all_lights }}"

  # ---------------------------------------------------------------------------
  # Cycle OAL Configuration Presets
  # ---------------------------------------------------------------------------
  zen32_cycle_oal_config:
    alias: "ZEN32 - Cycle OAL Config"
    icon: mdi:cog-refresh
    mode: single
    variables:
      allowed_configs: ["Adaptive", "Full Bright", "Dim Ambient", "Warm Ambient", "TV Mode"]
      current: "{{ states('input_select.oal_active_configuration') }}"
      current_idx: "{{ allowed_configs.index(current) if current in allowed_configs else -1 }}"
      next_idx: "{{ (current_idx + 1) % (allowed_configs | length) }}"
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: "{{ allowed_configs[next_idx] }}"

  # ---------------------------------------------------------------------------
  # Toggle Sleep Mode (via config dropdown)
  # ---------------------------------------------------------------------------
  zen32_toggle_sleep_mode:
    alias: "ZEN32 - Toggle Sleep Mode"
    icon: mdi:sleep
    mode: single
    sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: >
            {{ 'Adaptive' if states('input_select.oal_active_configuration') == 'Sleep' else 'Sleep' }}

  # ---------------------------------------------------------------------------
  # Warm/Cool Toggle (B1 3x)
  # ---------------------------------------------------------------------------
  # Toggles between warm (+500K) and cool (-500K) color offset
  # If in volume mode, switches to brightness first
  # ---------------------------------------------------------------------------
  zen32_warm_cool_toggle:
    alias: "ZEN32 - Warm/Cool Toggle"
    icon: mdi:thermometer
    mode: single
    sequence:
      # Switch to brightness if in volume mode
      - if:
          - condition: state
            entity_id: input_select.zen32_control_mode
            state: "volume"
        then:
          - service: script.zen32_set_mode_brightness
      # Toggle warm/cool offset
      - choose:
          - conditions: "{{ states('input_number.oal_offset_global_manual_warmth') | float(0) <= 0 }}"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_offset_global_manual_warmth
                data:
                  value: 500
        default:
          - service: input_number.set_value
            target:
              entity_id: input_number.oal_offset_global_manual_warmth
            data:
              value: -500

  # ---------------------------------------------------------------------------
  # Warmth Preset - Max Warm (+1000K offset)
  # ---------------------------------------------------------------------------
  zen32_warmth_max:
    alias: "ZEN32 - Max Warm Preset"
    description: "Set warmth to maximum (+1000K offset)"
    icon: mdi:thermometer-high
    mode: single
    sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_global_manual_warmth
        data:
          value: 1000

  # ---------------------------------------------------------------------------
  # Warmth Preset - Max Cool (-1000K offset)
  # ---------------------------------------------------------------------------
  zen32_warmth_min:
    alias: "ZEN32 - Max Cool Preset"
    description: "Set warmth to minimum (-1000K offset)"
    icon: mdi:thermometer-low
    mode: single
    sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_global_manual_warmth
        data:
          value: -1000

  # ---------------------------------------------------------------------------
  # Update Big Button LED - Simplified priority
  # ---------------------------------------------------------------------------
  # Red = Any manual control (zonal overrides OR non-zero brightness offsets)
  # White = Lights on (adaptive mode)
  # Off = Lights off
  # ---------------------------------------------------------------------------
  zen32_update_big_button_led:
    alias: "ZEN32 - Update Big Button LED"
    description: "Set big button LED: Red=wall switch override, White=on, Off=off"
    icon: mdi:gesture-tap-button
    mode: single
    variables:
      # Manual control = physical light touches only (wall switches, app adjustments)
      # ZEN32 brightness adjustments are "assisted adaptive" - not manual override
      has_manual_control: "{{ state_attr('sensor.oal_system_status', 'active_zonal_overrides') | int(0) > 0 }}"
      # Sleep mode active
      is_sleep_mode: "{{ states('input_select.oal_active_configuration') == 'Sleep' }}"
      # Non-adaptive config active (Full Bright, Dim Ambient, Warm Ambient, TV Mode)
      is_non_adaptive_config: >
        {{ states('input_select.oal_active_configuration') not in ['Adaptive', 'Manual', 'Sleep'] }}
    sequence:
      - choose:
          # Priority 0: Sleep mode = DIM BLUE
          - conditions: "{{ is_sleep_mode }}"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_color_relay
                data:
                  option: "Blue"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_relay
                data:
                  option: "Always on"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_brightness_relay
                data:
                  option: "Low (30%)"

          # Red: Manual overrides OR user-adjusted brightness
          - conditions: "{{ has_manual_control }}"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_color_relay
                data:
                  option: "Red"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_relay
                data:
                  option: "Always on"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_brightness_relay
                data:
                  option: "Bright (100%)"

          # Green: Non-Adaptive Configuration (Full Bright, Dim Ambient, Warm Ambient, TV Mode)
          - conditions: "{{ is_non_adaptive_config }}"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_color_relay
                data:
                  option: "Green"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_relay
                data:
                  option: "Always on"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_brightness_relay
                data:
                  option: "Medium (60%)"

          # White: Lights ON (adaptive mode, no manual adjustments)
          - conditions:
              - condition: state
                entity_id: light.all_adaptive_lights
                state: "on"
            sequence:
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_color_relay
                data:
                  option: "White"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_relay
                data:
                  option: "Always on"
              - service: select.select_option
                target:
                  entity_id: select.scene_controller_led_indicator_brightness_relay
                data:
                  option: "Medium (60%)"

        # Off: Lights OFF
        default:
          - service: select.select_option
            target:
              entity_id: select.scene_controller_led_indicator_relay
            data:
              option: "Always off"


  # ---------------------------------------------------------------------------
  # Full Brightness - All zones to maximum (uses existing OAL scripts)
  # ---------------------------------------------------------------------------
  zen32_full_brightness:
    alias: "ZEN32 - Full Brightness"
    description: "Set all zones to max brightness (skipped in Manual preset)"
    icon: mdi:brightness-7
    mode: single
    sequence:
      # Guard: Skip in Manual preset (OAL engine not running)
      - if:
          - condition: state
            entity_id: input_select.oal_active_configuration
            state: "Manual"
        then:
          - service: system_log.write
            data:
              message: "ZEN32: Skipping full brightness - OAL preset is Manual"
              level: info
          - stop: "OAL in Manual preset"

      # Ensure lights are on
      - if:
          - condition: state
            entity_id: light.all_adaptive_lights
            state: "off"
        then:
          - service: light.turn_on
            target:
              entity_id: light.all_adaptive_lights

      # Set all zone offsets to +50
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.oal_manual_offset_main_living_brightness
            - input_number.oal_manual_offset_kitchen_island_brightness
            - input_number.oal_manual_offset_bedroom_primary_brightness
            - input_number.oal_manual_offset_accent_spots_brightness
            - input_number.oal_manual_offset_recessed_ceiling_brightness
            - input_number.oal_manual_offset_column_lights_brightness
        data:
          value: 50

      # Trigger OAL engine
      - service: script.oal_global_adjustment_start

  # ---------------------------------------------------------------------------
  # Minimum Brightness - All zones to ambient minimum
  # ---------------------------------------------------------------------------
  zen32_minimum_brightness:
    alias: "ZEN32 - Minimum Brightness"
    description: "Set all zones to minimum brightness (skipped in Manual preset)"
    icon: mdi:brightness-4
    mode: single
    sequence:
      # Guard: Skip in Manual preset (OAL engine not running)
      - if:
          - condition: state
            entity_id: input_select.oal_active_configuration
            state: "Manual"
        then:
          - service: system_log.write
            data:
              message: "ZEN32: Skipping minimum brightness - OAL preset is Manual"
              level: info
          - stop: "OAL in Manual preset"

      # Ensure lights are on
      - if:
          - condition: state
            entity_id: light.all_adaptive_lights
            state: "off"
        then:
          - service: light.turn_on
            target:
              entity_id: light.all_adaptive_lights

      # Set all zone offsets to -50
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.oal_manual_offset_main_living_brightness
            - input_number.oal_manual_offset_kitchen_island_brightness
            - input_number.oal_manual_offset_bedroom_primary_brightness
            - input_number.oal_manual_offset_accent_spots_brightness
            - input_number.oal_manual_offset_recessed_ceiling_brightness
            - input_number.oal_manual_offset_column_lights_brightness
        data:
          value: -50

      # Trigger OAL engine
      - service: script.oal_global_adjustment_start


# =============================================================================
# SCRIPTS - Sonos Control (DRY - uses existing sensors and scripts)
# =============================================================================

  # ---------------------------------------------------------------------------
  # Play/Pause Toggle - Uses binary_sensor for playing detection
  # ---------------------------------------------------------------------------
  zen32_sonos_play_pause:
    alias: "ZEN32 - Sonos Play/Pause"
    icon: mdi:play-pause
    mode: single
    variables:
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
    sequence:
      - service: media_player.media_play_pause
        target:
          entity_id: "{{ coordinator }}"

  # ---------------------------------------------------------------------------
  # Start Playback - Uses existing sensors for state detection
  # ---------------------------------------------------------------------------
  zen32_sonos_start:
    alias: "ZEN32 - Sonos Start"
    icon: mdi:play
    mode: single
    variables:
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
      is_idle: "{{ states(coordinator) in ['idle', 'off', 'unknown', 'unavailable'] }}"
      default_volume: "{{ states('input_number.sonos_default_volume') | float(0.25) }}"
    sequence:
      - choose:
          - conditions: "{{ is_idle }}"
            sequence:
              - service: media_player.volume_set
                target:
                  entity_id: "{{ coordinator }}"
                data:
                  volume_level: "{{ default_volume }}"
              - service: script.zen32_cycle_sonos_favorite
        default:
          - service: media_player.media_play
            target:
              entity_id: "{{ coordinator }}"

  # ---------------------------------------------------------------------------
  # Volume Step (+/- 10%)
  # ---------------------------------------------------------------------------
  zen32_sonos_volume_step:
    alias: "ZEN32 - Sonos Volume Step"
    icon: mdi:volume-medium
    mode: queued
    max: 5
    fields:
      direction:
        description: "1 for volume up, -1 for volume down"
        example: 1
        required: true
    variables:
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
      current: "{{ state_attr(coordinator, 'volume_level') | float(0.5) }}"
      new_volume: "{{ [[0.0, current + (0.05 * direction | int)] | max, 1.0] | min }}"
    sequence:
      - service: media_player.volume_set
        target:
          entity_id: "{{ coordinator }}"
        data:
          volume_level: "{{ new_volume }}"

  # ---------------------------------------------------------------------------
  # Next Track
  # ---------------------------------------------------------------------------
  zen32_sonos_next_track:
    alias: "ZEN32 - Sonos Next Track"
    icon: mdi:skip-next
    mode: single
    variables:
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
    sequence:
      - service: media_player.media_next_track
        target:
          entity_id: "{{ coordinator }}"

  # ---------------------------------------------------------------------------
  # Previous Track
  # ---------------------------------------------------------------------------
  zen32_sonos_prev_track:
    alias: "ZEN32 - Sonos Previous Track"
    icon: mdi:skip-previous
    mode: single
    variables:
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
    sequence:
      - service: media_player.media_previous_track
        target:
          entity_id: "{{ coordinator }}"

  # ---------------------------------------------------------------------------
  # Smart Group Toggle - Calls EXISTING scripts (DRY)
  # ---------------------------------------------------------------------------
  zen32_sonos_smart_group_toggle:
    alias: "ZEN32 - Smart Group Toggle"
    description: "Toggle group state - ungroup if grouped, group if not"
    icon: mdi:speaker-multiple
    mode: single
    variables:
      is_grouped: "{{ (state_attr('sensor.sonos_current_playing_group_coordinator', 'group_members') | default([]) | length) > 1 }}"
    sequence:
      - choose:
          - conditions: "{{ is_grouped }}"
            sequence:
              - service: script.sonos_ungroup_all
        default:
          - service: script.sonos_group_all_to_playing

  # ---------------------------------------------------------------------------
  # Cycle Sonos Favorites - Curated rotation with shuffle
  # ---------------------------------------------------------------------------
  # Cycles through: Songs → Daily Mix 1 → Daily Mix 2 → Songs...
  # Enables shuffle mode for playlist variety
  # ---------------------------------------------------------------------------
  zen32_cycle_sonos_favorite:
    alias: "ZEN32 - Cycle Sonos Favorite"
    icon: mdi:playlist-star
    mode: single
    variables:
      # CURATED FAVORITES LIST - order matters!
      curated_favorites:
        - {id: "FV:2/10", name: "Songs"}
        - {id: "FV:2/0", name: "Daily Mix 1"}
        - {id: "FV:2/4", name: "Daily Mix 2"}
      count: "{{ curated_favorites | length }}"
      current: "{{ states('input_number.sonos_favorite_index') | int(0) }}"
      next_idx: "{{ (current + 1) % count }}"
      next_favorite: "{{ curated_favorites[next_idx] }}"
      coordinator: "{{ states('sensor.sonos_smart_coordinator') }}"
      default_volume: "{{ states('input_number.sonos_default_volume') | float(0.5) }}"
    sequence:
      - condition: template
        value_template: "{{ count > 0 }}"

      # Update index tracker
      - service: input_number.set_value
        target:
          entity_id: input_number.sonos_favorite_index
        data:
          value: "{{ next_idx }}"

      # Set volume if not already playing
      - if:
          - condition: template
            value_template: "{{ not is_state(coordinator, 'playing') }}"
        then:
          - service: media_player.volume_set
            target:
              entity_id: "{{ coordinator }}"
            data:
              volume_level: "{{ default_volume }}"

      # Start the favorite playlist
      - service: media_player.play_media
        target:
          entity_id: "{{ coordinator }}"
        data:
          media_content_type: "favorite_item_id"
          media_content_id: "{{ next_favorite.id }}"

      # Enable shuffle for variety
      - delay:
          milliseconds: 500
      - service: media_player.shuffle_set
        target:
          entity_id: "{{ coordinator }}"
        data:
          shuffle: true

      - service: system_log.write
        data:
          message: "ZEN32: Playing favorite {{ next_idx + 1 }}/{{ count }}: {{ next_favorite.name }} (shuffle on)"
          level: info


# =============================================================================
# AUTOMATIONS
# =============================================================================

automation:
  # ---------------------------------------------------------------------------
  # Startup Initialization
  # ---------------------------------------------------------------------------
  - id: zen32_startup_init_v4
    alias: "ZEN32 - Initialize on Startup"
    description: "Initialize ZEN32 with wait_template for entity availability"
    mode: single
    trigger:
      - platform: homeassistant
        event: start
    action:
      # Set BRIGHTNESS mode immediately
      - service: input_select.select_option
        target:
          entity_id: input_select.zen32_control_mode
        data:
          option: "brightness"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_mode_last_change
        data:
          datetime: "{{ now() }}"

      - service: system_log.write
        data:
          message: "ZEN32 v4 startup: Waiting for Z-Wave entities..."
          level: info

      # Wait for Z-Wave entities
      - wait_template: >
          {{ states('select.scene_controller_led_indicator_color_button_1')
             not in ['unavailable', 'unknown'] }}
        timeout:
          seconds: 120
        continue_on_timeout: true

      - if:
          - condition: template
            value_template: >
              {{ states('select.scene_controller_led_indicator_color_button_1')
                 in ['unavailable', 'unknown'] }}
        then:
          - service: system_log.write
            data:
              message: "ZEN32 v4 startup: LED entities unavailable after 120s - skipping LED init"
              level: warning
        else:
          # Disable LED flash for automation control
          - service: select.select_option
            target:
              entity_id: select.scene_controller_led_settings_indicator
            data:
              option: "Disable"

          - delay:
              milliseconds: 500

          # Apply LIGHT mode LEDs
          - service: script.zen32_set_mode_brightness

          # Apply big button state
          - service: script.zen32_update_big_button_led

          - service: system_log.write
            data:
              message: "ZEN32 v4 startup: Initialization complete"
              level: info

          # Force LED Sync
          - event: zen32_force_led_sync

  # ---------------------------------------------------------------------------
  # Big Button LED State Sync
  # ---------------------------------------------------------------------------
  - id: zen32_big_button_state_sync_v4
    alias: "ZEN32 - Big Button LED State Sync"
    description: "Sync big button LED: Red=wall switch override, White=on, Off=off"
    mode: restart
    trigger:
      # Light state changes
      - platform: state
        entity_id: light.all_adaptive_lights
      # Zonal override changes (physical light touches - wall switch, app)
      - platform: state
        entity_id: sensor.oal_system_status
        attribute: active_zonal_overrides
      # OAL configuration changes (covers sleep mode, config cycling, etc.)
      - platform: state
        entity_id: input_select.oal_active_configuration
    action:
      - service: script.zen32_update_big_button_led

  # ---------------------------------------------------------------------------
  # Mode LED Sync (external mode changes)
  # ---------------------------------------------------------------------------
  # ---------------------------------------------------------------------------
  # LED State Machine - CENTRALIZED LED CONTROL
  # ---------------------------------------------------------------------------
  - id: zen32_led_state_machine
    alias: "ZEN32 - LED State Machine"
    description: "Centralized State Machine: Updates LEDs whenever Control Mode changes"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.zen32_control_mode
        to: null # Trigger on ANY state change
      - platform: event
        event_type: zen32_force_led_sync # Hook for startup/manual sync
    variables:
      # CENTRALIZED CONFIGURATION MAP
      mode_configs:
        brightness:
          - {button: 1, color: yellow, toggle: always_on, brightness: bright}
          - {button: 2, color: yellow, toggle: always_on, brightness: bright}
          - {button: 3, toggle: always_off}
          - {button: 4, color: yellow, toggle: always_on, brightness: bright}
        volume:
          - {button: 1, toggle: always_off}
          - {button: 2, color: blue, toggle: always_on, brightness: bright}
          - {button: 3, color: blue, toggle: always_on, brightness: bright}
          - {button: 4, color: blue, toggle: always_on, brightness: bright}
        warmth:
          - {button: 1, color: cyan, toggle: always_on, brightness: bright}
          - {button: 2, color: cyan, toggle: always_on, brightness: bright}
          - {button: 3, toggle: always_off}
          - {button: 4, color: cyan, toggle: always_on, brightness: bright}
      
      current_mode: "{{ states('input_select.zen32_control_mode') }}"
      selected_config: "{{ mode_configs.get(current_mode, []) }}"
    action:
      - service: script.zen32_led_sequencer
        data:
          buttons: "{{ selected_config }}"

  # ---------------------------------------------------------------------------
  # Modal Controller Handler - Button Event Dispatch (DRY REFACTOR)
  # ---------------------------------------------------------------------------
  - id: zen32_modal_controller_handler_v4
    alias: "ZEN32 - Modal Controller Handler"
    description: "Modal button handler for LIGHT and VOLUME modes (v4 DRY)"
    mode: single
    trigger:
      - platform: state
        entity_id: event.scene_controller_scene_001
        id: "button_1"
      - platform: state
        entity_id: event.scene_controller_scene_002
        id: "button_2"
      - platform: state
        entity_id: event.scene_controller_scene_003
        id: "button_3"
      - platform: state
        entity_id: event.scene_controller_scene_004
        id: "button_4"
      - platform: state
        entity_id: event.scene_controller_scene_005
        id: "button_5"

    variables:
      # =======================================================================
      # TRIGGER METADATA
      # =======================================================================
      event_type: "{{ (trigger.to_state.attributes.event_type | default('unknown')) if trigger.to_state else 'unknown' }}"
      button_id: "{{ trigger.id | default('unknown') }}"
      mode: "{{ states('input_select.zen32_control_mode') | default('brightness') }}"

      # Pre-computed flags (for backward compatibility and readability)
      is_brightness: "{{ mode == 'brightness' }}"
      is_volume: "{{ mode == 'volume' }}"
      is_warmth: "{{ mode == 'warmth' }}"
      sonos_playing: "{{ state_attr('binary_sensor.sonos_playing_status', 'is_playing') | default(false) }}"
      lights_on: "{{ is_state('light.all_adaptive_lights', 'on') }}"

      # =======================================================================
      # MODE-CENTRIC ACTION MAP - Each mode defines its complete behavior
      # =======================================================================
      # Format: mode_actions[mode][button_gesture] = [script_names]
      #
      # ADDING A NEW MODE:
      # 1. Add new block under mode_actions (copy existing, customize)
      # 2. Add to input_select.zen32_control_mode options
      # 3. Add LED config to zen32_led_state_machine.mode_configs
      # =======================================================================
      gesture_key: "{{ 'b' ~ button_id[-1] ~ '_' ~ {'KeyPressed':'1x','KeyHeldDown':'hold','KeyPressed2x':'2x','KeyPressed3x':'3x'}[event_type] }}"

      mode_actions:
        # --------------------------------------------------------------------
        # BRIGHTNESS MODE - Light intensity control
        # --------------------------------------------------------------------
        brightness:
          b1_1x: []                              # no-op (already in brightness)
          b1_hold: []                            # removed: warmth handled in warmth mode
          b1_2x: [zen32_set_mode_warmth]
          b1_3x: [zen32_warm_cool_toggle]
          b2_1x: [zen32_brightness_up]
          b2_hold: []                            # removed: cooler orphan
          b2_2x: [zen32_full_brightness]
          b3_1x: [zen32_enter_volume_start]
          b3_hold: [zen32_enter_volume_favorites]
          b3_2x: [zen32_enter_volume_play_pause]
          b3_3x: [zen32_enter_volume_group_toggle]
          b4_1x: [zen32_brightness_down]
          b4_hold: []                            # removed: warmer orphan
          b4_2x: [zen32_minimum_brightness]
          b5_1x: [zen32_toggle_lights]
          b5_hold: [oal_reset_soft]
          b5_2x: [zen32_cycle_oal_config]
          b5_3x: [zen32_toggle_sleep_mode]

        # --------------------------------------------------------------------
        # WARMTH MODE - Color temperature control
        # --------------------------------------------------------------------
        warmth:
          b1_1x: [zen32_set_mode_brightness]
          b1_hold: [zen32_set_mode_brightness]
          b1_2x: [zen32_set_mode_warmth]         # no-op (already in warmth)
          b1_3x: [zen32_warm_cool_toggle]
          b2_1x: [oal_global_manual_warmer]
          b2_hold: []
          b2_2x: [zen32_warmth_max]              # +1000K preset
          b3_1x: [zen32_enter_volume_start]
          b3_hold: [zen32_enter_volume_favorites]
          b3_2x: [zen32_enter_volume_play_pause]
          b3_3x: [zen32_enter_volume_group_toggle]
          b4_1x: [oal_global_manual_cooler]
          b4_hold: []
          b4_2x: [zen32_warmth_min]              # -1000K preset
          b5_1x: [zen32_toggle_lights]
          b5_hold: [oal_reset_soft]
          b5_2x: [zen32_cycle_oal_config]
          b5_3x: [zen32_toggle_sleep_mode]

        # --------------------------------------------------------------------
        # VOLUME MODE - Sonos music control
        # --------------------------------------------------------------------
        volume:
          b1_1x: [zen32_set_mode_brightness]
          b1_hold: [zen32_set_mode_brightness]
          b1_2x: [zen32_set_mode_warmth]
          b1_3x: [zen32_warm_cool_toggle]
          b2_1x: [zen32_sonos_volume_up]
          b2_hold: []
          b2_2x: [zen32_sonos_next_track]
          b3_1x: [zen32_start_if_idle]
          b3_hold: [zen32_cycle_sonos_favorite]
          b3_2x: [zen32_sonos_play_pause]
          b3_3x: [zen32_enter_volume_group_toggle]
          b4_1x: [zen32_sonos_volume_down]
          b4_hold: []
          b4_2x: [zen32_sonos_prev_track]
          b5_1x: [zen32_toggle_lights]
          b5_hold: [oal_reset_soft]
          b5_2x: [zen32_cycle_oal_config]
          b5_3x: [zen32_toggle_sleep_mode]

      # =======================================================================
      # DISPATCHER LOOKUP - Simple and direct
      # =======================================================================
      actions: "{{ mode_actions.get(mode, {}).get(gesture_key, []) }}"

    condition:
      # Only process valid event types
      - condition: template
        value_template: "{{ event_type in ['KeyPressed', 'KeyHeldDown', 'KeyPressed2x', 'KeyPressed3x'] }}"
      # Debounce: ignore events within 50ms of last press
      - condition: template
        value_template: >
          {{ (now().timestamp() - (states('input_datetime.zen32_last_button_press')
             | as_timestamp(0))) > 0.05 }}

    action:
      # Update activity timestamps
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_last_button_press
        data:
          datetime: "{{ now() }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_mode_last_change
        data:
          datetime: "{{ now() }}"

      # =======================================================================
      # CENTRALIZED DISPATCHER - Execute actions from action_map
      # =======================================================================
      # Guard: Has actions defined for this (button, gesture, mode) combination
      - condition: template
        value_template: "{{ actions | length > 0 }}"

      # Execute each action in sequence
      - repeat:
          for_each: "{{ actions }}"
          sequence:
            - action: script.turn_on
              target:
                entity_id: "script.{{ repeat.item }}"

  # ---------------------------------------------------------------------------
  # Manual Test Trigger - For debugging via events
  # ---------------------------------------------------------------------------
  - id: zen32_led_sequencer_manual_test_v4
    alias: "ZEN32 - LED Sequencer Manual Test"
    description: "Trigger LED sequencer via event for debugging"
    mode: single
    trigger:
      - platform: event
        event_type: zen32_led_test
    action:
      - service: script.zen32_led_sequencer
        data:
          buttons: "{{ trigger.event.data.buttons | default([]) }}"
      - service: system_log.write
        data:
          message: "zen32_led_sequencer_manual_test: Executed via event"
          level: info
# =============================================================================
# SCRIPTS - Brightness Control
# =============================================================================
