# =============================================================================
# OPTIMIZED ADAPTIVE LIGHTING SYSTEM (OAL v13 - Production)
# Architecture: Hybrid Adaptation Model + Zone-Aware Manual Control
# Compatible with HA 2025.x + Adaptive Lighting
# =============================================================================

# =============================================================================
# LAYER 1: INFRASTRUCTURE (GROUPED LIGHTS)
# =============================================================================

light:
  - platform: group
    name: "main_living_lights"
    unique_id: "oal_main_living_lights_group_v13"
    entities:
      - light.living_room_couch_lamp
      - light.living_room_floor_lamp
      - light.entryway_lamp
      - light.living_room_credenza_light
      - light.living_room_corner_accent
      - light.office_desk_lamp
  - platform: group
    name: "kitchen_island_lights"
    unique_id: "oal_kitchen_island_lights_group_v13"
    entities:
      - light.kitchen_island_pendants
  - platform: group
    name: "bedroom_primary_lights"
    unique_id: "oal_bedroom_primary_lights_group_v13"
    entities:
      - light.master_bedroom_table_lamps
      - light.master_bedroom_corner_accent
  - platform: group
    name: "accent_spots_lights"
    unique_id: "oal_accent_spots_lights_group_v13"
    entities:
      - light.dining_room_spot_lights
      - light.living_room_spot_lights
  - platform: group
    name: "recessed_ceiling_lights"
    unique_id: "oal_recessed_ceiling_lights_group_v13"
    entities:
      - light.kitchen_main_lights
      - light.living_room_hallway_lights
  - platform: group
    name: "all_adaptive_lights"
    unique_id: "oal_all_adaptive_lights_group_v13"
    entities:
      - light.entryway_lamp
      - light.living_room_floor_lamp
      - light.office_desk_lamp
      - light.living_room_corner_accent
      - light.living_room_couch_lamp
      - light.living_room_credenza_light
      - light.kitchen_island_pendants
      - light.master_bedroom_table_lamps
      - light.master_bedroom_corner_accent
      - light.dining_room_spot_lights
      - light.living_room_spot_lights
      - light.kitchen_main_lights
      - light.living_room_hallway_lights
      - light.living_col_accent
      - light.dining_col_accent
  - platform: group
    name: Living Room Lights
    unique_id: living_room_lights_group
    entities:
      - light.living_room_couch_lamp
      - light.living_room_floor_lamp
      - light.living_room_credenza_light
      - light.living_room_corner_accent
      - light.entryway_lamp
      - light.living_room_spot_lights
      - light.dining_room_spot_lights
      - light.living_room_hallway_lights
      - light.column_lights
  - platform: group
    name: "All Kitchen Lights"
    unique_id: all_kitchen_lights
    entities:
      - light.kitchen_island_pendants
      - light.kitchen_main_lights
  - platform: group
    name: "All Living Room Lights"
    unique_id: all_living_room_lights
    entities:
      - light.living_room_couch_lamp
      - light.living_room_floor_lamp
      - light.living_room_credenza_light
      - light.living_room_corner_accent
      - light.entryway_lamp
      - light.living_room_spot_lights
      - light.dining_room_spot_lights
      - light.living_room_hallway_lights
      - light.column_lights
  - platform: group
    name: "All Dining Room Lights"
    unique_id: all_dining_room_lights
    entities:
      - light.living_room_credenza_light
      - light.dining_room_spot_lights
      - light.dining_col_accent
      - light.living_room_corner_accent
  - platform: group
    name: "Hue Lamps Only"
    unique_id: hue_lamps_only_group
    entities:
      - light.entryway_lamp
      - light.living_room_floor_lamp
      - light.living_room_couch_lamp
      - light.living_room_corner_accent
      - light.living_room_credenza_light
  - platform: group
    name: "Overhead Lights"
    unique_id: overhead_lights_group
    entities:
      - light.kitchen_main_lights
      - light.living_room_hallway_lights
      - light.dining_room_spot_lights
      - light.living_room_spot_lights
  - platform: group
    name: "Column Lights"
    unique_id: column_lights
    entities:
      - light.living_col_accent
      - light.dining_col_accent
group:
  oal_control_switches:
    name: "OAL Control Switches"
    entities:
      - switch.adaptive_lighting_main_living
      - switch.adaptive_lighting_kitchen_island
      - switch.adaptive_lighting_bedroom_primary
      - switch.adaptive_lighting_accent_spots
      - switch.adaptive_lighting_recessed_ceiling
      - switch.adaptive_lighting_column_lights

# =============================================================================
# LAYER 2: INPUTS & STATE TRACKING
# =============================================================================

input_select:
  oal_active_configuration:
    name: "OAL Active Configuration"
    options:
      - "Adaptive"
      - "Full Bright"
      - "Dim Ambient"
      - "Warm Ambient"
      - "TV Mode"
      - "Sleep"
      - "Manual"
    initial: "Adaptive"
    icon: mdi:tune-variant

  oal_isolated_override_mode:
    name: "OAL Isolated Override Mode"
    options:
      - "Off"
      - "Work (Office Desk)"
    initial: "Off"
    icon: mdi:desk-lamp

input_number:
  # Global manual warmth offset (brightness slider removed - dead code)
  oal_offset_global_manual_warmth:
    name: "OAL Offset: Global K"
    min: -2500
    max: 2500
    step: 50
    initial: 0
    unit_of_measurement: "K"
    icon: mdi:thermometer-lines

  # Config / env / sunset offsets
  oal_offset_config_brightness:
    name: "OAL Offset: Config B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:brightness-auto

  oal_offset_config_warmth:
    name: "OAL Offset: Config K"
    min: -2500
    max: 2500
    step: 50
    initial: 0
    unit_of_measurement: "K"
    icon: mdi:thermometer

  oal_offset_environmental_brightness:
    name: "OAL Offset: Env B"
    min: 0
    max: 50
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:weather-cloudy

  oal_offset_environmental_warmth:
    name: "OAL Offset: Env K Comp"
    min: -1000
    max: 0
    step: 50
    initial: 0
    unit_of_measurement: "K"
    icon: mdi:thermometer-low

  oal_offset_sunset_brightness:
    name: "OAL Offset: Sunset B"
    min: -40
    max: 20
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:weather-sunset

  oal_offset_sunset_warmth:
    name: "OAL Offset: Sunset K"
    min: -1500
    max: 0
    step: 50
    initial: 0
    unit_of_measurement: "K"
    icon: mdi:weather-sunset-down

  # Control parameters
  oal_control_zonal_timeout_hours:
    name: "OAL Zonal Timeout (Hrs)"
    min: 0.5
    max: 12
    step: 0.5
    initial: 4
    icon: mdi:timer-outline

  oal_control_transition_speed:
    name: "OAL Transition Speed (Sec)"
    min: 1
    max: 10
    step: 1
    initial: 2
    icon: mdi:speedometer

  # Per-zone manual offsets (single source of truth for manual brightness)
  oal_manual_offset_main_living_brightness:
    name: "OAL Manual Offset - Main Living B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:sofa

  oal_manual_offset_kitchen_island_brightness:
    name: "OAL Manual Offset - Kitchen Island B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:silverware-fork-knife

  oal_manual_offset_bedroom_primary_brightness:
    name: "OAL Manual Offset - Bedroom Primary B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:bed

  oal_manual_offset_accent_spots_brightness:
    name: "OAL Manual Offset - Accent Spots B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:spotlight-beam

  oal_manual_offset_recessed_ceiling_brightness:
    name: "OAL Manual Offset - Recessed Ceiling B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:ceiling-light

  oal_manual_offset_column_lights_brightness:
    name: "OAL Manual Offset - Column Lights B"
    min: -100
    max: 100
    step: 1
    initial: 0
    unit_of_measurement: "%"
    icon: mdi:pillar

input_boolean:
  oal_system_paused:
    name: "OAL System Paused"
    initial: false
    icon: mdi:pause-circle

  oal_environmental_boost_enabled:
    name: "OAL Env Boost Enabled"
    initial: true
    icon: mdi:weather-partly-cloudy

  oal_config_transition_active:
    name: "OAL Config Transition Active"
    icon: mdi:swap-horizontal
    initial: false

  oal_config_power_handoff_active:
    name: "OAL Config Power Handoff Active"
    initial: false
    icon: mdi:transit-connection-variant

  oal_disable_next_sonos_wakeup:
    name: "OAL Disable Next Sonos Wakeup"
    initial: false
    icon: mdi:alarm-off

  oal_movie_mode_active:
    name: "OAL Movie Mode Active"
    initial: false
    icon: mdi:movie-open

  oal_autoreset_sync_lock:
    name: "OAL Autoreset Sync Lock"
    initial: false
    icon: mdi:lock-clock

  oal_force_sleep:
    name: "OAL Force Sleep Mode"
    initial: false
    icon: mdi:power-sleep

  # Room Card Show/Hide Toggles
  living_room_expanded:
    name: "Living Room Card Expanded"
    initial: true
    icon: mdi:eye

  oal_disable_sleep_mode:
    name: "OAL Disable Sleep Mode"
    initial: true
    icon: mdi:sleep-off

input_datetime:
  zen32_last_button_press:
    has_date: true
    has_time: true
    icon: mdi:gesture-tap-button

  oal_last_engine_run:
    has_date: true
    has_time: true
    icon: mdi:engine

  oal_late_night_start:
    name: "OAL Late Night Start"
    has_date: false
    has_time: true
    initial: "22:00:00"
    icon: mdi:weather-night

# =============================================================================
# LAYER 3: ADAPTIVE LIGHTING ZONES (BASELINE CURVES)
# =============================================================================

adaptive_lighting:
  - name: "main_living"
    lights: light.main_living_lights
    interval: 15
    transition: 1
    initial_transition: 3
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 45
    max_brightness: 100
    min_color_temp: 2250
    max_color_temp: 2950
    sleep_brightness: 25
    sleep_color_temp: 1800

  - name: "kitchen_island"
    lights: light.kitchen_island_lights
    interval: 15
    transition: 1
    initial_transition: 3
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 25
    max_brightness: 100
    min_color_temp: 2000
    max_color_temp: 4000
    sleep_brightness: 5
    sleep_color_temp: 2000

  - name: "bedroom_primary"
    lights: light.bedroom_primary_lights
    interval: 15
    transition: 1
    initial_transition: 3
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 20
    max_brightness: 40
    min_color_temp: 1800
    max_color_temp: 2250
    sleep_brightness: 5
    sleep_color_temp: 1800

  - name: "accent_spots"
    lights: light.accent_spots_lights
    interval: 15
    transition: 1
    initial_transition: 3
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 20
    max_brightness: 50
    min_color_temp: 2000
    max_color_temp: 6500
    sleep_brightness: 1
    sleep_color_temp: 2000

  - name: "recessed_ceiling"
    lights: light.recessed_ceiling_lights
    interval: 15
    transition: 1
    initial_transition: 3
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 2
    max_brightness: 23
    min_color_temp: 2700
    max_color_temp: 2700
    sleep_brightness: 1
    sleep_color_temp: 2700

  - name: "column_lights"
    lights: light.column_lights
    interval: 15
    transition: 1
    initial_transition: 1
    take_over_control: true
    detect_non_ha_changes: true
    adapt_delay: 1
    include_config_in_attributes: true
    autoreset_control_seconds: 14400
    min_brightness: 1
    max_brightness: 80
    brightness_mode: tanh
    min_color_temp: 2000
    max_color_temp: 3000
    brightness_mode_time_light: 1800
    brightness_mode_time_dark: 900
    sunset_offset: -1800
    separate_turn_on_commands: true
    prefer_rgb_color: true
    sleep_brightness: 1
    sleep_rgb_or_color_temp: "rgb_color"
    sleep_rgb_color: [255, 165, 0]
    sleep_transition: 1
    transition_until_sleep: true
    send_split_delay: true
    skip_redundant_commands: true
    intercept: true
    multi_light_intercept: true


# =============================================================================
# LAYER 4: CORE ENGINE + GLOBAL LOGIC (AUTOMATIONS)
# =============================================================================

automation:
  # ---------------------------------------------------------------------------
  # 4.1 Core Adjustment Engine (brightness model + warmth model)
  # ---------------------------------------------------------------------------
  - id: oal_core_adjustment_engine_v13
    alias: "OAL v13 - Core Adjustment Engine (Master)"
    mode: parallel
    trigger:
      - platform: state
        entity_id:
          - input_number.oal_offset_global_manual_warmth
          - input_number.oal_offset_config_brightness
          - input_number.oal_offset_config_warmth
          - input_number.oal_offset_environmental_brightness
          - input_number.oal_offset_environmental_warmth
          - input_number.oal_offset_sunset_brightness
          - input_number.oal_offset_sunset_warmth
          - input_number.oal_manual_offset_main_living_brightness
          - input_number.oal_manual_offset_kitchen_island_brightness
          - input_number.oal_manual_offset_bedroom_primary_brightness
          - input_number.oal_manual_offset_accent_spots_brightness
          - input_number.oal_manual_offset_recessed_ceiling_brightness
          - input_number.oal_manual_offset_column_lights_brightness
        for: "00:00:01"
      - platform: time_pattern
        minutes: "/15"
      - platform: event
        event_type: oal_watchdog_trigger

    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
      - condition: state
        entity_id: input_boolean.oal_config_transition_active
        state: "off"

    variables:
      # Global offsets
      comp_manual_k: "{{ states('input_number.oal_offset_global_manual_warmth') | float(0) }}"
      comp_config_b: "{{ states('input_number.oal_offset_config_brightness') | float(0) }}"
      comp_config_k: "{{ states('input_number.oal_offset_config_warmth') | float(0) }}"
      comp_env_b_raw: "{{ states('input_number.oal_offset_environmental_brightness') | float(0) }}"
      comp_env_k: "{{ states('input_number.oal_offset_environmental_warmth') | float(0) }}"
      comp_sunset_b: "{{ states('input_number.oal_offset_sunset_brightness') | float(0) }}"
      comp_sunset_k: "{{ states('input_number.oal_offset_sunset_warmth') | float(0) }}"

      # Sunset amplifies environmental boost (multiplicative, not additive)
      # At peak sunset (8), env boost is amplified by 50%
      sunset_amplifier: >
        {{ 1 + (comp_sunset_b / 8) * 0.5 if comp_sunset_b > 0 else 1.0 }}

      # Environmental boost with sunset amplification, capped at 30%
      env_with_sunset_capped: >
        {{ [30, (comp_env_b_raw * sunset_amplifier)] | min }}

      # Config offset alone (sunset no longer added here)
      base_config_b: >
        {{ comp_config_b }}

      base_warmth_offset: >
        {{ comp_manual_k + comp_config_k + comp_sunset_k + comp_env_k }}

      transition_speed: "{{ states('input_number.oal_control_transition_speed') | int(2) }}"

      zone_configs:
        - entity_id: switch.adaptive_lighting_main_living
          id: main_living
          comfort_min_b: 45
          comfort_max_b: 100
          min_k: 2250
          max_k: 2950
          env_sensitivity: 1.0
          hard_min_b: 1
          hard_max_b: 100

        - entity_id: switch.adaptive_lighting_kitchen_island
          id: kitchen_island
          comfort_min_b: 30
          comfort_max_b: 100
          min_k: 2000
          max_k: 4000
          env_sensitivity: 1.0
          hard_min_b: 1
          hard_max_b: 100

        - entity_id: switch.adaptive_lighting_bedroom_primary
          id: bedroom_primary
          comfort_min_b: 20
          comfort_max_b: 40
          min_k: 1800
          max_k: 2250
          env_sensitivity: 0.5
          hard_min_b: 1
          hard_max_b: 80

        - entity_id: switch.adaptive_lighting_accent_spots
          id: accent_spots
          comfort_min_b: 20
          comfort_max_b: 50
          min_k: 2000
          max_k: 6500
          env_sensitivity: 0.8
          hard_min_b: 1
          hard_max_b: 80

        - entity_id: switch.adaptive_lighting_recessed_ceiling
          id: recessed_ceiling
          comfort_min_b: 2
          comfort_max_b: 23
          min_k: 2700
          max_k: 2700
          env_sensitivity: 0.6
          hard_min_b: 1
          hard_max_b: 40

        - entity_id: switch.adaptive_lighting_column_lights
          id: column_lights
          comfort_min_b: 1
          comfort_max_b: 80
          min_k: 2000
          max_k: 3500
          env_sensitivity: 0.7
          hard_min_b: 1
          hard_max_b: 100

    action:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.oal_last_engine_run
        data:
          datetime: "{{ now() }}"

      # NEW: Check force sleep mode - override everything if enabled
      - if: "{{ is_state('input_boolean.oal_force_sleep', 'on') }}"
        then:
          # Force all zones to sleep mode immediately
          - repeat:
              for_each: "{{ zone_configs }}"
              sequence:
                - service: adaptive_lighting.change_switch_settings
                  continue_on_error: true
                  target:
                    entity_id: "{{ repeat.item.entity_id }}"
                  data:
                    min_brightness: 1
                    max_brightness: 5
                    min_color_temp: 1800
                    max_color_temp: 1800
                    transition: 5
          - service: adaptive_lighting.apply
            continue_on_error: true
            target:
              entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
            data:
              turn_on_lights: false
              transition: 5
          - stop: "Force sleep mode active"

      - repeat:
          for_each: "{{ zone_configs }}"
          sequence:
            - variables:
                comfort_min_b: "{{ repeat.item.comfort_min_b | float }}"
                comfort_max_b: "{{ repeat.item.comfort_max_b | float }}"
                env_sensitivity: "{{ repeat.item.env_sensitivity | float }}"
                hard_min_b: "{{ repeat.item.hard_min_b | float }}"
                hard_max_b: "{{ repeat.item.hard_max_b | float }}"

                # Baseline brightness from AL (for diagnostics only)
                base_brightness_zone: >
                  {{ state_attr(repeat.item.entity_id, 'brightness_pct')
                     | float((comfort_min_b + comfort_max_b) / 2) }}

                # Auto brightness: config + (env*sunset_multiplier capped at 30%)
                auto_offset_b: >
                  {{ base_config_b + (env_with_sunset_capped * env_sensitivity) }}

                auto_min_raw: "{{ comfort_min_b + auto_offset_b }}"
                auto_max_raw: "{{ comfort_max_b + auto_offset_b }}"

                auto_min_clamped: >
                  {{ [comfort_min_b, [comfort_max_b, auto_min_raw] | min] | max }}
                auto_max_clamped: >
                  {{ [comfort_min_b, [comfort_max_b, auto_max_raw] | min] | max }}

                # Per-zone manual helper (single manual brightness source)
                per_zone_manual_helper: >
                  {% if repeat.item.id == 'main_living' %}
                    {{ states('input_number.oal_manual_offset_main_living_brightness') | float(0) }}
                  {% elif repeat.item.id == 'kitchen_island' %}
                    {{ states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) }}
                  {% elif repeat.item.id == 'bedroom_primary' %}
                    {{ states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) }}
                  {% elif repeat.item.id == 'accent_spots' %}
                    {{ states('input_number.oal_manual_offset_accent_spots_brightness') | float(0) }}
                  {% elif repeat.item.id == 'recessed_ceiling' %}
                    {{ states('input_number.oal_manual_offset_recessed_ceiling_brightness') | float(0) }}
                  {% elif repeat.item.id == 'column_lights' %}
                    {{ states('input_number.oal_manual_offset_column_lights_brightness') | float(0) }}
                  {% else %}
                    0
                  {% endif %}

                manual_offset_b: "{{ per_zone_manual_helper }}"

                min_with_manual: "{{ auto_min_clamped + manual_offset_b }}"
                max_with_manual: "{{ auto_max_clamped + manual_offset_b }}"

                global_min_b: "{{ [1, [100, min_with_manual] | min] | max }}"
                global_max_b: "{{ [1, [100, max_with_manual] | min] | max }}"

                clamped_min_b: "{{ [hard_min_b, [hard_max_b, global_min_b] | min] | max }}"
                clamped_max_b: "{{ [hard_min_b, [hard_max_b, global_max_b] | min] | max }}"

                final_min_b: "{{ clamped_min_b }}"
                final_max_b: "{{ [clamped_min_b, clamped_max_b] | max }}"

                # Warmth behavior (global offset within zone band)
                final_min_k: >
                  {% if repeat.item.id != 'recessed_ceiling' %}
                    {% set proposed_min_k = repeat.item.min_k + base_warmth_offset %}
                    {{ [1800, [6500, proposed_min_k] | min] | max }}
                  {% else %}
                    {{ repeat.item.min_k }}
                  {% endif %}

                final_max_k: >
                  {% if repeat.item.id != 'recessed_ceiling' %}
                    {% set proposed_max_k = repeat.item.max_k + base_warmth_offset %}
                    {% set clamped_k = [1800, [6500, proposed_max_k] | min] | max %}
                    {{ [final_min_k, clamped_k] | max }}
                  {% else %}
                    {{ repeat.item.max_k }}
                  {% endif %}

            - service: adaptive_lighting.change_switch_settings
              target:
                entity_id: "{{ repeat.item.entity_id }}"
              data:
                min_brightness: "{{ final_min_b | round(0) }}"
                max_brightness: "{{ final_max_b | round(0) }}"
                min_color_temp: "{{ final_min_k | round(0) }}"
                max_color_temp: "{{ final_max_k | round(0) }}"
                transition: "{{ transition_speed }}"

      # Apply to each switch, excluding only the specific lights in manual_control
      - repeat:
          for_each: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
          sequence:
            - variables:
                switch_id: "{{ repeat.item }}"
                manual_lights: "{{ state_attr(switch_id, 'manual_control') | default([]) }}"
                all_lights: "{{ state_attr(switch_id, 'lights') | default([]) }}"
                adaptive_lights: "{{ all_lights | reject('in', manual_lights) | list }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ adaptive_lights | length > 0 }}"
                  sequence:
                    - service: adaptive_lighting.apply
                      target:
                        entity_id: "{{ switch_id }}"
                      data:
                        lights: "{{ adaptive_lights }}"
                        turn_on_lights: false
                        transition: "{{ transition_speed }}"

      - event: oal_engine_calculation_complete
        event_data:
          timestamp: "{{ now().isoformat() }}"
          trigger_source: >
            {{ trigger.platform ~ ':' ~ (trigger.entity_id | default('n/a')) }}
          final_brightness_offset_total: >
            {{ base_config_b + env_with_sunset_capped }}
          final_warmth_offset_total: "{{ base_warmth_offset }}"
          comp_b_manual_slider: 0  # Dead code removed (Phase 2A)
          comp_b_config: "{{ comp_config_b }}"
          comp_b_env_raw: "{{ comp_env_b_raw }}"
          comp_b_env_with_sunset: "{{ env_with_sunset_capped }}"
          comp_b_sunset: "{{ comp_sunset_b }}"
          sunset_amplifier: "{{ sunset_amplifier }}"
          comp_k_manual: "{{ comp_manual_k }}"
          comp_k_config: "{{ comp_config_k }}"
          comp_k_env: "{{ comp_env_k }}"
          comp_k_sunset: "{{ comp_sunset_k }}"

  # ---------------------------------------------------------------------------
  # 4.2 Configuration Manager (presets + power handoff)
  # ---------------------------------------------------------------------------
  - id: oal_configuration_manager_v13
    alias: "OAL v13 - Configuration Manager (Transition-Locked)"
    mode: restart
    trigger:
      - platform: state
        entity_id: input_select.oal_active_configuration
    
    variables:
      config: "{{ states('input_select.oal_active_configuration') }}"
      transition_speed: "{{ states('input_number.oal_control_transition_speed') | int(2) }}"
      
      config_profiles:
        # Adaptive: True baseline - AL works normally, no interference
        "Adaptive":
          b: 0
          k: 0
          lights_off: []
          lights_dimmed: {}
          is_baseline: true
          is_force_on: false
        
        # Full Brightness: Turn on ALL lights with AL's calculated values
        "Full Bright":
          b: 0
          k: 0
          lights_off: []
          lights_dimmed: {}
          is_baseline: false
          is_force_on: true
        
        "Dim Ambient":
          b: -30
          k: -500
          lights_off: []
          lights_dimmed:
            light.main_living_lights: 40      # Soft ambient
            light.kitchen_island_pendants: 30 # Lower than normal
            light.column_lights: 30           # Accent glow
            light.accent_spots_lights: 20     # Subtle spots
            light.recessed_ceiling_lights: 1  # Minimal glow
          is_baseline: false
          is_force_on: false
        
        "Warm Ambient":
          b: -50
          k: -1000
          lights_off:
            - light.recessed_ceiling_lights
            - light.kitchen_main_lights
          lights_dimmed:
            light.accent_spots_lights: 10 # Dim spots
            light.kitchen_island_lights: 5 # Low glow on pendants
          is_baseline: false
          is_force_on: false
        
        "TV Mode":
          b: -60 # Global dim
          k: -1500 # Very warm
          lights_off:
            - light.column_lights            # Off - near TV glare
            - light.living_room_floor_lamp   # Off - direct line of sight
            - light.recessed_ceiling_lights  # Off - harsh overhead
          lights_dimmed:
            light.living_room_couch_lamp: 5   # Barely visible
            light.kitchen_island_pendants: 15 # Background glow
            light.accent_spots_lights: 5      # Subtle ambient
            light.entryway_lamp: 8            # Navigation/safety
            light.living_room_credenza_light: 3  # Bias lighting
          is_baseline: false
          is_force_on: false

        "Sleep":
          b: 0
          k: 0
          lights_off: []
          lights_dimmed: {}
          is_baseline: false
          is_force_on: false
          is_sleep: true

        "Manual":
          b: 0
          k: 0
          lights_off: []
          lights_dimmed: {}
          is_baseline: false
          is_force_on: false
      
      target_profile: "{{ config_profiles.get(config, {}) }}"
      is_baseline: "{{ target_profile.get('is_baseline', false) }}"
      is_force_on: "{{ target_profile.get('is_force_on', false) }}"
      is_sleep: "{{ target_profile.get('is_sleep', false) }}"

      # FIX 2: Calculate expanded switches once for efficiency
      all_switches_expanded: >
        {{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}
      
      all_adaptive_lights_expanded: >
        {{ expand('light.all_adaptive_lights') | map(attribute='entity_id') | list }}
      
      # Expand light groups to individual entities for manual control
      new_controlled_lights: >
        {% set lights_off = target_profile.get('lights_off', []) %}
        {% set lights_dimmed = target_profile.get('lights_dimmed', {}).keys() | list %}
        {% set combined = (lights_off + lights_dimmed) | unique | list %}
        {{ expand(combined) | map(attribute='entity_id') | list }}

    action:
      # =========================================================================
      # LOCK: Block Core Engine during transition
      # =========================================================================
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.oal_config_transition_active

      # =========================================================================
      # SLEEP MODE: Toggle force_sleep based on Sleep Mode selection
      # =========================================================================
      - if: "{{ is_sleep }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.oal_force_sleep
        else:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.oal_force_sleep

      # =========================================================================
      # ROUTE: Choose execution path based on target config
      # =========================================================================
      - choose:
          # =====================================================================
          # BASELINE PATH: Adaptive - just let AL work normally, no forced turn on
          # =====================================================================
          - conditions:
              - condition: template
                value_template: "{{ is_baseline }}"
            sequence:
              # 1. Release ALL manual controls system-wide
              - repeat:
                  for_each: "{{ all_switches_expanded }}"
                  sequence:
                    - service: adaptive_lighting.set_manual_control
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        manual_control: false
              
              # 2. Clear handoff flag (no overrides in adaptive baseline)
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_config_power_handoff_active
              
              # 3. Set baseline offsets (0, 0)
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_offset_config_brightness
                data:
                  value: 0
              
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_offset_config_warmth
                data:
                  value: 0
              
              # 4. Unlock engine - Core Engine will manage lights naturally
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_config_transition_active
              
              # EXIT: Baseline path complete - AL now works normally
          
          # =====================================================================
          # FORCE ON PATH: Full Brightness - turn on ALL lights with AL values
          # =====================================================================
          - conditions:
              - condition: template
                value_template: "{{ is_force_on }}"
            sequence:
              # 1. Release ALL manual controls system-wide
              - repeat:
                  for_each: "{{ all_switches_expanded }}"
                  sequence:
                    - service: adaptive_lighting.set_manual_control
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        manual_control: false
              
              # 2. Turn on ALL lights with AL's calculated settings
              - repeat:
                  for_each: "{{ all_switches_expanded }}"
                  sequence:
                    - service: adaptive_lighting.apply
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        turn_on_lights: true
                        transition: "{{ transition_speed }}"
              
              # 3. Clear handoff flag (no overrides in force-on)
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_config_power_handoff_active
              
              # 4. Set baseline offsets (0, 0)
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_offset_config_brightness
                data:
                  value: 0
              
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_offset_config_warmth
                data:
                  value: 0
              
              # 5. Unlock engine
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_config_transition_active
              
              # EXIT: Force-on path complete

        # =======================================================================
        # OVERRIDE PATH: Handle dimmed/ambient/TV configs
        # Simplified: Clear ALL manual controls first, then apply new config's overrides
        # EXCEPT: "Manual" config preserves manual_control (set by brighter/dimmer scripts)
        # =======================================================================
        default:
          # GLOBAL MANUAL SHORTCUT: Skip clearing manual controls, just trigger update
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ config == 'Manual' }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.oal_config_transition_active
                  - event: oal_watchdog_trigger
                    event_data:
                      message: "Global Manual mode - triggering immediate update (preserving manual_control)"
            # For all other configs, clear manual controls first
            default:
              # PHASE 1: Clear ALL manual controls on all switches (clean slate)
              - repeat:
                  for_each: "{{ all_switches_expanded }}"
                  sequence:
                    - service: adaptive_lighting.set_manual_control
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        manual_control: false
              
              # Clear handoff flag
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_config_power_handoff_active

          # SLEEP MODE SHORTCUT: Unlock and trigger Core Engine (it handles sleep)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_sleep }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: input_boolean.oal_config_transition_active
                  - event: oal_watchdog_trigger
                    event_data:
                      message: "Sleep Mode activated - Core Engine will apply sleep settings"

          # PHASE 2: Apply new config offset settings (skip for Global Manual and Sleep Mode)
          - condition: template
            value_template: "{{ config != 'Manual' and not is_sleep }}"
          
          - service: input_number.set_value
            target:
              entity_id: input_number.oal_offset_config_brightness
            data:
              value: "{{ target_profile.b }}"
          
          - service: input_number.set_value
            target:
              entity_id: input_number.oal_offset_config_warmth
            data:
              value: "{{ target_profile.k }}"
          
          # Brief pause for offset changes to settle
          - delay: "00:00:01"
          
          # PHASE 3: Apply power handoff overrides (if any)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ new_controlled_lights | length > 0 }}"
                sequence:
                  # 3A. Set manual control on lights being overridden (per-switch)
                  - repeat:
                      for_each: "{{ all_switches_expanded }}"
                      sequence:
                        - variables:
                            switch_id: "{{ repeat.item }}"
                            switch_lights: "{{ state_attr(switch_id, 'lights') | default([]) }}"
                            lights_for_this_switch: "{{ switch_lights | select('in', new_controlled_lights) | list }}"
                        - if:
                            - condition: template
                              value_template: "{{ lights_for_this_switch | length > 0 }}"
                          then:
                            - service: adaptive_lighting.set_manual_control
                              target:
                                entity_id: "{{ switch_id }}"
                              data:
                                lights: "{{ lights_for_this_switch }}"
                                manual_control: true
                  
                  # 3B. Apply dimmed lights
                  - repeat:
                      for_each: "{{ target_profile.get('lights_dimmed', {}) | dictsort }}"
                      sequence:
                        - service: light.turn_on
                          continue_on_error: true
                          target:
                            entity_id: "{{ repeat.item[0] }}"
                          data:
                            brightness_pct: "{{ repeat.item[1] }}"
                            transition: "{{ transition_speed }}"
                  
                  # 3C. Turn off specified lights
                  - if: "{{ target_profile.get('lights_off', []) | length > 0 }}"
                    then:
                      - service: light.turn_off
                        continue_on_error: true
                        target:
                          entity_id: "{{ target_profile.get('lights_off', []) }}"
                        data:
                          transition: "{{ transition_speed }}"
                  
                  # 3D. Mark handoff as active
                  - service: input_boolean.turn_on
                    target:
                      entity_id: input_boolean.oal_config_power_handoff_active
          
          # UNLOCK: Release Core Engine
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.oal_config_transition_active
          
          # TRIGGER: Force engine to recalculate with new offsets
          - event: oal_watchdog_trigger
            event_data:
              message: "Override config applied - recalculating zones"
  # ---------------------------------------------------------------------------
  # 4.3 Sunset Gaussian offsets (brightness + warmth)
  # ---------------------------------------------------------------------------
  - id: oal_sunset_logic_unified_v13
    alias: "OAL v13 - Seamless Sunset Logic (Unified Gaussian Curve)"
    trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/1"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
    variables:
      elevation: "{{ state_attr('sun.sun', 'elevation') | float(90) }}"
      e: 2.71828
      brightness_offset: >
        {% if 8 >= elevation >= -8 %}
          {% set gauss = e ** ( - (elevation ** 2) / (2 * (4 ** 2)) ) %}
          {{ (gauss * 8) | round(0) }}
        {% else %}
          0
        {% endif %}
      warmth_offset: >
        {% if 5 >= elevation >= -5 %}
          {% set gauss = e ** ( - (elevation ** 2) / (2 * (2.5 ** 2)) ) %}
          {{ (gauss * -1500) | round(0) }}
        {% else %}
          0
        {% endif %}
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_sunset_brightness
        data:
          value: "{{ brightness_offset }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_sunset_warmth
        data:
          value: "{{ warmth_offset }}"

  # ---------------------------------------------------------------------------
  # 4.4 Environmental adaptation (lux + weather + season)
  # ---------------------------------------------------------------------------
  - id: oal_environmental_manager_v13
    alias: "OAL v13 - Environmental Adaptation Manager (Maximized)"
    trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: sensor.living_room_illuminance
      - platform: state
        entity_id: weather.home
      - platform: state
        entity_id: input_boolean.oal_environmental_boost_enabled
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
      - condition: template
        value_template: >
          {{ states('sensor.living_room_illuminance') not in ['unknown', 'unavailable']
             and states('weather.home') not in ['unknown', 'unavailable'] }}
    variables:
      current_boost: "{{ states('input_number.oal_offset_environmental_brightness') | float(0) }}"
      current_warmth: "{{ states('input_number.oal_offset_environmental_warmth') | float(0) }}"
      calculated_boost: >
        {% if is_state('input_boolean.oal_environmental_boost_enabled', 'off') %}
          0
        {% else %}
          {% set lux = states('sensor.living_room_illuminance') | float(500) %}
          {% set weather = states('weather.home') %}
          {% set season = 'winter' if now().month in [11, 12, 1, 2, 3] else 'summer' %}

          {# Lux-based boost (primary factor - 100% weight) #}
          {% set lux_boost = 0 %}
          {% if lux < 10 %}
            {% set lux_boost = 18 %}
          {% elif lux < 50 %}
            {% set lux_boost = 10 %}
          {% elif lux < 150 %}
            {% set lux_boost = 5 %}
          {% elif lux < 300 %}
            {% set lux_boost = 2 %}
          {% endif %}

          {# Weather boost lookup (40% weight - psychological factor) #}
          {% set weather_lookup = {
            'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
            'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
            'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
          } %}
          {% set weather_boost = weather_lookup.get(weather, 0) %}

          {# Season boost (25% weight - timing context) #}
          {% set season_boost = 8 if season == 'winter' else 0 %}

          {# WEIGHTED combination to prevent compounding #}
          {% set base_boost = lux_boost + (weather_boost * 0.4) + (season_boost * 0.25) %}

          {# Time-based modifiers #}
          {% set hour = now().hour %}
          {% if 22 <= hour or hour <= 6 or lux > 2500 %}
            {% set base_boost = 0 %}
          {% elif 6 < hour <= 8 or 18 <= hour < 22 %}
            {% set base_boost = base_boost * 0.7 %}
          {% endif %}
          {{ [50, base_boost] | min | round(0) }}
        {% endif %}
      final_boost: >
        {% if (calculated_boost - current_boost) | abs > 4 %}
          {{ calculated_boost }}
        {% else %}
          {{ current_boost }}
        {% endif %}
      calculated_warmth: >
        {% if final_boost >= 15 %}
          {% set scale = (final_boost - 15) / 35 %}
          {{ (-200 + (scale * -800)) | round(0) }}
        {% else %}
          0
        {% endif %}
      final_warmth: >
        {% if (calculated_warmth - current_warmth) | abs > 100 %}
          {{ calculated_warmth }}
        {% else %}
          {{ current_warmth }}
        {% endif %}
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_environmental_brightness
        data:
          value: "{{ final_boost }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_environmental_warmth
        data:
          value: "{{ final_warmth }}"

  # ---------------------------------------------------------------------------
  # 4.5 Isolated override (work mode on office desk lamp)
  # ---------------------------------------------------------------------------
  - id: oal_isolated_override_manager_v13
    alias: "OAL v13 - Isolated Override Manager"
    trigger:
      - platform: state
        entity_id: input_select.oal_isolated_override_mode
    variables:
      mode: "{{ states('input_select.oal_isolated_override_mode') }}"
      transition_speed: "{{ states('input_number.oal_control_transition_speed') | int(2) }}"
    action:
      - condition: template
        value_template: >
          {{ trigger.from_state is not none and trigger.from_state.state == 'Work (Office Desk)' }}
      - service: adaptive_lighting.set_manual_control
        data:
          entity_id: switch.adaptive_lighting_main_living
          lights: light.office_desk_lamp
          manual_control: false
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_main_living
          lights: light.office_desk_lamp
          transition: "{{ transition_speed }}"
      - condition: template
        value_template: "{{ mode == 'Work (Office Desk)' }}"
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_main_living
          lights: light.office_desk_lamp
          brightness_pct: 100
          color_temp_kelvin: 4000
          transition: "{{ transition_speed }}"
          turn_on_lights: true
          set_manual_control: true

  # ---------------------------------------------------------------------------
  # 4.6 Zen32 controller integration (CARB/CART + resets)
  # ---------------------------------------------------------------------------
  - id: oal_zen32_controller_handler_v13
    alias: "OAL v13 - Zen32 Controller Handler"
    mode: single
    trigger:
      - platform: state
        entity_id: event.scene_controller_scene_001
        id: "button_1"
      - platform: state
        entity_id: event.scene_controller_scene_002
        id: "button_2"
      - platform: state
        entity_id: event.scene_controller_scene_003
        id: "button_3"
      - platform: state
        entity_id: event.scene_controller_scene_004
        id: "button_4"
      - platform: state
        entity_id: event.scene_controller_scene_005
        id: "button_5"
    variables:
      event_type: "{{ trigger.to_state.attributes.event_type | default('unknown') }}"
      button_id: "{{ trigger.id }}"
    condition:
      - condition: template
        value_template: "{{ event_type in ['KeyPressed', 'KeyHeldDown', 'KeyPressed2x'] }}"
      - condition: template
        value_template: >
          {{ (now().timestamp() - (states('input_datetime.zen32_last_button_press') | as_timestamp(0))) > 0.5 }}
    action:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zen32_last_button_press
        data:
          datetime: "{{ now() }}"
      - choose:
          # Button 1 – cycle configs (skip Manual)
          - conditions: "{{ button_id == 'button_1' and event_type == 'KeyPressed' }}"
            sequence:
              - repeat:
                  sequence:
                    - service: input_select.select_next
                      target:
                        entity_id: input_select.oal_active_configuration
                      data:
                        cycle: true
                  until: >
                    {{ states('input_select.oal_active_configuration') != 'Manual' }}

          # Button 2 – brighter (press) / cooler (hold)
          - conditions: "{{ button_id == 'button_2' and event_type == 'KeyPressed' }}"
            sequence:
              - service: script.oal_global_manual_brighter

          - conditions: "{{ button_id == 'button_2' and event_type == 'KeyHeldDown' }}"
            sequence:
              - service: script.oal_global_manual_cooler

          # Button 4 – dimmer (press) / warmer (hold)
          - conditions: "{{ button_id == 'button_4' and event_type == 'KeyPressed' }}"
            sequence:
              - service: script.oal_global_manual_dimmer

          - conditions: "{{ button_id == 'button_4' and event_type == 'KeyHeldDown' }}"
            sequence:
              - service: script.oal_global_manual_warmer

          # Button 3 – soft reset (press) / global reset (hold)
          - conditions: "{{ button_id == 'button_3' and event_type == 'KeyPressed' }}"
            sequence:
              - service: script.oal_reset_soft

          - conditions: "{{ button_id == 'button_3' and event_type == 'KeyHeldDown' }}"
            sequence:
              - service: script.oal_reset_global

          # Button 5 – toggle all adaptive lights
          - conditions: "{{ button_id == 'button_5' and event_type == 'KeyPressed' }}"
            sequence:
              - service: light.toggle
                target:
                  entity_id: light.all_adaptive_lights

  # ---------------------------------------------------------------------------
  # 4.8 Dynamic sunrise from Sonos alarms
  # ---------------------------------------------------------------------------
  - id: oal_dynamic_sunrise_manager_v13
    alias: "OAL v13 - Dynamic Sunrise Manager"
    trigger:
      - platform: state
        entity_id: sensor.sonos_upcoming_alarms
        attribute: earliest_alarm_timestamp
      - platform: time
        at: "03:05:00"
    condition:
      - condition: state
        entity_id: input_boolean.oal_disable_next_sonos_wakeup
        state: "off"
    variables:
      al_switches: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
      alarm_timestamp: "{{ state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_timestamp') | int(0) }}"
    action:
      # Only proceed if there's a valid alarm
      - condition: template
        value_template: "{{ alarm_timestamp > 0 }}"
      
      - repeat:
          count: "{{ al_switches | length }}"
          sequence:
            - variables:
                current_switch: "{{ al_switches[repeat.index - 1] }}"
                alarm_offset: >
                  {% if 'bedroom_primary' in current_switch %}
                    -1800
                  {% elif 'main_living' in current_switch %}
                    -1200
                  {% elif 'kitchen_island' in current_switch %}
                    -2700
                  {% else %}
                    -1500
                  {% endif %}
                final_sunrise_time: >
                  {% set final_time = alarm_timestamp + alarm_offset %}
                  {{ final_time | timestamp_custom('%H:%M:%S', true) }}
            - service: adaptive_lighting.change_switch_settings
              data:
                entity_id: "{{ current_switch }}"
                sunrise_time: "{{ final_sunrise_time }}"

  # ---------------------------------------------------------------------------
  # 4.9 Wake-up sequence (staged brightening)
  # ---------------------------------------------------------------------------
  - id: oal_wake_up_sequence_v13
    alias: "OAL v13 - Wake-up Sequence (Staged Brightening)"
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/1"
    condition:
      - condition: state
        entity_id: input_boolean.oal_disable_next_sonos_wakeup
        state: "off"
      - condition: template
        value_template: >
          {% set bedroom_sunrise_str = state_attr('switch.adaptive_lighting_bedroom_primary', 'sunrise_time') %}
          {% if bedroom_sunrise_str %}
            {% set sunrise_dt = today_at(bedroom_sunrise_str) %}
            {% if sunrise_dt %}
              {% set now_ts = now().timestamp() %}
              {% set sunrise_ts = sunrise_dt.timestamp() %}
              {{ sunrise_ts <= now_ts < (sunrise_ts + 60) }}
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}
    action:
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_bedroom_primary
          brightness_pct: 50
          transition: 600
          turn_on_lights: true
          set_manual_control: true
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_main_living
          lights: light.entryway_lamp
          brightness_pct: 50
          transition: 600
          turn_on_lights: true
          set_manual_control: true
      - delay: "00:10:00"
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_kitchen_island
          brightness_pct: 80
          transition: 600
          turn_on_lights: true
          set_manual_control: true
      - service: adaptive_lighting.apply
        data:
          entity_id: switch.adaptive_lighting_bedroom_primary
          brightness_pct: 80
          transition: 600

  # ---------------------------------------------------------------------------
  # 4.10 Movie mode (snapshot + restore)
  # ---------------------------------------------------------------------------
  - id: oal_movie_mode_handler_v13
    alias: "OAL v13 - Movie Mode Handler"
    description: "Manages movie mode with scene snapshot and proper AL manual control handling."
    trigger:
      - platform: state
        entity_id: media_player.living_room_apple_tv
        to: "Playing"
        id: "start_movie"
      - platform: state
        entity_id: media_player.living_room_apple_tv
        to:
          - "Paused"
          - "Off"
        for: "00:01:30"
        id: "end_movie"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
    action:
      - choose:
          - conditions: "{{ trigger.id == 'start_movie' }}"
            sequence:
              # Snapshot current state
              - service: scene.create
                data:
                  scene_id: oal_before_movie
                  snapshot_entities:
                    - light.all_adaptive_lights
              
              # Set manual control FIRST to prevent AL interference
              # FIX: Must specify entity_id for each switch - service was broken without target
              - service: adaptive_lighting.set_manual_control
                continue_on_error: true
                target:
                  entity_id: switch.adaptive_lighting_main_living
                data:
                  lights: light.main_living_lights
                  manual_control: true
              - service: adaptive_lighting.set_manual_control
                continue_on_error: true
                target:
                  entity_id: switch.adaptive_lighting_kitchen_island
                data:
                  lights: light.kitchen_island_lights
                  manual_control: true
              - service: adaptive_lighting.set_manual_control
                continue_on_error: true
                target:
                  entity_id: switch.adaptive_lighting_recessed_ceiling
                data:
                  lights: light.recessed_ceiling_lights
                  manual_control: true
              
              # Now safe to turn lights off
              - service: light.turn_off
                continue_on_error: true
                target:
                  entity_id:
                    - light.main_living_lights
                    - light.kitchen_island_lights
                    - light.recessed_ceiling_lights
                data:
                  transition: 3
              
              # Use AL-native apply for accent lights with specific settings
              - service: adaptive_lighting.apply
                continue_on_error: true
                data:
                  entity_id: switch.adaptive_lighting_accent_spots
                  lights: light.accent_spots_lights
                  brightness_pct: 10
                  color_temp_kelvin: 2000
                  transition: 3
                  turn_on_lights: true
                  set_manual_control: true
              
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.oal_movie_mode_active

          - conditions: "{{ trigger.id == 'end_movie' }}"
            sequence:
              - condition: state
                entity_id: input_boolean.oal_movie_mode_active
                state: "on"
              
              # Restore snapshot (lights return to pre-movie state)
              - service: scene.turn_on
                target:
                  entity_id: scene.oal_before_movie
                data:
                  transition: 3
              
              # CRITICAL: Clear manual control to restore AL adaptive control
              # This allows AL to resume managing these lights automatically
              - service: adaptive_lighting.set_manual_control
                continue_on_error: true
                target:
                  entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
                data:
                  manual_control: false
              
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.oal_movie_mode_active

  # ---------------------------------------------------------------------------
  # 4.11 Sleep-mode schedule (sets input_select → Config Manager → Core Engine)
  # ---------------------------------------------------------------------------
  - id: oal_manage_sleep_mode_v13
    alias: "OAL v13 - Manage Sleep Mode Schedule"
    trigger:
      - platform: template
        value_template: >
          {{ now().strftime('%H:%M') == states('input_datetime.oal_late_night_start')[:5] }}
        id: "start_sleep"
      - platform: time
        at: "06:00:00"
        id: "end_sleep"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
      - condition: state
        entity_id: input_boolean.oal_disable_sleep_mode
        state: "off"
    action:
      # Set input_select - Config Manager handles sleep toggle + Core Engine applies
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: "{{ 'Sleep' if trigger.id == 'start_sleep' else 'Adaptive' }}"

  # ---------------------------------------------------------------------------
  # 4.11b Force Sleep Mode Sync (bidirectional sync between toggle and config)
  # ---------------------------------------------------------------------------
  - id: oal_force_sleep_sync_v13
    alias: "OAL v13 - Force Sleep Sync"
    description: "Syncs force_sleep toggle with config selection - Config Manager handles the rest"
    trigger:
      - platform: state
        entity_id: input_boolean.oal_force_sleep
        from: "off"
        to: "on"
        id: "sleep_enabled"
      - platform: state
        entity_id: input_boolean.oal_force_sleep
        from: "on"
        to: "off"
        id: "sleep_disabled"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
    action:
      # Just set the config - Config Manager handles all AL switch settings
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: >
            {% if trigger.id == 'sleep_enabled' and states('input_select.oal_active_configuration') != 'Sleep' %}
              Sleep
            {% elif trigger.id == 'sleep_disabled' and states('input_select.oal_active_configuration') == 'Sleep' %}
              Adaptive
            {% else %}
              {{ states('input_select.oal_active_configuration') }}
            {% endif %}

  # ---------------------------------------------------------------------------
  # 4.12 System startup
  # ---------------------------------------------------------------------------
  - id: oal_system_startup_v13
    alias: "OAL v13 - System Startup Initialization"
    trigger:
      - platform: homeassistant
        event: start
    action:
      - wait_for_trigger:
          - platform: event
            event_type: component_loaded
            event_data:
              component: adaptive_lighting
      - delay: "00:00:10"
      - action: switch.turn_off
        target:
          entity_id: switch.adaptive_lighting_recessed_ceiling_adapt_color
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.oal_system_paused
      - service: script.oal_reset_global
      - delay: "00:00:02"
      # Trigger initial calculations
      - event: oal_watchdog_trigger
        event_data:
          message: "System startup - forcing initial engine run"

  # ---------------------------------------------------------------------------
  # 4.13 Watchdog (ensure engine runs at least every 30 minutes)
  # ---------------------------------------------------------------------------
  - id: oal_watchdog_service_v13
    alias: "OAL v13 - Watchdog Service"
    trigger:
      - platform: time_pattern
        minutes: "/10"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
      - condition: template
        value_template: >
          {{ (now().timestamp() - (states('input_datetime.oal_last_engine_run') | as_timestamp(0))) > 1800 }}
    action:
      - event: oal_watchdog_trigger
        event_data:
          message: "Engine run time stale, proactively triggering."

  # ---------------------------------------------------------------------------
  # 4.14 Nightly maintenance
  # ---------------------------------------------------------------------------
  - id: oal_nightly_maintenance_v13
    alias: "OAL v13 - Nightly Maintenance (Clear Stuck Manual)"
    trigger:
      - platform: time
        at: "03:00:00"
    action:
      - service: adaptive_lighting.set_manual_control
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
        data:
          manual_control: false
      - condition: template
        value_template: >
          {{ (now().timestamp() - (states('input_datetime.zen32_last_button_press') | as_timestamp(0))) > 86400 }}
      - service: script.oal_reset_soft

  # ---------------------------------------------------------------------------
  # 4.15 Global pause (toggle all AL switches)
  # ---------------------------------------------------------------------------
  - id: oal_global_pause_manager_v13
    alias: "OAL v13 - Global Pause Manager"
    trigger:
      - platform: state
        entity_id: input_boolean.oal_system_paused
    action:
      - action: "switch.turn_{{ 'off' if trigger.to_state.state == 'on' else 'on' }}"
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"

  # ---------------------------------------------------------------------------
  # 4.16 Autoreset sync (input_number → AL switches)
  # ---------------------------------------------------------------------------
  - id: oal_autoreset_from_input_v13
    alias: "OAL v13 - Autoreset Sync (Input → AL)"
    trigger:
      - platform: state
        entity_id: input_number.oal_control_zonal_timeout_hours
    condition:
      - condition: state
        entity_id: input_boolean.oal_autoreset_sync_lock
        state: "off"
    variables:
      autoreset_seconds: "{{ (states('input_number.oal_control_zonal_timeout_hours') | float(4) * 3600) | int }}"
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.oal_autoreset_sync_lock
      - service: adaptive_lighting.change_switch_settings
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
        data:
          autoreset_control_seconds: "{{ autoreset_seconds }}"
      - delay: "00:00:01"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.oal_autoreset_sync_lock

  # ---------------------------------------------------------------------------
  # 4.17 Autoreset sync (AL switches → input_number)
  # ---------------------------------------------------------------------------
  - id: oal_autoreset_from_switch_v13
    alias: "OAL v13 - Autoreset Sync (AL → Input)"
    trigger:
      - platform: state
        entity_id:
          - switch.adaptive_lighting_main_living
          - switch.adaptive_lighting_kitchen_island
          - switch.adaptive_lighting_bedroom_primary
          - switch.adaptive_lighting_accent_spots
          - switch.adaptive_lighting_recessed_ceiling
    condition:
      - condition: state
        entity_id: input_boolean.oal_autoreset_sync_lock
        state: "off"
      - condition: template
        value_template: >
          {% set seconds = state_attr(trigger.entity_id, 'autoreset_control_seconds') | int(0) %}
          {% if seconds <= 0 %}
            false
          {% else %}
            {% set new_hours = seconds / 3600 %}
            {% set current_hours = states('input_number.oal_control_zonal_timeout_hours') | float(4) %}
            {{ (new_hours - current_hours) | abs > 0.01 }}
          {% endif %}
    action:
      - variables:
          seconds: "{{ state_attr(trigger.entity_id, 'autoreset_control_seconds') | int(0) }}"
          new_hours: "{{ (seconds / 3600) if seconds > 0 else 0 }}"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.oal_autoreset_sync_lock
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_control_zonal_timeout_hours
        data:
          value: "{{ new_hours }}"
      - delay: "00:00:01"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.oal_autoreset_sync_lock

  # ---------------------------------------------------------------------------
  # 4.5 Notification Automations (Phase 3)
  # ---------------------------------------------------------------------------
  - id: oal_v13_post_sunset_override_reminder
    alias: "OAL v13 - Post-Sunset Manual Override Reminder"
    mode: single
    trigger:
      - platform: state
        entity_id: sun.sun
        to: "below_horizon"
        for: "00:30:00"
    condition:
      - condition: numeric_state
        entity_id: sensor.oal_system_status
        attribute: active_zonal_overrides
        above: 0
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
    action:
      - service: notify.notify
        data:
          title: "Lights Still Manual"
          message: >
            {{ state_attr('sensor.oal_system_status', 'overridden_zones') | join(', ') }}
            {{ 'is' if state_attr('sensor.oal_system_status', 'overridden_zones') | length == 1 else 'are' }}
            still manually controlled. Reset to adaptive?
          data:
            tag: "oal_override_reminder"
            actions:
              - action: "OAL_RESET_LIGHTS"
                title: "Reset to Adaptive"
              - action: "OAL_KEEP_MANUAL"
                title: "Keep Manual"
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "OAL_RESET_LIGHTS"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "OAL_KEEP_MANUAL"
        timeout: "01:00:00"
        continue_on_timeout: true
      - choose:
          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == 'OAL_RESET_LIGHTS' }}"
            sequence:
              - service: script.oal_reset_soft
              - service: notify.notify
                data:
                  message: "Lights reset to adaptive control."
                  data:
                    tag: "oal_override_reminder"

  - id: oal_v13_override_expiring_notification
    alias: "OAL v13 - Override Expiring Soon Warning"
    mode: single
    trigger:
      - platform: template
        value_template: >
          {% set secs = state_attr('sensor.oal_soonest_override', 'seconds_remaining') | int(0) %}
          {{ secs > 0 and secs < 300 }}
        for: "00:00:05"
    condition:
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
      - condition: state
        entity_id: sun.sun
        state: "below_horizon"
    action:
      - service: notify.notify
        data:
          title: "OAL Override Expiring"
          message: >
            {{ state_attr('sensor.oal_soonest_override', 'zone_friendly') }}
            returning to adaptive in {{ states('sensor.oal_soonest_override') }}.
          data:
            tag: "oal_override_expiring"
            actions:
              - action: "OAL_EXTEND_OVERRIDE"
                title: "Extend 1 Hour"
              - action: "OAL_LET_EXPIRE"
                title: "Let Expire"
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "OAL_EXTEND_OVERRIDE"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "OAL_LET_EXPIRE"
        timeout: "00:05:00"
        continue_on_timeout: true
      - choose:
          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == 'OAL_EXTEND_OVERRIDE' }}"
            sequence:
              - service: adaptive_lighting.set_manual_control
                target:
                  entity_id: >
                    switch.adaptive_lighting_{{ state_attr('sensor.oal_soonest_override', 'zone_id') }}
                data:
                  manual_control: true
              - service: notify.notify
                data:
                  message: "Override extended for 1 hour."
                  data:
                    tag: "oal_override_expiring"

  # -------------------------------------------------------------------------
  # Auto-switch to "Manual" config when lights are manually controlled
  # -------------------------------------------------------------------------
  - id: oal_auto_switch_to_manual_config
    alias: "OAL - Auto Switch to Manual Config on Manual Control"
    description: "Switches config to 'Manual' when any AL switch detects manual control"
    mode: single
    trigger:
      - platform: template
        value_template: >
          {% set zones = [
            'switch.adaptive_lighting_main_living',
            'switch.adaptive_lighting_kitchen_island',
            'switch.adaptive_lighting_bedroom_primary',
            'switch.adaptive_lighting_accent_spots',
            'switch.adaptive_lighting_recessed_ceiling',
            'switch.adaptive_lighting_column_lights'
          ] %}
          {% set ns = namespace(count=0) %}
          {% for z in zones %}
            {% set ns.count = ns.count + (state_attr(z, 'manual_control') | default([]) | length) %}
          {% endfor %}
          {{ ns.count > 0 }}
    condition:
      # Only switch to Manual if we're currently on Adaptive
      # This prevents overriding intentional config selections like TV Mode, Sleep, etc.
      - condition: template
        value_template: "{{ states('input_select.oal_active_configuration') == 'Adaptive' }}"
      - condition: state
        entity_id: input_boolean.oal_system_paused
        state: "off"
    action:
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: "Manual"

# =============================================================================
# LAYER 5: SCRIPTS (MANUAL PIPELINE + CART/CARB + RESETS)
# =============================================================================

script:
  oal_global_adjustment_start:
    alias: "OAL Global Adjustment Start (Helper)"
    description: "Sets manual control on ON lights and switches config to 'Manual' mode."
    icon: mdi:cog-transfer
    sequence:
      # First: Set manual control on all AL switches for lights that are ON
      # This enables Reset button highlighting and auto-reset timer
      - service: adaptive_lighting.set_manual_control
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
        data:
          # Only set manual control for lights that are currently on
          lights: >
            {{ expand('light.all_adaptive_lights')
               | selectattr('state', 'eq', 'on')
               | map(attribute='entity_id')
               | list }}
          manual_control: true
      
      # Then: Switch config to Manual
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: "Manual"

  # Single shared manual brightness stepper (per-zone, B_base-aware)
  # Supports optional 'lights' param for per-room control
  oal_manual_brightness_step:
    alias: "OAL v13 - Manual Brightness Step (Per-Zone, B_base-aware)"
    description: "Adjusts zone brightness offsets. Optionally filter to specific lights/zones."
    icon: mdi:brightness-percent
    fields:
      direction:
        description: "1 for brighter, -1 for dimmer"
        example: 1
        required: true
        selector:
          select:
            options:
              - label: "Brighter"
                value: "1"
              - label: "Dimmer"
                value: "-1"
      lights:
        description: "Optional: Light entities or group to adjust. If omitted, adjusts all zones."
        required: false
        selector:
          entity:
            domain: light
            multiple: true
    sequence:
      - variables:
          dir: "{{ direction | int(1) }}"
          
          # Expand input lights (handles groups and individual lights)
          input_lights: >
            {% if lights is defined and lights %}
              {% set expanded = expand(lights) | map(attribute='entity_id') | list %}
              {{ expanded if expanded | length > 0 else [lights] if lights is string else lights }}
            {% else %}
              []
            {% endif %}
          
          # Zone group definitions (existing groups)
          zone_groups:
            main_living: light.main_living_lights
            kitchen_island: light.kitchen_island_lights
            bedroom_primary: light.bedroom_primary_lights
            accent_spots: light.accent_spots_lights
            recessed_ceiling: light.recessed_ceiling_lights
            column_lights: light.column_lights
          
          # All zone IDs
          all_zone_ids:
            - main_living
            - kitchen_island
            - bedroom_primary
            - accent_spots
            - recessed_ceiling
            - column_lights
          
          # Determine which zones contain the input lights
          target_zones: >
            {% if input_lights | length == 0 %}
              {{ all_zone_ids }}
            {% else %}
              {% set ns = namespace(zones=[]) %}
              {% for zone_id in all_zone_ids %}
                {% set group_entity = zone_groups[zone_id] %}
                {% set group_members = expand(group_entity) | map(attribute='entity_id') | list %}
                {% for light in input_lights %}
                  {% if light in group_members and zone_id not in ns.zones %}
                    {% set ns.zones = ns.zones + [zone_id] %}
                  {% endif %}
                {% endfor %}
              {% endfor %}
              {{ ns.zones }}
            {% endif %}
      
      # Execute all zone updates in parallel for instant responsiveness
      - parallel:
          # Main Living
          - if:
              - condition: template
                value_template: "{{ 'main_living' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_main_living', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 1.0 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_main_living_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_main_living_brightness
                data:
                  value: "{{ new_value }}"
          
          # Kitchen Island
          - if:
              - condition: template
                value_template: "{{ 'kitchen_island' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_kitchen_island', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 0.9 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_kitchen_island_brightness
                data:
                  value: "{{ new_value }}"
          
          # Bedroom Primary
          - if:
              - condition: template
                value_template: "{{ 'bedroom_primary' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_bedroom_primary', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 0.7 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_bedroom_primary_brightness
                data:
                  value: "{{ new_value }}"
          
          # Accent Spots
          - if:
              - condition: template
                value_template: "{{ 'accent_spots' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_accent_spots', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 0.6 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_accent_spots_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_accent_spots_brightness
                data:
                  value: "{{ new_value }}"
          
          # Recessed Ceiling
          - if:
              - condition: template
                value_template: "{{ 'recessed_ceiling' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_recessed_ceiling', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 0.3 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_recessed_ceiling_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_recessed_ceiling_brightness
                data:
                  value: "{{ new_value }}"

          # Column Lights
          - if:
              - condition: template
                value_template: "{{ 'column_lights' in target_zones }}"
            then:
              - variables:
                  b_base: >
                    {{ state_attr('switch.adaptive_lighting_column_lights', 'brightness_pct') | float(50) }}
                  base_step: >
                    {% if dir == 1 %}
                      {% if b_base < 30 %} 10
                      {% elif b_base < 60 %} 15
                      {% else %} 20
                      {% endif %}
                    {% else %}
                      {% if b_base < 40 %} 10
                      {% elif b_base < 70 %} 15
                      {% else %} 20
                      {% endif %}
                    {% endif %}
                  step: "{{ base_step * 0.8 }}"
                  current_offset: "{{ states('input_number.oal_manual_offset_column_lights_brightness') | float(0) }}"
                  raw_new: "{{ current_offset + (step * dir) }}"
                  new_value: "{{ [-100, [100, raw_new] | min] | max }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.oal_manual_offset_column_lights_brightness
                data:
                  value: "{{ new_value }}"

  oal_global_manual_brighter:
    alias: "OAL v13 Global Brighter (CARB, unified pipeline)"
    description: "Increases brightness across all zones using context-aware stepped adjustments."
    icon: mdi:brightness-7
    sequence:
      - service: script.oal_manual_brightness_step
        data:
          direction: 1
      - service: script.oal_global_adjustment_start

  oal_global_manual_dimmer:
    alias: "OAL v13 Global Dimmer (CARB, unified pipeline)"
    description: "Decreases brightness across all zones using context-aware stepped adjustments."
    icon: mdi:brightness-5
    sequence:
      - service: script.oal_manual_brightness_step
        data:
          direction: -1
      - service: script.oal_global_adjustment_start

  oal_global_manual_cooler:
    alias: "OAL v13 Global Cooler (CART)"
    description: "Shifts color temperature cooler (higher Kelvin)."
    icon: mdi:thermometer-plus
    sequence:
      - variables:
          current_offset: "{{ states('input_number.oal_offset_global_manual_warmth') | float(0) }}"
          avg_temp: "{{ states('sensor.oal_average_active_color_temperature') | float(3000) }}"
          increment: >
            {% if avg_temp < 2500 %} 700
            {% elif avg_temp < 4500 %} 500
            {% else %} 300
            {% endif %}
          new_value: "{{ [2500, current_offset + increment] | min }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_global_manual_warmth
        data:
          value: "{{ new_value }}"
      - service: script.oal_global_adjustment_start

  oal_global_manual_warmer:
    alias: "OAL v13 Global Warmer (CART)"
    description: "Shifts color temperature warmer (lower Kelvin)."
    icon: mdi:thermometer-minus
    sequence:
      - variables:
          current_offset: "{{ states('input_number.oal_offset_global_manual_warmth') | float(0) }}"
          avg_temp: "{{ states('sensor.oal_average_active_color_temperature') | float(3000) }}"
          increment: >
            {% if avg_temp < 2500 %} 300
            {% elif avg_temp < 4500 %} 500
            {% else %} 700
            {% endif %}
          new_value: "{{ [-2500, current_offset - increment] | max }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.oal_offset_global_manual_warmth
        data:
          value: "{{ new_value }}"
      - service: script.oal_global_adjustment_start

  oal_reset_soft:
    alias: "OAL v13 Reset Soft (Manual, Configs, Zonal)"
    description: "Resets manual offsets, config selection, and isolated overrides to defaults."
    icon: mdi:restore
    sequence:
      # FIRST: Turn on all AL switches (apply requires switches to be ON)
      - service: switch.turn_on
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
      # Reset column lights switch settings to ensure fast transitions
      - service: adaptive_lighting.change_switch_settings
        data:
          entity_id: switch.adaptive_lighting_column_lights
          use_defaults: configuration
          include_config_in_attributes: true
          initial_transition: 1
          sleep_transition: 1
          transition: 1
          separate_turn_on_commands: false
          send_split_delay: false
          prefer_rgb_color: true
          sleep_rgb_or_color_temp: "rgb_color"
      # THEN: Clear manual_control so Core Engine will apply changes
      - service: adaptive_lighting.set_manual_control
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
        data:
          manual_control: false
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.oal_offset_global_manual_warmth
            - input_number.oal_manual_offset_main_living_brightness
            - input_number.oal_manual_offset_kitchen_island_brightness
            - input_number.oal_manual_offset_bedroom_primary_brightness
            - input_number.oal_manual_offset_accent_spots_brightness
            - input_number.oal_manual_offset_recessed_ceiling_brightness
            - input_number.oal_manual_offset_column_lights_brightness
        data:
          value: 0
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_active_configuration
        data:
          option: "Adaptive"
      - service: input_select.select_option
        target:
          entity_id: input_select.oal_isolated_override_mode
        data:
          option: "Off"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.oal_movie_mode_active
      # LAST: Wait for any Config Manager transition to complete, then apply AL directly
      # This ensures lights are updated regardless of whether config actually changed
      - wait_template: "{{ is_state('input_boolean.oal_config_transition_active', 'off') }}"
        timeout: "00:00:10"
      # Apply to non-column switches first
      - service: adaptive_lighting.apply
        target:
          entity_id:
            - switch.adaptive_lighting_main_living
            - switch.adaptive_lighting_kitchen_island
            - switch.adaptive_lighting_bedroom_primary
            - switch.adaptive_lighting_accent_spots
            - switch.adaptive_lighting_recessed_ceiling
        data:
          turn_on_lights: true
          transition: 1
      # Apply to column lights separately with forced fast transition
      - service: adaptive_lighting.apply
        target:
          entity_id: switch.adaptive_lighting_column_lights
        data:
          turn_on_lights: true
          transition: 1

  oal_reset_global:
    alias: "OAL v13 Reset Global (Nuclear)"
    description: "Full system reset including environmental and sunset offsets. Restores all AL switches to defaults."
    icon: mdi:refresh-circle
    sequence:
      - service: script.oal_reset_soft
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.oal_offset_environmental_brightness
            - input_number.oal_offset_environmental_warmth
            - input_number.oal_offset_sunset_brightness
            - input_number.oal_offset_sunset_warmth
        data:
          value: 0
      - service: adaptive_lighting.change_switch_settings
        target:
          entity_id: "{{ expand('group.oal_control_switches') | map(attribute='entity_id') | list }}"
        data:
          use_defaults: "configuration"

  # -------------------------------------------------------------------------
  # Parameterized Room Reset Script (replaces hardcoded oal_reset_living_room)
  # -------------------------------------------------------------------------
  oal_reset_room:
    alias: "OAL Reset Room"
    description: "Resets manual control and offsets for zones containing specified lights"
    icon: mdi:refresh
    fields:
      lights:
        description: "Light group or entities to reset (e.g., light.all_living_room_lights)"
        required: true
        selector:
          entity:
            domain: light
            multiple: true
    sequence:
      - variables:
          # Same zone detection logic as brightness_step
          input_lights: >
            {% set expanded = expand(lights) | map(attribute='entity_id') | list %}
            {{ expanded if expanded | length > 0 else [lights] if lights is string else lights }}

          zone_groups:
            main_living: light.main_living_lights
            kitchen_island: light.kitchen_island_lights
            bedroom_primary: light.bedroom_primary_lights
            accent_spots: light.accent_spots_lights
            recessed_ceiling: light.recessed_ceiling_lights
            column_lights: light.column_lights

          zone_switches:
            main_living: switch.adaptive_lighting_main_living
            kitchen_island: switch.adaptive_lighting_kitchen_island
            bedroom_primary: switch.adaptive_lighting_bedroom_primary
            accent_spots: switch.adaptive_lighting_accent_spots
            recessed_ceiling: switch.adaptive_lighting_recessed_ceiling
            column_lights: switch.adaptive_lighting_column_lights

          zone_offsets:
            main_living: input_number.oal_manual_offset_main_living_brightness
            kitchen_island: input_number.oal_manual_offset_kitchen_island_brightness
            bedroom_primary: input_number.oal_manual_offset_bedroom_primary_brightness
            accent_spots: input_number.oal_manual_offset_accent_spots_brightness
            recessed_ceiling: input_number.oal_manual_offset_recessed_ceiling_brightness
            column_lights: input_number.oal_manual_offset_column_lights_brightness

          all_zone_ids:
            - main_living
            - kitchen_island
            - bedroom_primary
            - accent_spots
            - recessed_ceiling
            - column_lights

          target_zones: >
            {% set ns = namespace(zones=[]) %}
            {% for zone_id in all_zone_ids %}
              {% set group_entity = zone_groups[zone_id] %}
              {% set group_members = expand(group_entity) | map(attribute='entity_id') | list %}
              {% for light in input_lights %}
                {% if light in group_members and zone_id not in ns.zones %}
                  {% set ns.zones = ns.zones + [zone_id] %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            {{ ns.zones }}

          # Build target lists using namespace loop
          target_switches: >
            {% set ns = namespace(items=[]) %}
            {% for zone in target_zones %}
              {% set ns.items = ns.items + [zone_switches[zone]] %}
            {% endfor %}
            {{ ns.items }}

          target_offsets: >
            {% set ns = namespace(items=[]) %}
            {% for zone in target_zones %}
              {% set ns.items = ns.items + [zone_offsets[zone]] %}
            {% endfor %}
            {{ ns.items }}

      # Clear manual control for affected zones
      - service: adaptive_lighting.set_manual_control
        target:
          entity_id: "{{ target_switches }}"
        data:
          manual_control: false

      # Reset brightness offsets for affected zones
      - service: input_number.set_value
        target:
          entity_id: "{{ target_offsets }}"
        data:
          value: 0

      # Re-apply adaptive lighting
      - service: adaptive_lighting.apply
        target:
          entity_id: "{{ target_switches }}"
        data:
          turn_on_lights: true
          transition: 1

# =============================================================================
# LAYER 6: TEMPLATE SENSORS (DIAGNOSTICS & MONITORING)
# =============================================================================

template:
  - sensor:
      # -----------------------------------------------------------------------
      # 6.1 Real-time monitor (baseline vs boosted, per-zone)
      # -----------------------------------------------------------------------
      - name: "OAL Real-Time Monitor"
        unique_id: oal_realtime_monitor_v13
        icon: mdi:monitor-dashboard
        availability: >
          {{ states('input_boolean.oal_system_paused') not in ['unknown', 'unavailable'] }}
        state: >
          {% set force_sleep = is_state('input_boolean.oal_force_sleep', 'on') %}
          {% set b_cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
          {% set b_env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
          {% set b_sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
          {% set zones = [
            states('input_number.oal_manual_offset_main_living_brightness') | float(0),
            states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0),
            states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0),
            states('input_number.oal_manual_offset_accent_spots_brightness') | float(0),
            states('input_number.oal_manual_offset_recessed_ceiling_brightness') | float(0),
            states('input_number.oal_manual_offset_column_lights_brightness') | float(0)
          ] %}
          {% set max_zone = (zones | map('abs') | max) if zones | length > 0 else 0 %}
          {% if force_sleep %}
            Sleep Mode
          {% elif b_cfg == 0 and b_env == 0 and b_sun == 0 and max_zone == 0 %}
            Baseline
          {% else %}
            Boosted
          {% endif %}
        attributes:
          # Global offsets
          b_config_offset: "{{ states('input_number.oal_offset_config_brightness') | float(0) }}"
          b_environmental_offset: "{{ states('input_number.oal_offset_environmental_brightness') | float(0) }}"
          b_sunset_offset: "{{ states('input_number.oal_offset_sunset_brightness') | float(0) }}"
          k_global_manual: "{{ states('input_number.oal_offset_global_manual_warmth') | float(0) }}"
          k_config_offset: "{{ states('input_number.oal_offset_config_warmth') | float(0) }}"
          k_environmental_offset: "{{ states('input_number.oal_offset_environmental_warmth') | float(0) }}"
          k_sunset_offset: "{{ states('input_number.oal_offset_sunset_warmth') | float(0) }}"

          # Main living
          main_living_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_main_living', 'brightness_pct') | float(0) }}
          main_living_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_main_living', 'configuration') or {}).get('min_brightness', 0) }}
          main_living_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_main_living', 'configuration') or {}).get('max_brightness', 0) }}
          main_living_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_main_living_brightness') | float(0) }}

          # Kitchen island
          kitchen_island_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_kitchen_island', 'brightness_pct') | float(0) }}
          kitchen_island_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_kitchen_island', 'configuration') or {}).get('min_brightness', 0) }}
          kitchen_island_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_kitchen_island', 'configuration') or {}).get('max_brightness', 0) }}
          kitchen_island_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) }}

          # Bedroom primary
          bedroom_primary_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_bedroom_primary', 'brightness_pct') | float(0) }}
          bedroom_primary_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_bedroom_primary', 'configuration') or {}).get('min_brightness', 0) }}
          bedroom_primary_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_bedroom_primary', 'configuration') or {}).get('max_brightness', 0) }}
          bedroom_primary_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) }}

          # Accent spots
          accent_spots_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_accent_spots', 'brightness_pct') | float(0) }}
          accent_spots_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_accent_spots', 'configuration') or {}).get('min_brightness', 0) }}
          accent_spots_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_accent_spots', 'configuration') or {}).get('max_brightness', 0) }}
          accent_spots_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_accent_spots_brightness') | float(0) }}

          # Recessed ceiling
          recessed_ceiling_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_recessed_ceiling', 'brightness_pct') | float(0) }}
          recessed_ceiling_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_recessed_ceiling', 'configuration') or {}).get('min_brightness', 0) }}
          recessed_ceiling_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_recessed_ceiling', 'configuration') or {}).get('max_brightness', 0) }}
          recessed_ceiling_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_recessed_ceiling_brightness') | float(0) }}

          # Column lights
          column_lights_baseline_brightness_pct: >
            {{ state_attr('switch.adaptive_lighting_column_lights', 'brightness_pct') | float(0) }}
          column_lights_effective_min_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_column_lights', 'configuration') or {}).get('min_brightness', 0) }}
          column_lights_effective_max_brightness_pct: >
            {{ (state_attr('switch.adaptive_lighting_column_lights', 'configuration') or {}).get('max_brightness', 0) }}
          column_lights_manual_offset_brightness_pct: >
            {{ states('input_number.oal_manual_offset_column_lights_brightness') | float(0) }}
          boost_source: >
            {% set sources = [] %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% if env > 0 %}{% set sources = sources + ['☀️+' ~ env | int ~ '%'] %}{% endif %}
            {% if cfg != 0 %}{% set sources = sources + ['⚙️' ~ ('+' if cfg > 0 else '') ~ cfg | int ~ '%'] %}{% endif %}
            {% if sun != 0 %}{% set sources = sources + ['🌅' ~ ('+' if sun > 0 else '') ~ sun | int ~ '%'] %}{% endif %}
            {{ sources | join(' ') if sources else 'Baseline' }}

            
      # -----------------------------------------------------------------------
      # 6.2 Average active color temperature (safe aggregate for warmth)
      # -----------------------------------------------------------------------
      - name: "OAL Average Active Color Temperature"
        unique_id: oal_average_active_color_temperature_v13
        unit_of_measurement: "K"
        icon: mdi:thermometer
        device_class: temperature
        availability: >
          {{ expand('group.oal_control_switches') | list | length > 0 }}
        state: >
          {% set switches = expand('group.oal_control_switches') %}
          {% set active_color_switches = switches
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.adapt_color', 'defined')
              | selectattr('attributes.adapt_color', 'eq', true)
              | list %}
          {% if active_color_switches | length > 0 %}
            {% set values = active_color_switches
                | map(attribute='attributes.color_temp_kelvin')
                | select('defined') | map('float', 3000) | list %}
            {% if values | length > 0 %}
              {{ (values | sum / (values | length)) | round(0) }}
            {% else %}
              3000
            {% endif %}
          {% else %}
            3000
          {% endif %}

      # -----------------------------------------------------------------------
      # 6.3 System status (high-level mode + engine health)
      # -----------------------------------------------------------------------
      - name: "OAL System Status"
        unique_id: oal_system_status_v13
        icon: mdi:information-outline
        availability: >
          {{ states('input_boolean.oal_system_paused') not in ['unknown', 'unavailable'] }}
        state: >
          {% if is_state('input_boolean.oal_system_paused', 'on') %}
            Paused
          {% elif is_state('input_boolean.oal_force_sleep', 'on') %}
            Sleep Mode
          {% elif is_state('input_boolean.oal_movie_mode_active', 'on') %}
            Movie Mode
          {% elif states('input_select.oal_isolated_override_mode') != 'Off' %}
            Isolated: {{ states('input_select.oal_isolated_override_mode') }}
          {% elif states('input_select.oal_active_configuration') not in ['Adaptive', 'Sleep'] %}
            {{ states('input_select.oal_active_configuration') }}
          {% elif states('input_number.oal_offset_environmental_brightness') | float(0) > 0 %}
            Environmental Boost
          {% else %}
            Baseline Adaptation
          {% endif %}
        attributes:
          engine_health: >
            {% set last_engine = states('input_datetime.oal_last_engine_run') | as_timestamp(0) %}
            {% set stale = (now().timestamp() - last_engine) > 1800 %}
            {{ 'Stale (>30m) - Watchdog Active' if stale else 'Normal' }}
          active_zonal_overrides: >
            {% set zonal = expand('group.oal_control_switches')
                | selectattr('attributes.manual_control', 'defined')
                | selectattr('attributes.manual_control', '!=', []) | list %}
            {{ zonal | length }}
          # --- Phase 3: Extended attributes (Tasks 3.1-3.14) ---
          zones_adaptive: >
            {{ 6 - (state_attr('sensor.oal_system_status', 'active_zonal_overrides') | int(0)) }}
          overridden_zones: >
            {% set ns = namespace(zones=[]) %}
            {% set zone_map = [
              ('Main Living', 'switch.adaptive_lighting_main_living'),
              ('Kitchen', 'switch.adaptive_lighting_kitchen_island'),
              ('Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
              ('Spots', 'switch.adaptive_lighting_accent_spots'),
              ('Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
              ('Columns', 'switch.adaptive_lighting_column_lights')
            ] %}
            {% for name, entity in zone_map %}
              {% if state_attr(entity, 'manual_control') | default([]) | length > 0 %}
                {% set ns.zones = ns.zones + [name] %}
              {% endif %}
            {% endfor %}
            {{ ns.zones }}
          soonest_reset_zone: >
            {{ state_attr('sensor.oal_soonest_override', 'zone_friendly') | default('None') }}
          soonest_reset_formatted: >
            {{ states('sensor.oal_soonest_override') }}
          soonest_reset_seconds: >
            {{ state_attr('sensor.oal_soonest_override', 'seconds_remaining') | int(0) }}
          current_preset: >
            {{ states('input_select.oal_active_configuration') | regex_replace('Config \\d+: ', '') }}
          active_modifiers: >
            {% set mods = [] %}
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% if cfg != 0 %}
              {% set mods = mods + [{'name': 'Config', 'value': cfg | int}] %}
            {% endif %}
            {% if env != 0 %}
              {% set weather = states('weather.home') | default('Weather') %}
              {% set mods = mods + [{'name': weather | title, 'value': env | int}] %}
            {% endif %}
            {% if sun != 0 %}
              {% set mods = mods + [{'name': 'Sunset', 'value': sun | int}] %}
            {% endif %}
            {{ mods }}
          total_modification: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {{ (cfg + env + sun) | int }}
          sun_phase: >
            {% set elev = state_attr('sun.sun', 'elevation') | float(0) %}
            {% set rising = state_attr('sun.sun', 'rising') | default(true) %}
            {% if elev < -6 %}night
            {% elif elev < 0 and rising %}dawn
            {% elif elev < 0 and not rising %}dusk
            {% elif now().hour < 12 %}morning
            {% elif now().hour < 17 %}day
            {% else %}evening{% endif %}
          weather_modifier_active: >
            {{ states('input_number.oal_offset_environmental_brightness') | float(0) != 0 }}
          weather_modifier_value: >
            {{ states('input_number.oal_offset_environmental_brightness') | int(0) }}
          system_paused: >
            {{ is_state('input_boolean.oal_system_paused', 'on') }}
          movie_mode_active: >
            {{ is_state('input_boolean.oal_movie_mode_active', 'on') }}
          isolated_mode: >
            {{ states('input_select.oal_isolated_override_mode') }}
          lights_on: >
            {% set all_lights = expand('light.all_adaptive_lights') %}
            {% set on_lights = all_lights | selectattr('state', 'eq', 'on') | list %}
            {{ on_lights | length }}
          lights_total: >
            {{ expand('light.all_adaptive_lights') | list | length }}
          lights_on_formatted: >
            {% set all_lights = expand('light.all_adaptive_lights') %}
            {% set on_lights = all_lights | selectattr('state', 'eq', 'on') | list %}
            {{ on_lights | length }}/{{ all_lights | length }}

      # -----------------------------------------------------------------------
      # 6.4 Per-Zone Status Sensors (for OAL Hero Card Dashboard)
      # -----------------------------------------------------------------------
      # These sensors provide zone-level status for the dashboard hero card.
      # State: "A" = adaptive, "M Xh Ym" = manual with timer countdown
      # -----------------------------------------------------------------------

      - name: "OAL Main Living Status"
        unique_id: oal_main_living_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_main_living') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_main_living', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_main_living', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_main_living', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_main_living', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'main_living_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_main_living_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 1.0 %}
            {% set manual = states('input_number.oal_manual_offset_main_living_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 1.0
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_main_living', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_main_living', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_main_living', 'manual_control') | default([]) | length }}
          lights_total: 6
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_main_living', 'color_temp_kelvin') | int(0) }}
          zone_id: "main_living"
          friendly_name: "Main Living"

      - name: "OAL Kitchen Island Status"
        unique_id: oal_kitchen_island_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_kitchen_island') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_kitchen_island', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_kitchen_island', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_kitchen_island', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_kitchen_island', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'kitchen_island_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_kitchen_island_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 1.0 %}
            {% set manual = states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 1.0
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_kitchen_island', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_kitchen_island', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_kitchen_island', 'manual_control') | default([]) | length }}
          lights_total: 1
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_kitchen_island', 'color_temp_kelvin') | int(0) }}
          zone_id: "kitchen_island"
          friendly_name: "Kitchen"

      - name: "OAL Bedroom Primary Status"
        unique_id: oal_bedroom_primary_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_bedroom_primary') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_bedroom_primary', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_bedroom_primary', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_bedroom_primary', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_bedroom_primary', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'bedroom_primary_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_bedroom_primary_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 0.5 %}
            {% set manual = states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 0.5
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_bedroom_primary', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_bedroom_primary', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_bedroom_primary', 'manual_control') | default([]) | length }}
          lights_total: 2
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_bedroom_primary', 'color_temp_kelvin') | int(0) }}
          zone_id: "bedroom_primary"
          friendly_name: "Bedroom"

      - name: "OAL Accent Spots Status"
        unique_id: oal_accent_spots_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_accent_spots') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_accent_spots', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_accent_spots', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'accent_spots_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_accent_spots_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 0.8 %}
            {% set manual = states('input_number.oal_manual_offset_accent_spots_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 0.8
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_accent_spots', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_accent_spots', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') | default([]) | length }}
          lights_total: 2
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_accent_spots', 'color_temp_kelvin') | int(0) }}
          zone_id: "accent_spots"
          friendly_name: "Spots"

      - name: "OAL Recessed Ceiling Status"
        unique_id: oal_recessed_ceiling_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_recessed_ceiling') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_recessed_ceiling', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_recessed_ceiling', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_recessed_ceiling', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_recessed_ceiling', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'recessed_ceiling_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_recessed_ceiling_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 0.6 %}
            {% set manual = states('input_number.oal_manual_offset_recessed_ceiling_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 0.6
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_recessed_ceiling', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_recessed_ceiling', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_recessed_ceiling', 'manual_control') | default([]) | length }}
          lights_total: 2
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_recessed_ceiling', 'color_temp_kelvin') | int(0) }}
          zone_id: "recessed_ceiling"
          friendly_name: "Ceiling"

      - name: "OAL Column Lights Status"
        unique_id: oal_column_lights_status_v13
        icon: mdi:lightbulb-group
        availability: >
          {{ states('switch.adaptive_lighting_column_lights') not in ['unknown', 'unavailable'] }}
        state: >
          {% set manual_list = state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) %}
          {% if manual_list | length == 0 %}
            A
          {% else %}
            {% set timer_dict = state_attr('switch.adaptive_lighting_column_lights', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            M {% if hours > 0 %}{{ hours }}h {% endif %}{{ mins }}m
          {% endif %}
        attributes:
          mode: >
            {% set manual_list = state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) %}
            {{ 'manual' if manual_list | length > 0 else 'adaptive' }}
          brightness_target: >
            {{ state_attr('switch.adaptive_lighting_column_lights', 'brightness_pct') | int(0) }}
          brightness_base: >
            {{ state_attr('sensor.oal_real_time_monitor', 'column_lights_baseline_brightness_pct') | int(0) }}
          zone_manual_offset: >
            {{ states('input_number.oal_manual_offset_column_lights_brightness') | int(0) }}
          total_offset: >
            {% set cfg = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sens = 0.7 %}
            {% set manual = states('input_number.oal_manual_offset_column_lights_brightness') | float(0) %}
            {{ (cfg + sun + (env * sens) + manual) | round(1) }}
          env_sensitivity: 0.7
          override_remaining_seconds: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_column_lights', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {{ (timer_values | min | default(0)) | int }}
          override_remaining_formatted: >
            {% set timer_dict = state_attr('switch.adaptive_lighting_column_lights', 'autoreset_time_remaining') | default({}) %}
            {% set timer_values = timer_dict.values() | list %}
            {% set secs = (timer_values | min | default(0)) | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if secs <= 0 %}N/A
            {% elif hours > 0 %}{{ hours }}h {{ mins }}m
            {% else %}{{ mins }}m{% endif %}
          lights_overridden: >
            {{ state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) | length }}
          lights_total: 2
          color_temp_kelvin: >
            {{ state_attr('switch.adaptive_lighting_column_lights', 'color_temp_kelvin') | int(0) }}
          zone_id: "column_lights"
          friendly_name: "Columns"

      # -----------------------------------------------------------------------
      # 6.5 Global Brightness Offset (aggregated from all sources)
      # -----------------------------------------------------------------------
      - name: "OAL Global Brightness Offset"
        unique_id: oal_global_brightness_offset_v13
        icon: mdi:brightness-percent
        availability: >
          {{ states('input_number.oal_offset_config_brightness') not in ['unknown', 'unavailable'] }}
        state: >
          {% set config = states('input_number.oal_offset_config_brightness') | float(0) %}
          {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
          {% set sunset = states('input_number.oal_offset_sunset_brightness') | float(0) %}
          {% set total = (config + env + sunset) | int %}
          {% if total == 0 %}Baseline
          {% elif total > 0 %}+{{ total }}%
          {% else %}{{ total }}%{% endif %}
        attributes:
          config_offset: >
            {{ states('input_number.oal_offset_config_brightness') | int(0) }}
          environmental_offset: >
            {{ states('input_number.oal_offset_environmental_brightness') | int(0) }}
          sunset_offset: >
            {{ states('input_number.oal_offset_sunset_brightness') | int(0) }}
          total_offset: >
            {% set config = states('input_number.oal_offset_config_brightness') | float(0) %}
            {% set env = states('input_number.oal_offset_environmental_brightness') | float(0) %}
            {% set sunset = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {{ (config + env + sunset) | int }}
          average_zone_brightness: >
            {% set zones = [
              state_attr('switch.adaptive_lighting_main_living', 'brightness_pct') | float(0),
              state_attr('switch.adaptive_lighting_kitchen_island', 'brightness_pct') | float(0),
              state_attr('switch.adaptive_lighting_bedroom_primary', 'brightness_pct') | float(0),
              state_attr('switch.adaptive_lighting_accent_spots', 'brightness_pct') | float(0),
              state_attr('switch.adaptive_lighting_recessed_ceiling', 'brightness_pct') | float(0),
              state_attr('switch.adaptive_lighting_column_lights', 'brightness_pct') | float(0)
            ] %}
            {{ (zones | sum / zones | length) | round(0) | int }}
          current_config: >
            {{ states('input_select.oal_active_configuration') | regex_replace('Config \\d+: ', '') }}

      # -----------------------------------------------------------------------
      # 6.6 Soonest Override Timer (cross-zone aggregate)
      # -----------------------------------------------------------------------
      - name: "OAL Soonest Override"
        unique_id: oal_soonest_override_v13
        icon: mdi:timer-outline
        availability: >
          {{ states('group.oal_control_switches') not in ['unknown', 'unavailable'] }}
        state: >
          {% set switches = [
            ('main_living', 'Main Living', 'switch.adaptive_lighting_main_living'),
            ('kitchen_island', 'Kitchen', 'switch.adaptive_lighting_kitchen_island'),
            ('bedroom_primary', 'Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
            ('accent_spots', 'Spots', 'switch.adaptive_lighting_accent_spots'),
            ('recessed_ceiling', 'Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
            ('column_lights', 'Columns', 'switch.adaptive_lighting_column_lights')
          ] %}
          {% set ns = namespace(times=[]) %}
          {% for zone_id, zone_friendly, switch_id in switches %}
            {% set timer_dict = state_attr(switch_id, 'autoreset_time_remaining') | default({}) %}
            {% for light, secs in timer_dict.items() %}
              {% set ns.times = ns.times + [{'zone_id': zone_id, 'zone_friendly': zone_friendly, 'secs': secs | float(0)}] %}
            {% endfor %}
          {% endfor %}
          {% if ns.times | length > 0 %}
            {% set soonest = ns.times | sort(attribute='secs') | first %}
            {% set secs = soonest.secs | int %}
            {% set hours = (secs // 3600) | int %}
            {% set mins = ((secs % 3600) // 60) | int %}
            {% if hours > 0 %}{{ hours }}h {{ mins }}m{% else %}{{ mins }}m{% endif %}
          {% else %}
            None
          {% endif %}
        attributes:
          zone_id: >
            {% set switches = [
              ('main_living', 'Main Living', 'switch.adaptive_lighting_main_living'),
              ('kitchen_island', 'Kitchen', 'switch.adaptive_lighting_kitchen_island'),
              ('bedroom_primary', 'Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
              ('accent_spots', 'Spots', 'switch.adaptive_lighting_accent_spots'),
              ('recessed_ceiling', 'Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
              ('column_lights', 'Columns', 'switch.adaptive_lighting_column_lights')
            ] %}
            {% set ns = namespace(times=[]) %}
            {% for zone_id, zone_friendly, switch_id in switches %}
              {% set timer_dict = state_attr(switch_id, 'autoreset_time_remaining') | default({}) %}
              {% for light, secs in timer_dict.items() %}
                {% set ns.times = ns.times + [{'zone_id': zone_id, 'zone_friendly': zone_friendly, 'secs': secs | float(0)}] %}
              {% endfor %}
            {% endfor %}
            {% if ns.times | length > 0 %}
              {{ (ns.times | sort(attribute='secs') | first).zone_id }}
            {% else %}
              None
            {% endif %}
          zone_friendly: >
            {% set switches = [
              ('main_living', 'Main Living', 'switch.adaptive_lighting_main_living'),
              ('kitchen_island', 'Kitchen', 'switch.adaptive_lighting_kitchen_island'),
              ('bedroom_primary', 'Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
              ('accent_spots', 'Spots', 'switch.adaptive_lighting_accent_spots'),
              ('recessed_ceiling', 'Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
              ('column_lights', 'Columns', 'switch.adaptive_lighting_column_lights')
            ] %}
            {% set ns = namespace(times=[]) %}
            {% for zone_id, zone_friendly, switch_id in switches %}
              {% set timer_dict = state_attr(switch_id, 'autoreset_time_remaining') | default({}) %}
              {% for light, secs in timer_dict.items() %}
                {% set ns.times = ns.times + [{'zone_id': zone_id, 'zone_friendly': zone_friendly, 'secs': secs | float(0)}] %}
              {% endfor %}
            {% endfor %}
            {% if ns.times | length > 0 %}
              {{ (ns.times | sort(attribute='secs') | first).zone_friendly }}
            {% else %}
              None
            {% endif %}
          reset_timestamp: >
            {% set switches = [
              ('main_living', 'Main Living', 'switch.adaptive_lighting_main_living'),
              ('kitchen_island', 'Kitchen', 'switch.adaptive_lighting_kitchen_island'),
              ('bedroom_primary', 'Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
              ('accent_spots', 'Spots', 'switch.adaptive_lighting_accent_spots'),
              ('recessed_ceiling', 'Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
              ('column_lights', 'Columns', 'switch.adaptive_lighting_column_lights')
            ] %}
            {% set ns = namespace(times=[]) %}
            {% for zone_id, zone_friendly, switch_id in switches %}
              {% set timer_dict = state_attr(switch_id, 'autoreset_time_remaining') | default({}) %}
              {% for light, secs in timer_dict.items() %}
                {% set ns.times = ns.times + [{'zone_id': zone_id, 'zone_friendly': zone_friendly, 'secs': secs | float(0)}] %}
              {% endfor %}
            {% endfor %}
            {% if ns.times | length > 0 %}
              {% set soonest_secs = (ns.times | sort(attribute='secs') | first).secs | int %}
              {{ (now().timestamp() + soonest_secs) | int }}
            {% else %}
              0
            {% endif %}
          seconds_remaining: >
            {% set switches = [
              ('main_living', 'Main Living', 'switch.adaptive_lighting_main_living'),
              ('kitchen_island', 'Kitchen', 'switch.adaptive_lighting_kitchen_island'),
              ('bedroom_primary', 'Bedroom', 'switch.adaptive_lighting_bedroom_primary'),
              ('accent_spots', 'Spots', 'switch.adaptive_lighting_accent_spots'),
              ('recessed_ceiling', 'Ceiling', 'switch.adaptive_lighting_recessed_ceiling'),
              ('column_lights', 'Columns', 'switch.adaptive_lighting_column_lights')
            ] %}
            {% set ns = namespace(times=[]) %}
            {% for zone_id, zone_friendly, switch_id in switches %}
              {% set timer_dict = state_attr(switch_id, 'autoreset_time_remaining') | default({}) %}
              {% for light, secs in timer_dict.items() %}
                {% set ns.times = ns.times + [{'zone_id': zone_id, 'zone_friendly': zone_friendly, 'secs': secs | float(0)}] %}
              {% endfor %}
            {% endfor %}
            {% if ns.times | length > 0 %}
              {{ (ns.times | sort(attribute='secs') | first).secs | int }}
            {% else %}
              0
            {% endif %}

      # -----------------------------------------------------------------------
      # 6.7 Sunrise times (Sonos alarm or sun_next_dawn fallback)
      # -----------------------------------------------------------------------
      - name: "OAL Sunrise Times"
        unique_id: oal_sunrise_times_v13
        icon: mdi:weather-sunset-up
        state: >
          {% set alarm_ts = state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_timestamp') | int(0) %}
          {% if alarm_ts > 0 %}
            {{ alarm_ts | timestamp_custom('%-I:%M %p', true) }}
          {% else %}
            {% set dawn = states('sensor.sun_next_dawn') %}
            {% if dawn not in ['unknown', 'unavailable'] %}
              {{ as_timestamp(dawn) | timestamp_custom('%-I:%M %p', true) }}
            {% else %}
              Unknown
            {% endif %}
          {% endif %}
        attributes:
          source: >
            {% set alarm_ts = state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_timestamp') | int(0) %}
            {{ 'sonos_alarm' if alarm_ts > 0 else 'sun_dawn' }}
          room: >
            {% set alarm_ts = state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_timestamp') | int(0) %}
            {% if alarm_ts > 0 %}
              {{ state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_room') | default('Unknown') }}
            {% else %}
              N/A
            {% endif %}
          hours_until: >
            {% set alarm_ts = state_attr('sensor.sonos_upcoming_alarms', 'earliest_alarm_timestamp') | int(0) %}
            {% if alarm_ts > 0 %}
              {{ ((alarm_ts - now().timestamp()) / 3600) | round(1) }}
            {% else %}
              {% set dawn = states('sensor.sun_next_dawn') %}
              {% if dawn not in ['unknown', 'unavailable'] %}
                {{ ((as_timestamp(dawn) - now().timestamp()) / 3600) | round(1) }}
              {% else %}
                null
              {% endif %}
            {% endif %}

      # -----------------------------------------------------------------------
      # 6.5 Environmental debug (for troubleshooting environmental boost)
      # -----------------------------------------------------------------------
      - name: "OAL Environmental Debug"
        unique_id: oal_environmental_debug_v13
        icon: mdi:weather-cloudy-alert
        availability: >
          {{ states('sensor.living_room_illuminance') not in ['unknown', 'unavailable']
             and states('weather.home') not in ['unknown', 'unavailable'] }}
        state: >
          {% set lux = states('sensor.living_room_illuminance') | float(500) %}
          {% set weather = states('weather.home') %}
          {% set season = 'winter' if now().month in [11, 12, 1, 2, 3] else 'summer' %}

          {# Lux boost (100% weight) #}
          {% set lux_boost = 0 %}
          {% if lux < 10 %}{% set lux_boost = 18 %}
          {% elif lux < 50 %}{% set lux_boost = 10 %}
          {% elif lux < 150 %}{% set lux_boost = 5 %}
          {% elif lux < 300 %}{% set lux_boost = 2 %}
          {% endif %}

          {# Weather boost (40% weight) #}
          {% set weather_lookup = {
            'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
            'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
            'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
          } %}
          {% set weather_boost = weather_lookup.get(weather, 0) %}

          {# Season boost (25% weight) #}
          {% set season_boost = 8 if season == 'winter' else 0 %}

          {# WEIGHTED combination #}
          {% set base_boost = lux_boost + (weather_boost * 0.4) + (season_boost * 0.25) %}

          {% set hour = now().hour %}
          {% if 22 <= hour or hour <= 6 or lux > 2500 %}
            {% set final_boost = 0 %}
          {% elif 6 < hour <= 8 or 18 <= hour < 22 %}
            {% set final_boost = base_boost * 0.7 %}
          {% else %}
            {% set final_boost = base_boost %}
          {% endif %}

          {{ [50, final_boost] | min | round(1) }}%
        attributes:
          # Input values
          lux_current: >
            {{ states('sensor.living_room_illuminance') | float(500) }}
          weather_current: >
            {{ states('weather.home') }}
          season: >
            {{ 'winter' if now().month in [11, 12, 1, 2, 3] else 'summer' }}
          hour: >
            {{ now().hour }}
          boost_enabled: >
            {{ is_state('input_boolean.oal_environmental_boost_enabled', 'on') }}

          # Raw component values (before weighting)
          lux_boost_raw: >
            {% set lux = states('sensor.living_room_illuminance') | float(500) %}
            {% if lux < 10 %} 18
            {% elif lux < 50 %} 10
            {% elif lux < 150 %} 5
            {% elif lux < 300 %} 2
            {% else %} 0
            {% endif %}
          weather_boost_raw: >
            {% set weather = states('weather.home') %}
            {% set weather_lookup = {
              'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
              'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
              'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
            } %}
            {{ weather_lookup.get(weather, 0) }}
          season_boost_raw: >
            {{ 8 if now().month in [11, 12, 1, 2, 3] else 0 }}

          # Weighted contributions
          lux_weighted: >
            {% set lux = states('sensor.living_room_illuminance') | float(500) %}
            {% if lux < 10 %}{{ 18 }}
            {% elif lux < 50 %}{{ 10 }}
            {% elif lux < 150 %}{{ 5 }}
            {% elif lux < 300 %}{{ 2 }}
            {% else %}{{ 0 }}
            {% endif %}
          weather_weighted: >
            {% set weather = states('weather.home') %}
            {% set weather_lookup = {
              'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
              'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
              'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
            } %}
            {{ (weather_lookup.get(weather, 0) * 0.4) | round(1) }}
          season_weighted: >
            {% set season_boost = 8 if now().month in [11, 12, 1, 2, 3] else 0 %}
            {{ (season_boost * 0.25) | round(1) }}
          weights_formula: "lux×1.0 + weather×0.4 + season×0.25"

          # Sunset amplifier info
          sunset_boost: >
            {{ states('input_number.oal_offset_sunset_brightness') | float(0) }}
          sunset_amplifier: >
            {% set sun = states('input_number.oal_offset_sunset_brightness') | float(0) %}
            {{ (1 + (sun / 8) * 0.5) | round(2) if sun > 0 else 1.0 }}

          # Time-based adjustments
          time_status: >
            {% set hour = now().hour %}
            {% set lux = states('sensor.living_room_illuminance') | float(500) %}
            {% if 22 <= hour or hour <= 6 %}
              Suppressed (Night: {{ hour }}:00)
            {% elif lux > 2500 %}
              Suppressed (Bright: {{ lux }} lux)
            {% elif 6 < hour <= 8 or 18 <= hour < 22 %}
              Reduced 70% (Transition hour: {{ hour }}:00)
            {% else %}
              Normal ({{ hour }}:00)
            {% endif %}

          # Final calculations
          weighted_boost_before_time: >
            {% set lux = states('sensor.living_room_illuminance') | float(500) %}
            {% set weather = states('weather.home') %}
            {% set lux_boost = 0 %}
            {% if lux < 10 %}{% set lux_boost = 18 %}
            {% elif lux < 50 %}{% set lux_boost = 10 %}
            {% elif lux < 150 %}{% set lux_boost = 5 %}
            {% elif lux < 300 %}{% set lux_boost = 2 %}
            {% endif %}
            {% set weather_lookup = {
              'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
              'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
              'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
            } %}
            {% set weather_boost = weather_lookup.get(weather, 0) %}
            {% set season_boost = 8 if now().month in [11, 12, 1, 2, 3] else 0 %}
            {{ (lux_boost + (weather_boost * 0.4) + (season_boost * 0.25)) | round(1) }}
          
          actual_applied_boost: >
            {{ states('input_number.oal_offset_environmental_brightness') | float(0) }}
          
          why_not_boosted: >
            {% if not is_state('input_boolean.oal_environmental_boost_enabled', 'on') %}
              Environmental boost is DISABLED
            {% else %}
              {% set lux = states('sensor.living_room_illuminance') | float(500) %}
              {% set hour = now().hour %}
              {% if 22 <= hour or hour <= 6 %}
                Night time suppression ({{ hour }}:00)
              {% elif lux > 2500 %}
                Too bright ({{ lux }} lux exceeds 2500)
              {% else %}
                Check lux ({{ lux }}) and weather ({{ states('weather.home') }})
              {% endif %}
            {% endif %}


# =============================================================================
# LAYER 7: DASHBOARD UI LOGIC (HERO COMPONENT HELPERS)
# =============================================================================

      # HERO BUTTON: CONFIG STATE
      # -----------------------------------------------------------------------
      - name: "Hero Button Config State"
        unique_id: hero_button_config_state
        state: >
          {% set config = states('input_select.oal_active_configuration') %}
          {% if 'Full Brightness' in config %} Baseline
          {% elif 'Dimmed Ambient' in config %} Dimmed
          {% elif 'Warm Ambient' in config %} Warm
          {% elif 'TV Mode' in config %} TV
          {% elif 'Sleep' in config %} Sleep
          {% else %} Manual {% endif %}
        attributes:
          is_baseline: >
            {{ 'Full Brightness' in states('input_select.oal_active_configuration') }}
          icon_color: >
            {% if 'Full Brightness' in states('input_select.oal_active_configuration') %} rgba(80, 80, 80, 0.5)
            {% else %} rgba(120, 80, 180, 0.9) {% endif %}
          bg_color: >
             {% if 'Full Brightness' in states('input_select.oal_active_configuration') %} rgba(120, 120, 120, 0.10)
             {% else %} rgba(138, 100, 200, 0.15) {% endif %}
          border_color: >
             {% if 'Full Brightness' in states('input_select.oal_active_configuration') %} 1px solid rgba(120, 120, 120, 0.25)
             {% else %} 1px solid rgba(138, 100, 200, 0.35) {% endif %}

      # HERO BUTTON: RESET STATE
      # -----------------------------------------------------------------------
      - name: "Hero Button Reset State"
        unique_id: hero_button_reset_state
        state: >
          {% set zones = ['switch.adaptive_lighting_main_living', 'switch.adaptive_lighting_kitchen_island', 
                          'switch.adaptive_lighting_bedroom_primary', 'switch.adaptive_lighting_accent_spots', 
                          'switch.adaptive_lighting_recessed_ceiling', 'switch.adaptive_lighting_column_lights'] %}
          {% set manual_count = namespace(value=0) %}
          {% for z in zones %}
             {% set manual_count.value = manual_count.value + (state_attr(z, 'manual_control') | default([]) | length) %}
          {% endfor %}
          {{ 'on' if manual_count.value > 0 else 'off' }}
        attributes:
          time_remaining: >
            {% set zones = ['switch.adaptive_lighting_main_living', 'switch.adaptive_lighting_kitchen_island', 
                            'switch.adaptive_lighting_bedroom_primary', 'switch.adaptive_lighting_accent_spots', 
                            'switch.adaptive_lighting_recessed_ceiling', 'switch.adaptive_lighting_column_lights'] %}
            {% set soonest = namespace(value=999999) %}
            {% for z in zones %}
              {% set timer_dict = state_attr(z, 'autoreset_time_remaining') or {} %}
              {% for k, v in timer_dict.items() %}
                {% if v|float(0) > 0 and v|float(0) < soonest.value %}
                  {% set soonest.value = v|float(0) %}
                {% endif %}
              {% endfor %}
            {% endfor %}
            
            {% if soonest.value < 999999 %}
              {% set h = (soonest.value / 3600) | int %}
              {% set m = ((soonest.value % 3600) / 60) | int %}
              {% if h > 0 %}{{ h }}h {{ m }}m{% else %}{{ m }}m{% endif %}
            {% else %}
              0m
            {% endif %}
          boost_source: >
             {{ state_attr('sensor.oal_real_time_monitor', 'Boost source') }}
          display_label: >
            {% set zones = ['switch.adaptive_lighting_main_living', 'switch.adaptive_lighting_kitchen_island', 
                            'switch.adaptive_lighting_bedroom_primary', 'switch.adaptive_lighting_accent_spots', 
                            'switch.adaptive_lighting_recessed_ceiling', 'switch.adaptive_lighting_column_lights'] %}
            {% set manual_active = this.state == 'on' %}
            {% if manual_active %}
              {{ state_attr(this.entity_id, 'time_remaining') }}
            {% else %}
              Reset
            {% endif %}

      # HERO BUTTON: ALARM STATE
      # -----------------------------------------------------------------------
      - name: "Hero Button Alarm State"
        unique_id: hero_button_alarm_state
        state: >
          {{ states('sensor.sonos_next_alarm_chip') }}
        attributes:
           formatted_time: >
             {% set time_raw = state_attr('sensor.sonos_next_alarm_chip', 'time') %}
             {% if time_raw and time_raw not in ['unknown', 'unavailable'] %}
               {% set parts = time_raw.split(':') %}
               {% if parts|length >= 2 %}
                 {% set h = parts[0]|int %}
                 {% set m = parts[1] %}
                 {% set h12 = h % 12 %}
                 {% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
                 {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
               {% else %}OFF{% endif %}
             {% else %}OFF{% endif %}
           is_enabled: >
             {% set enabled = state_attr('sensor.sonos_next_alarm_chip', 'is_enabled') %}
             {{ enabled == true or enabled == 'True' }}
           
      # HERO BUTTON: SPEAKERS STATE
      # -----------------------------------------------------------------------
      - name: "Hero Button Speakers State"
        unique_id: hero_button_speakers_state
        state: >
          {% set count = expand('binary_sensor.sonos_living_room_in_playing_group', 
                              'binary_sensor.sonos_dining_room_in_playing_group',
                              'binary_sensor.sonos_kitchen_in_playing_group',
                              'binary_sensor.sonos_bath_in_playing_group',
                              'binary_sensor.sonos_bedroom_in_playing_group') 
             | selectattr('state', 'eq', 'on') | list | length %}
          {{ count }}
        attributes:
          is_active: >
             {{ this.state | int(0) > 0 }}
          label: >
             {{ this.state }}/5

      # HERO BUTTON: ALL LIGHTS STATE
      # -----------------------------------------------------------------------
      - name: "Hero All Lights State"
        unique_id: hero_all_lights_state
        state: "{{ states('light.all_adaptive_lights') }}"
        attributes:
          # Styling attributes
          bg_color: >
            {{ 'rgba(255, 149, 0, 0.18)' if is_state('light.all_adaptive_lights', 'on')
               else 'rgba(255, 255, 255, 0.10)' }}
          border_color: >
            {{ '1px solid rgba(255, 149, 0, 0.4)' if is_state('light.all_adaptive_lights', 'on')
               else '1px solid rgba(255, 255, 255, 0.12)' }}
          icon_color: >
            {{ 'rgb(255, 149, 0)' if is_state('light.all_adaptive_lights', 'on')
               else 'rgba(80, 80, 80, 0.7)' }}
          # Counting attributes
          number_on: >
            {% set lights = expand('light.living_room_adaptive_light',
                                   'light.kitchen_island_adaptive_light',
                                   'light.bedroom_primary_adaptive_light',
                                   'light.accent_spots_adaptive_light',
                                   'light.recessed_ceiling_adaptive_light',
                                   'light.column_lights_adaptive_light') %}
            {{ lights | selectattr('state', 'eq', 'on') | list | length }}
          total_lights: 6
          all_on: >
            {% set lights = expand('light.living_room_adaptive_light',
                                   'light.kitchen_island_adaptive_light',
                                   'light.bedroom_primary_adaptive_light',
                                   'light.accent_spots_adaptive_light',
                                   'light.recessed_ceiling_adaptive_light',
                                   'light.column_lights_adaptive_light') %}
            {{ (lights | selectattr('state', 'eq', 'on') | list | length) == lights | length }} 
          all_off: >
            {% set lights = expand('light.living_room_adaptive_light',
                                   'light.kitchen_island_adaptive_light',
                                   'light.bedroom_primary_adaptive_light',
                                   'light.accent_spots_adaptive_light',
                                   'light.recessed_ceiling_adaptive_light',
                                   'light.column_lights_adaptive_light') %}
            {{ (lights | selectattr('state', 'eq', 'on') | list | length) == 0 }}
          manually_controlled: >
            {% set zones = ['switch.adaptive_lighting_main_living', 'switch.adaptive_lighting_kitchen_island', 
                            'switch.adaptive_lighting_bedroom_primary', 'switch.adaptive_lighting_accent_spots', 
                            'switch.adaptive_lighting_recessed_ceiling', 'switch.adaptive_lighting_column_lights'] %}
            {% set manual_count = namespace(value=0) %}
            {% for z in zones %}
               {% set manual_count.value = manual_count.value + (state_attr(z, 'manual_control') | default([]) | length) %}
            {% endfor %}
            {{ manual_count.value }}

      # HERO BUTTON: MEDIA/PLAY STATE
      # -----------------------------------------------------------------------
      - name: "Hero Media State"
        unique_id: hero_media_state
        state: >
          {% set players = ['media_player.living_room', 'media_player.kitchen', 
                           'media_player.bedroom', 'media_player.bath', 
                           'media_player.dining_room'] %}
          {% set playing = players | select('is_state', 'playing') | list | length > 0 %}
          {{ 'playing' if playing else 'idle' }}
        attributes:
          is_playing: >
            {{ this.state == 'playing' }}
          coordinator_entity: >
            {% set coord = states('sensor.sonos_current_playing_group_coordinator') %}
            {{ coord if coord not in ['none', 'unknown', 'unavailable'] else 'media_player.living_room' }}
          room: >
            {% set coord = states('sensor.sonos_current_playing_group_coordinator') %}
            {{ state_attr(coord, 'friendly_name') | default('Living Room') if coord not in ['none', 'unknown', 'unavailable'] else 'Living Room' }}
          media_title: >
            {% set coord = states('sensor.sonos_current_playing_group_coordinator') %}
            {{ state_attr(coord, 'media_title') | default('') if coord not in ['none', 'unknown', 'unavailable'] else '' }}
          bg_color: >
            {{ 'rgba(138, 100, 200, 0.15)' if this.state == 'playing'
               else 'rgba(120, 120, 120, 0.10)' }}
          border_color: >
            {{ '1px solid rgba(138, 100, 200, 0.35)' if this.state == 'playing'
               else '1px solid rgba(120, 120, 120, 0.25)' }}
          icon_color: >
            {{ 'rgba(120, 80, 180, 0.9)' if this.state == 'playing'
               else 'rgba(80, 80, 80, 0.5)' }}
          display_label: >
            {% set players = ['media_player.living_room', 'media_player.kitchen', 
                             'media_player.bedroom', 'media_player.bath', 
                             'media_player.dining_room'] %}
            {% set playing_players = players | select('is_state', 'playing') | list %}
            {% if playing_players | length == 0 %}
              Idle
            {% else %}
              {{ this.attributes.media_title | default('Playing') }}
            {% endif %}

      # HERO BUTTON: GLOBAL BRIGHTNESS STATE
      # -----------------------------------------------------------------------
      - name: "Hero Brightness State"
        unique_id: hero_brightness_state
        state: >
          {{ states('sensor.oal_global_brightness_offset') | int(0) }}
        unit_of_measurement: "%"
        attributes:
          display_label: >
            {% set val = states('sensor.oal_global_brightness_offset') | int(0) %}
            {% if val > 0 %}+{{ val }}%
            {% elif val < 0 %}{{ val }}%
            {% else %}0%{% endif %}
          is_modified: >
            {{ states('sensor.oal_global_brightness_offset') | int(0) != 0 }}

      # HERO BUTTON: CLIMATE STATE
      # -----------------------------------------------------------------------
      # Provides climate status for chip styling with target temp display
      # Blue for cooling, orange for heating
      # -----------------------------------------------------------------------
      - name: "Hero Climate State"
        unique_id: hero_climate_state
        icon: mdi:thermostat
        state: >
          {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
          {{ hvac }}
        attributes:
          is_active: >
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {{ hvac in ['heating', 'cooling'] }}
          is_heating: >
            {{ state_attr('climate.dining_room', 'hvac_action') == 'heating' }}
          is_cooling: >
            {{ state_attr('climate.dining_room', 'hvac_action') == 'cooling' }}
          current_temp: >
            {{ state_attr('climate.dining_room', 'current_temperature') | float(0) | round(0) }}
          target_temp: >
            {{ state_attr('climate.dining_room', 'temperature') | float(0) | round(0) }}
          target_temp_low: >
            {{ state_attr('climate.dining_room', 'target_temp_low') | default(state_attr('climate.dining_room', 'temperature')) | float(0) | round(0) }}
          target_temp_high: >
            {{ state_attr('climate.dining_room', 'target_temp_high') | default(state_attr('climate.dining_room', 'temperature')) | float(0) | round(0) }}
          display_label: >
            {% set low = state_attr('climate.dining_room', 'target_temp_low') %}
            {% set high = state_attr('climate.dining_room', 'target_temp_high') %}
            {% set target = state_attr('climate.dining_room', 'temperature') %}
            {% if low and high %}
              {{ low | round(0) }}-{{ high | round(0) }}°
            {% elif target %}
              {{ target | round(0) }}°
            {% else %}
              --°
            {% endif %}
          # Styling attributes
          bg_color: >
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if hvac == 'heating' %}rgba(255, 149, 0, 0.15)
            {% elif hvac == 'cooling' %}rgba(66, 165, 245, 0.15)
            {% else %}rgba(255, 255, 255, 0.08){% endif %}
          border_color: >
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if hvac == 'heating' %}1px solid rgba(255, 149, 0, 0.35)
            {% elif hvac == 'cooling' %}1px solid rgba(66, 165, 245, 0.35)
            {% else %}1px solid rgba(255, 255, 255, 0.12){% endif %}
          icon_color: >
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if hvac == 'heating' %}rgba(255, 152, 0, 0.96)
            {% elif hvac == 'cooling' %}rgba(66, 165, 245, 0.96)
            {% else %}rgba(200, 200, 200, 0.8){% endif %}
          text_color: >
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if hvac == 'heating' %}rgba(255, 152, 0, 0.9)
            {% elif hvac == 'cooling' %}rgba(66, 165, 245, 0.9)
            {% else %}rgba(200, 200, 200, 0.7){% endif %}

      # =========================================================================
      #  ROOM COMPOSITE STATE SENSORS
      #  Per-room intelligence with state machine, audio, lights, and styling
      # =========================================================================

      # ROOM: LIVING ROOM
      # -----------------------------------------------------------------------
      - name: "Room Living State"
        unique_id: room_living_state_v13
        icon: mdi:sofa
        state: >
          {% set lights = [
            'light.living_room_floor_lamp',
            'light.living_room_couch_lamp',
            'light.living_room_corner_accent',
            'light.living_room_credenza_light',
            'light.living_room_spot_lights',
            'light.living_room_hallway_lights',
            'light.living_col_accent'
          ] %}
          {% set lights_on = lights | select('is_state', 'on') | list | length %}
          {% set is_playing = is_state('media_player.living_room', 'playing') %}
          {% set has_override = (state_attr('switch.adaptive_lighting_main_living', 'manual_control') or []) | length > 0 %}
          
          {% if has_override %}override
          {% elif is_playing %}playing
          {% elif lights_on > 0 %}active
          {% else %}idle{% endif %}
        attributes:
          # Light status
          lights_on: >
            {% set lights = [
              'light.living_room_floor_lamp',
              'light.living_room_couch_lamp',
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.living_room_spot_lights',
              'light.living_room_hallway_lights',
              'light.living_col_accent'
            ] %}
            {{ lights | select('is_state', 'on') | list | length }}
          total_lights: 7
          brightness_avg: >
            {% set lights = [
              'light.living_room_floor_lamp',
              'light.living_room_couch_lamp',
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.living_room_spot_lights'
            ] %}
            {% set on_lights = lights | select('is_state', 'on') | list %}
            {% if on_lights | length > 0 %}
              {% set total = namespace(val=0) %}
              {% for l in on_lights %}
                {% set total.val = total.val + (state_attr(l, 'brightness') | default(0) | int) %}
              {% endfor %}
              {{ (total.val / (on_lights | length) / 2.55) | round(0) }}
            {% else %}0{% endif %}
          # Audio status
          audio_state: "{{ states('media_player.living_room') }}"
          audio_track: "{{ state_attr('media_player.living_room', 'media_title') | default('') }}"
          audio_artist: "{{ state_attr('media_player.living_room', 'media_artist') | default('') }}"
          in_group: "{{ states('sensor.sonos_living_room_in_playing_group') in ['True', 'on', true] }}"
          is_coordinator: "{{ states('sensor.sonos_current_playing_group_coordinator') == 'media_player.living_room' }}"
          # Override status - aggregated from all switches controlling living room lights
          manually_controlled_lights: >
            {% set main = state_attr('switch.adaptive_lighting_main_living', 'manual_control') | default([]) %}
            {% set spots = state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') | default([]) %}
            {% set columns = state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) %}
            {% set living_lights = [
              'light.living_room_floor_lamp',
              'light.living_room_couch_lamp', 
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.living_room_spot_lights',
              'light.living_room_hallway_lights',
              'light.living_col_accent',
              'light.entryway_lamp'
            ] %}
            {% set all_manual = (main + spots + columns) | unique | list %}
            {{ all_manual | select('in', living_lights) | list }}
          has_override: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length > 0 }}
          override_count: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length }}
          # Styling attributes
          card_background: >
            {% set state = this.state %}
            {% if state == 'override' %}linear-gradient(180deg, rgba(156,39,176,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'playing' %}linear-gradient(180deg, rgba(66,165,245,0.08) 0%, rgba(26,26,46,0.95) 100%)
            {% elif state == 'active' %}linear-gradient(180deg, rgba(255,152,0,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% if state == 'override' %}1px solid rgba(156,39,176,0.3)
            {% elif state == 'playing' %}1px solid rgba(66,165,245,0.25)
            {% elif state == 'active' %}1px solid rgba(255,152,0,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set track = state_attr('media_player.living_room', 'media_title') | default('') %}
            {% set override_count = (state_attr('switch.adaptive_lighting_main_living', 'manual_control') or []) | length %}
            {% set lights_on = this.attributes.lights_on | default(0) %}
            {% set alarm_time = this.attributes.next_alarm_time | default('None') %}
            {% if state == 'override' %}
              ✋ {{ override_count }} override{% if override_count > 1 %}s{% endif %}
            {% elif state == 'playing' %}
              🎵 {{ track[:25] }}{% if track | length > 25 %}...{% endif %}
            {% elif state == 'active' %}
              {{ lights_on }}/7 lights
            {% elif this.attributes.has_upcoming_alarm %}⏰ {{ alarm_time }}
            {% else %}Ready{% endif %}
          # Brightness offset - average of zone offsets affecting this room
          brightness_offset: >
            {% set offsets = [
              states('input_number.oal_manual_offset_main_living_brightness') | float(0),
              states('input_number.oal_manual_offset_accent_spots_brightness') | float(0),
              states('input_number.oal_manual_offset_column_lights_brightness') | float(0)
            ] %}
            {{ (offsets | sum / offsets | length) | round(0) }}
          offset_direction: >
            {% set offset = this.attributes.brightness_offset | default(0) | float(0) %}
            {% if offset > 0 %}brighter
            {% elif offset < 0 %}dimmer
            {% else %}neutral{% endif %}
          # Alarm attributes - Living Room speaker
          next_alarm_entity: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^living') | list %}
            {{ room_alarms[0].entity_id if room_alarms | length > 0 else 'none' }}
          next_alarm_time: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^living') | list %}
            {% if room_alarms | length > 0 %}
              {% set t = room_alarms[0].time.split(':') %}
              {% set h = t[0] | int %}{% set m = t[1] %}
              {% set h12 = h % 12 %}{% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
              {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
            {% else %}None{% endif %}
          next_alarm_enabled: >
            {% set entity_id = this.attributes.next_alarm_entity %}
            {{ entity_id and entity_id != 'none' and is_state(entity_id, 'on') }}
          has_upcoming_alarm: >
            {{ this.attributes.next_alarm_entity not in ['none', none, ''] }}
          total_alarms: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {{ alarms | selectattr('friendly_name', 'search', '(?i)^living') | list | length }}

      # ROOM: KITCHEN
      # -----------------------------------------------------------------------
      - name: "Room Kitchen State"
        unique_id: room_kitchen_state_v13
        icon: mdi:countertop
        state: >
          {% set is_on = is_state('light.kitchen_main_lights', 'on') %}
          {% set is_playing = is_state('media_player.kitchen', 'playing') %}
          {% set has_override = (state_attr('switch.adaptive_lighting_kitchen_island', 'manual_control') or []) | length > 0 %}
          
          {% if has_override %}override
          {% elif is_playing %}playing
          {% elif is_on %}active
          {% else %}idle{% endif %}
        attributes:
          lights_on: "{{ 1 if is_state('light.kitchen_main_lights', 'on') else 0 }}"
          total_lights: 1
          brightness: "{{ (state_attr('light.kitchen_main_lights', 'brightness') | default(0) / 2.55) | round(0) }}"
          audio_state: "{{ states('media_player.kitchen') }}"
          audio_track: "{{ state_attr('media_player.kitchen', 'media_title') | default('') }}"
          in_group: "{{ states('sensor.sonos_kitchen_in_playing_group') in ['True', 'on', true] }}"
          # Override status - aggregated from kitchen AL switch
          manually_controlled_lights: >
            {% set kitchen = state_attr('switch.adaptive_lighting_kitchen_island', 'manual_control') | default([]) %}
            {% set kitchen_lights = ['light.kitchen_main_lights', 'light.kitchen_island_pendants'] %}
            {{ kitchen | select('in', kitchen_lights) | list }}
          has_override: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length > 0 }}
          override_count: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length }}
          card_background: >
            {% set state = this.state %}
            {% if state == 'override' %}linear-gradient(180deg, rgba(156,39,176,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'playing' %}linear-gradient(180deg, rgba(66,165,245,0.08) 0%, rgba(26,26,46,0.95) 100%)
            {% elif state == 'active' %}linear-gradient(180deg, rgba(255,152,0,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% if state == 'override' %}1px solid rgba(156,39,176,0.3)
            {% elif state == 'playing' %}1px solid rgba(66,165,245,0.25)
            {% elif state == 'active' %}1px solid rgba(255,152,0,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set track = state_attr('media_player.kitchen', 'media_title') | default('') %}
            {% set alarm_time = this.attributes.next_alarm_time | default('None') %}
            {% if state == 'playing' %}🎵 {{ track[:25] }}{% if track | length > 25 %}...{% endif %}
            {% elif state == 'active' %}{{ ((state_attr('light.kitchen_main_lights', 'brightness') | default(0)) / 2.55) | round(0) }}%
            {% elif state == 'override' %}✋ Manual
            {% elif this.attributes.has_upcoming_alarm %}⏰ {{ alarm_time }}
            {% else %}Ready{% endif %}
          # Brightness offset - kitchen zone offset
          brightness_offset: >
            {{ states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) | round(0) }}
          offset_direction: >
            {% set offset = states('input_number.oal_manual_offset_kitchen_island_brightness') | float(0) %}
            {% if offset > 0 %}brighter{% elif offset < 0 %}dimmer{% else %}neutral{% endif %}
          # Alarm attributes - Kitchen speaker
          next_alarm_entity: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^kitchen') | list %}
            {{ room_alarms[0].entity_id if room_alarms | length > 0 else 'none' }}
          next_alarm_time: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^kitchen') | list %}
            {% if room_alarms | length > 0 %}
              {% set t = room_alarms[0].time.split(':') %}
              {% set h = t[0] | int %}{% set m = t[1] %}
              {% set h12 = h % 12 %}{% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
              {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
            {% else %}None{% endif %}
          next_alarm_enabled: >
            {% set entity_id = this.attributes.next_alarm_entity %}
            {{ entity_id and entity_id != 'none' and is_state(entity_id, 'on') }}
          has_upcoming_alarm: >
            {{ this.attributes.next_alarm_entity not in ['none', none, ''] }}
          total_alarms: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {{ alarms | selectattr('friendly_name', 'search', '(?i)^kitchen') | list | length }}

      # ROOM: BEDROOM
      # -----------------------------------------------------------------------
      - name: "Room Bedroom State"
        unique_id: room_bedroom_state_v13
        icon: mdi:bed
        state: >
          {% set lights = ['light.master_bedroom_table_lamps', 'light.master_bedroom_corner_accent'] %}
          {% set lights_on = lights | select('is_state', 'on') | list | length %}
          {% set is_playing = is_state('media_player.bedroom', 'playing') %}
          {% set has_override = (state_attr('switch.adaptive_lighting_bedroom_primary', 'manual_control') or []) | length > 0 %}
          
          {# Check for alarm proximity #}
          {% set alarms = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {% set has_bedroom_alarm = false %}
          {% if alarms and alarms.debug_all_alarm_entities %}
            {% set bedroom_alarms = alarms.debug_all_alarm_entities | selectattr('friendly_name', 'search', '(?i)bedroom') | list %}
            {% set has_bedroom_alarm = bedroom_alarms | length > 0 %}
          {% endif %}
          
          {% if has_bedroom_alarm %}alarm
          {% elif has_override %}override
          {% elif is_playing %}playing
          {% elif lights_on > 0 %}active
          {% else %}idle{% endif %}
        attributes:
          lights_on: >
            {% set lights = ['light.master_bedroom_table_lamps', 'light.master_bedroom_corner_accent'] %}
            {{ lights | select('is_state', 'on') | list | length }}
          total_lights: 2
          audio_state: "{{ states('media_player.bedroom') }}"
          audio_track: "{{ state_attr('media_player.bedroom', 'media_title') | default('') }}"
          in_group: "{{ states('sensor.sonos_bedroom_in_playing_group') in ['True', 'on', true] }}"
          # Override status - aggregated from bedroom AL switch
          manually_controlled_lights: >
            {% set bedroom = state_attr('switch.adaptive_lighting_bedroom_primary', 'manual_control') | default([]) %}
            {% set bedroom_lights = [
              'light.master_bedroom_table_lamps',
              'light.master_bedroom_corner_accent'
            ] %}
            {{ bedroom | select('in', bedroom_lights) | list }}
          has_override: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length > 0 }}
          override_count: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length }}
          # Brightness offset - bedroom zone offset
          brightness_offset: >
            {{ states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) | round(0) }}
          offset_direction: >
            {% set offset = states('input_number.oal_manual_offset_bedroom_primary_brightness') | float(0) %}
            {% if offset > 0 %}brighter{% elif offset < 0 %}dimmer{% else %}neutral{% endif %}
          # Enhanced alarm attributes (include Bath speaker - same room)
          next_alarm_entity: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^(bedroom|bath)') | list %}
            {{ room_alarms[0].entity_id if room_alarms | length > 0 else 'none' }}
          next_alarm_time: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^(bedroom|bath)') | list %}
            {% if room_alarms | length > 0 %}
              {% set t = room_alarms[0].time.split(':') %}
              {% set h = t[0] | int %}{% set m = t[1] %}
              {% set h12 = h % 12 %}{% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
              {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
            {% else %}None{% endif %}
          next_alarm_enabled: >
            {% set entity_id = this.attributes.next_alarm_entity %}
            {{ entity_id and entity_id != 'none' and is_state(entity_id, 'on') }}
          has_upcoming_alarm: >
            {{ this.attributes.next_alarm_entity not in ['none', none, ''] }}
          has_alarm: >
            {{ this.attributes.has_upcoming_alarm }}
          total_alarms: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {{ alarms | selectattr('friendly_name', 'search', '(?i)^(bedroom|bath)') | list | length }}
          card_background: >
            {% set state = this.state %}
            {% if state == 'alarm' %}linear-gradient(180deg, rgba(66,165,245,0.12) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'override' %}linear-gradient(180deg, rgba(156,39,176,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'playing' %}linear-gradient(180deg, rgba(66,165,245,0.08) 0%, rgba(26,26,46,0.95) 100%)
            {% elif state == 'active' %}linear-gradient(180deg, rgba(255,152,0,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% if state == 'alarm' %}2px solid rgba(66,165,245,0.4)
            {% elif state == 'override' %}1px solid rgba(156,39,176,0.3)
            {% elif state == 'playing' %}1px solid rgba(66,165,245,0.25)
            {% elif state == 'active' %}1px solid rgba(255,152,0,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set alarm_time = this.attributes.next_alarm_time | default('None') %}
            {% set track = state_attr('media_player.bedroom', 'media_title') | default('') %}
            {% if state == 'alarm' %}⏰ {{ alarm_time }}
            {% elif state == 'playing' %}🎵 {{ track[:25] }}{% if track | length > 25 %}...{% endif %}
            {% elif state == 'override' %}✋ Manual
            {% elif state == 'active' %}{{ this.attributes.lights_on }}/2 lights
            {% else %}Ready{% endif %}

      # ROOM: DINING
      # -----------------------------------------------------------------------
      - name: "Room Dining State"
        unique_id: room_dining_state_v13
        icon: mdi:table-furniture
        state: >
          {% set lights = ['light.dining_room_spot_lights', 'light.dining_col_accent'] %}
          {% set lights_on = lights | select('is_state', 'on') | list | length %}
          {% set is_playing = is_state('media_player.dining_room', 'playing') %}
          {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
          {% set has_override = (state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') or []) | length > 0 %}
          
          {% if has_override %}override
          {% elif hvac in ['heating', 'cooling'] %}climate_active
          {% elif is_playing %}playing
          {% elif lights_on > 0 %}active
          {% else %}idle{% endif %}
        attributes:
          lights_on: >
            {% set lights = ['light.dining_room_spot_lights', 'light.dining_col_accent'] %}
            {{ lights | select('is_state', 'on') | list | length }}
          total_lights: 2
          audio_state: "{{ states('media_player.dining_room') }}"
          in_group: "{{ states('sensor.sonos_dining_room_in_playing_group') in ['True', 'on', true] }}"
          # Override status - aggregated from dining room AL switches
          manually_controlled_lights: >
            {% set spots = state_attr('switch.adaptive_lighting_accent_spots', 'manual_control') | default([]) %}
            {% set columns = state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) %}
            {% set dining_lights = [
              'light.dining_room_spot_lights',
              'light.dining_col_accent'
            ] %}
            {% set all_manual = (spots + columns) | unique | list %}
            {{ all_manual | select('in', dining_lights) | list }}
          has_override: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length > 0 }}
          override_count: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length }}
          hvac_action: "{{ state_attr('climate.dining_room', 'hvac_action') | default('idle') }}"
          current_temp: "{{ state_attr('climate.dining_room', 'current_temperature') | float(0) | round(0) }}"
          target_temp: "{{ state_attr('climate.dining_room', 'temperature') | float(0) | round(0) }}"
          
          # Alarm attributes - Dining Room speaker
          next_alarm_entity: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^dining') | list %}
            {{ room_alarms[0].entity_id if room_alarms | length > 0 else 'none' }}
          next_alarm_time: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^dining') | list %}
            {% if room_alarms | length > 0 %}
              {% set t = room_alarms[0].time.split(':') %}
              {% set h = t[0] | int %}{% set m = t[1] %}
              {% set h12 = h % 12 %}{% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
              {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
            {% else %}None{% endif %}
          next_alarm_enabled: >
            {% set entity_id = this.attributes.next_alarm_entity %}
            {{ entity_id and entity_id != 'none' and is_state(entity_id, 'on') }}
          has_upcoming_alarm: >
            {{ this.attributes.next_alarm_entity not in ['none', none, ''] }}
          total_alarms: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {{ alarms | selectattr('friendly_name', 'search', '(?i)^dining') | list | length }}
          card_background: >
            {% set state = this.state %}
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if state == 'climate_active' and hvac == 'heating' %}linear-gradient(180deg, rgba(255,152,0,0.12) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'climate_active' and hvac == 'cooling' %}linear-gradient(180deg, rgba(66,165,245,0.12) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'override' %}linear-gradient(180deg, rgba(156,39,176,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'playing' %}linear-gradient(180deg, rgba(66,165,245,0.08) 0%, rgba(26,26,46,0.95) 100%)
            {% elif state == 'active' %}linear-gradient(180deg, rgba(255,152,0,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% if state == 'climate_active' and hvac == 'heating' %}1px solid rgba(255,152,0,0.35)
            {% elif state == 'climate_active' and hvac == 'cooling' %}1px solid rgba(66,165,245,0.35)
            {% elif state == 'override' %}1px solid rgba(156,39,176,0.3)
            {% elif state == 'playing' %}1px solid rgba(66,165,245,0.25)
            {% elif state == 'active' %}1px solid rgba(255,152,0,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set hvac = state_attr('climate.dining_room', 'hvac_action') | default('idle') %}
            {% set current = state_attr('climate.dining_room', 'current_temperature') | default(0) | round(0) %}
            {% set target = state_attr('climate.dining_room', 'temperature') | default(0) | round(0) %}
            {% set alarm_time = this.attributes.next_alarm_time | default('None') %}
            {% if state == 'climate_active' %}
              {% if hvac == 'heating' %}🔥 {{ current }}° → {{ target }}°
              {% else %}❄️ {{ current }}° → {{ target }}°{% endif %}
            {% elif state == 'playing' %}🎵 Playing
            {% elif state == 'override' %}✋ Manual
            {% elif this.attributes.has_upcoming_alarm %}⏰ {{ alarm_time }}
            {% elif state == 'active' %}{{ this.attributes.lights_on }}/2 lights
            {% else %}{{ current }}°{% endif %}

      # ROOM: BATHROOM
      # -----------------------------------------------------------------------
      - name: "Room Bathroom State"
        unique_id: room_bathroom_state_v13
        icon: mdi:shower-head
        state: >
          {% set is_playing = is_state('media_player.bath', 'playing') %}
          {% set in_group = states('sensor.sonos_bath_in_playing_group') in ['True', 'on', true] %}
          
          {% if is_playing %}playing
          {% elif in_group %}grouped
          {% else %}idle{% endif %}
        attributes:
          audio_state: "{{ states('media_player.bath') }}"
          audio_track: "{{ state_attr('media_player.bath', 'media_title') | default('') }}"
          in_group: "{{ states('sensor.sonos_bath_in_playing_group') in ['True', 'on', true] }}"
          humidity: "{{ states('sensor.dining_room_humidity') | default('--') }}"
          # Alarm attributes - Bath speaker
          next_alarm_entity: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^bath') | list %}
            {{ room_alarms[0].entity_id if room_alarms | length > 0 else 'none' }}
          next_alarm_time: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {% set room_alarms = alarms | selectattr('friendly_name', 'search', '(?i)^bath') | list %}
            {% if room_alarms | length > 0 %}
              {% set t = room_alarms[0].time.split(':') %}
              {% set h = t[0] | int %}{% set m = t[1] %}
              {% set h12 = h % 12 %}{% if h12 == 0 %}{% set h12 = 12 %}{% endif %}
              {{ h12 }}:{{ m }}{{ 'p' if h >= 12 else 'a' }}
            {% else %}None{% endif %}
          next_alarm_enabled: >
            {% set entity_id = this.attributes.next_alarm_entity %}
            {{ entity_id and entity_id != 'none' and is_state(entity_id, 'on') }}
          has_upcoming_alarm: >
            {{ this.attributes.next_alarm_entity not in ['none', none, ''] }}
          total_alarms: >
            {% set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
            {% set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] %}
            {{ alarms | selectattr('friendly_name', 'search', '(?i)^bath') | list | length }}
          card_background: >
            {% set state = this.state %}
            {% if state == 'playing' %}linear-gradient(180deg, rgba(66,165,245,0.08) 0%, rgba(26,26,46,0.95) 100%)
            {% elif state == 'grouped' %}linear-gradient(180deg, rgba(138,100,200,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% if state == 'playing' %}1px solid rgba(66,165,245,0.25)
            {% elif state == 'grouped' %}1px solid rgba(138,100,200,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set track = state_attr('media_player.bath', 'media_title') | default('') %}
            {% set alarm_time = this.attributes.next_alarm_time | default('None') %}
            {% if state == 'playing' %}🎵 {{ track[:25] }}{% if track | length > 25 %}...{% endif %}
            {% elif state == 'grouped' %}🔗 In group
            {% elif this.attributes.has_upcoming_alarm %}⏰ {{ alarm_time }}
            {% else %}💧 {{ states('sensor.dining_room_humidity') | default('--') }}%{% endif %}

      # ROOM: ACCENT LIGHTS (cross-room)
      # -----------------------------------------------------------------------
      - name: "Room Accent State"
        unique_id: room_accent_state_v13
        icon: mdi:lamp
        state: >
          {% set lights = [
            'light.living_room_corner_accent',
            'light.living_room_credenza_light',
            'light.dining_col_accent',
            'light.living_col_accent'
          ] %}
          {% set lights_on = lights | select('is_state', 'on') | list | length %}
          {% set has_override = (this.attributes.manually_controlled_lights | default([])) | length > 0 %}
          
          {% if has_override %}override
          {% elif lights_on > 0 %}active
          {% else %}idle{% endif %}
        attributes:
          lights_on: >
            {% set lights = [
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.dining_col_accent',
              'light.living_col_accent'
            ] %}
            {{ lights | select('is_state', 'on') | list | length }}
          total_lights: 4
          brightness_avg: >
            {% set lights = [
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.dining_col_accent',
              'light.living_col_accent'
            ] %}
            {% set on_lights = lights | select('is_state', 'on') | list %}
            {% if on_lights | length > 0 %}
              {% set total = namespace(val=0) %}
              {% for l in on_lights %}
                {% set total.val = total.val + (state_attr(l, 'brightness') | default(0) | int) %}
              {% endfor %}
              {{ (total.val / (on_lights | length) / 2.55) | round(0) }}
            {% else %}0{% endif %}
          # Override status - aggregated from main_living and column_lights switches
          manually_controlled_lights: >
            {% set main = state_attr('switch.adaptive_lighting_main_living', 'manual_control') | default([]) %}
            {% set columns = state_attr('switch.adaptive_lighting_column_lights', 'manual_control') | default([]) %}
            {% set accent_lights = [
              'light.living_room_corner_accent',
              'light.living_room_credenza_light',
              'light.dining_col_accent',
              'light.living_col_accent'
            ] %}
            {% set all_manual = (main + columns) | unique | list %}
            {{ all_manual | select('in', accent_lights) | list }}
          has_override: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length > 0 }}
          override_count: >
            {{ (this.attributes.manually_controlled_lights | default([])) | length }}
          # Styling attributes
          card_background: >
            {% set state = this.state %}
            {% if state == 'override' %}linear-gradient(180deg, rgba(156,39,176,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% elif state == 'active' %}linear-gradient(180deg, rgba(255,152,0,0.08) 0%, rgba(255,255,255,0.06) 100%)
            {% else %}rgba(255,255,255,0.06){% endif %}
          card_border: >
            {% set state = this.state %}
            {% if state == 'override' %}1px solid rgba(156,39,176,0.3)
            {% elif state == 'active' %}1px solid rgba(255,152,0,0.25)
            {% else %}1px solid rgba(255,255,255,0.08){% endif %}
          subtitle: >
            {% set state = this.state %}
            {% set override_count = (this.attributes.manually_controlled_lights | default([])) | length %}
            {% set lights_on = this.attributes.lights_on | default(0) %}
            {% if state == 'override' %}
              ✋ {{ override_count }} override{% if override_count > 1 %}s{% endif %}
            {% elif state == 'active' %}
              {{ lights_on }}/4 accents
            {% else %}Ready{% endif %}

            # GLOBAL ENVIRONMENTAL BRIGHTNESS BOOST SENSOR
      # -----------------------------------------------------------------------
      - name: "OAL Global Environmental Brightness Boost"
        unique_id: oal_global_environmental_brightness_boost
        state: >
          {% if not is_state('input_boolean.oal_environmental_boost_enabled', 'on') %}
            0
          {% endif %}
          {% set lux = states('sensor.living_room_presence_light_sensor_light_level') | float(500) %}
          {% set weather = states('weather.home') %}
          {% set season = 'winter' if now().month in [11, 12, 1, 2, 3] else 'summer' %}
          
          {% set base_boost = 0 %}
          {% if lux < 10 %} {% set base_boost = base_boost + 18 %}
          {% elif lux < 50 %} {% set base_boost = base_boost + 10 %}
          {% elif lux < 150 %} {% set base_boost = base_boost + 5 %}
          {% elif lux < 300 %} {% set base_boost = base_boost + 2 %}
          {% endif %}
          
          {% set weather_boost = {
            'fog': 20, 'pouring': 18, 'hail': 18, 'snowy': 15, 'snowy-rainy': 15,
            'rainy': 12, 'lightning-rainy': 12, 'cloudy': 10, 'lightning': 8,
            'partlycloudy': 5, 'windy': 2, 'windy-variant': 2, 'exceptional': 15
          } %}
          {% set base_boost = base_boost + weather_boost.get(weather, 0) %}
          {% if season == 'winter' %} {% set base_boost = base_boost + 8 %} {% endif %}
          
          {% set hour = now().hour %}
          {% if 22 <= hour or hour <= 6 %}
            0
          {% elif lux > 2500 %}
            0
          {% elif 6 < hour <= 8 or 18 <= hour < 22 %}
            {{ (base_boost * 0.3) | int }}
          {% else %}
            {{ base_boost | int }}
          {% endif %}