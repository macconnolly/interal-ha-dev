# Living Room Card v3
# ═══════════════════════════════════════════════════════════════════════
# v3 - Fixed popup styling, offset-aware brighten/dim, media player:
# - vertical-stack root (visual editor compatible)
# - Fixed popup: proper padding, no content cutoff
# - All Off tile: proper toggle tap_action
# - Brighten/Dim: offset-aware conditional formatting with magnitude badge
# - Added Sonos media player card with group/ungroup
# - Richer room info from sensor.room_living_state
# - Main card tiles unchanged from v2
# ═══════════════════════════════════════════════════════════════════════

type: vertical-stack
cards:
  # ═══════════════════════════════════════════════════════════════════════
  # HEADER - Room separator with alarm + gear sub-buttons
  # ═══════════════════════════════════════════════════════════════════════
  - type: custom:bubble-card
    card_type: separator
    entity: light.living_room_lights
    name: Living Room
    icon: mdi:sofa
    tap_action:
      action: perform-action
      perform_action: light.toggle
      target:
        entity_id: light.living_room_lights
    hold_action:
      action: more-info
    sub_button:
      - entity: sensor.sonos_next_alarm_chip
        icon: mdi:alarm
        show_background: false
        tap_action:
          action: perform-action
          perform_action: script.sonos_toggle_next_alarm
          data:
            alarm_entity: >-
              {{ state_attr('sensor.room_living_state', 'next_alarm_entity')
              }}
            tracker: input_text.sonos_manually_toggled_alarm_living_room
        hold_action:
          action: more-info
      - icon: mdi:cog
        show_background: false
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              content:
                type: custom:mod-card
                card_mod:
                  style: |
                    ha-card {
                      background: rgba(248, 248, 250, 0.98) !important;
                      border: none !important;
                      box-shadow: none !important;
                      padding: 0 !important;
                      overflow: visible !important;
                    }
                    @media (prefers-color-scheme: dark) {
                      ha-card {
                        background: rgba(28, 28, 30, 0.97) !important;
                      }
                    }
                card:
                  type: vertical-stack
                  cards:
                    # ─── HEADER: Title + Close ───
                    - type: custom:bubble-card
                      card_type: button
                      button_type: state
                      entity: light.living_room_lights
                      name: Living Room
                      icon: mdi:close
                      show_name: true
                      show_state: false
                      scrolling_effect: false
                      tap_action:
                        action: fire-dom-event
                        browser_mod:
                          service: browser_mod.close_popup
                      card_mod:
                        style: |
                          ha-card {
                            background: transparent !important;
                            border: none !important;
                            box-shadow: none !important;
                            overflow: visible !important;
                          }
                      styles: |-
                        ${(() => {
                          const isDark = hass.themes?.darkMode;
                          return `
                            .bubble-button-card-container {
                              display: flex !important;
                              flex-direction: row-reverse !important;
                              align-items: center !important;
                              padding: 20px 20px 4px 20px !important;
                              background: transparent !important;
                            }
                            .bubble-icon-container {
                              width: 36px !important;
                              height: 36px !important;
                              min-width: 36px !important;
                              max-width: 36px !important;
                              border-radius: 50% !important;
                              background: ${isDark ? 'rgba(255, 255, 255, 0.10)' : 'rgba(128, 128, 128, 0.12)'} !important;
                              display: flex !important;
                              align-items: center !important;
                              justify-content: center !important;
                              margin: 0 !important;
                              flex-shrink: 0 !important;
                              order: 2 !important;
                            }
                            .bubble-icon-container:active {
                              transform: scale(0.88) !important;
                            }
                            .bubble-icon {
                              --mdc-icon-size: 20px !important;
                              color: ${isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(128, 128, 128, 0.7)'} !important;
                            }
                            .bubble-name-container {
                              order: 1 !important;
                              flex: 1 !important;
                              margin: 0 !important;
                              min-width: 0 !important;
                            }
                            .bubble-name {
                              font-size: 20px !important;
                              font-weight: 700 !important;
                              letter-spacing: -0.3px !important;
                              color: ${isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(0, 0, 0, 0.90)'} !important;
                              justify-content: flex-start !important;
                              white-space: nowrap !important;
                              overflow: hidden !important;
                              text-overflow: ellipsis !important;
                            }
                            .bubble-state,
                            .bubble-attribute { display: none !important; }
                          `;
                        })()}

                    # ─── ROOM BRIGHTNESS SLIDER ───
                    - type: custom:bubble-card
                      card_type: button
                      button_type: slider
                      entity: light.living_room_lights
                      name: Room Brightness
                      icon: mdi:brightness-7
                      show_state: false
                      show_attribute: true
                      attribute: brightness
                      scrolling_effect: false
                      tap_action:
                        action: perform-action
                        perform_action: light.toggle
                        target:
                          entity_id: light.living_room_lights
                      hold_action:
                        action: more-info
                      card_mod:
                        style: |
                          ha-card {
                            background: transparent !important;
                            border: none !important;
                            box-shadow: none !important;
                            margin: 0 12px !important;
                          }

                    # ─── QUICK ACTIONS GRID (3-col) ───
                    - type: custom:layout-card
                      layout_type: custom:grid-layout
                      layout:
                        grid-template-columns: repeat(3, 1fr)
                        gap: 8px
                        padding: 4px 16px
                      cards:
                        # ── All Off / All On ──
                        - type: custom:bubble-card
                          card_type: button
                          button_type: state
                          entity: light.living_room_lights
                          name: All Off
                          icon: mdi:lightbulb-group
                          show_name: true
                          show_state: false
                          show_attribute: false
                          scrolling_effect: false
                          tap_action:
                            action: toggle
                          hold_action:
                            action: none
                          card_mod:
                            style: |
                              ha-card {
                                background: transparent !important;
                                border: none !important;
                                box-shadow: none !important;
                              }
                          styles: |-
                            ${(() => {
                              const isOn = state === 'on';
                              const isDark = hass.themes?.darkMode;
                              const lightsOn = hass.states['sensor.room_living_state']?.attributes?.lights_on || 0;
                              const tileName = isOn ? 'All Off' : 'All On';
                              const tileIcon = isOn ? 'lightbulb-group' : 'lightbulb-group-outline';
                              const attrLabel = isOn ? (lightsOn + ' on') : 'Off';
                              const surfaceOn = isDark
                                ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)'
                                : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
                              const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
                              const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
                              const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
                              const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
                              const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
                              const iconBgOn = 'rgba(255, 149, 0, 0.14)';
                              const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
                              const iconColorOn = '#ff9500';
                              const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
                              const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
                              const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
                              card.querySelector('.bubble-icon')?.setAttribute('icon', 'mdi:' + tileIcon);
                              const nameEl = card.querySelector('.bubble-name');
                              if (nameEl) nameEl.innerText = tileName;
                              return `
                                .bubble-button-card-container {
                                  position: relative !important;
                                  display: grid !important;
                                  grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important;
                                  align-items: center !important;
                                  text-align: center !important;
                                  min-height: 100px !important;
                                  aspect-ratio: 1 / 1 !important;
                                  padding: 10px 6px 8px 6px !important;
                                  border-radius: 18px !important;
                                  overflow: hidden !important;
                                  clip-path: inset(0 round 18px) !important;
                                  transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important;
                                  background: ${isOn ? surfaceOn : surfaceOff} !important;
                                  border: ${isOn ? borderOn : borderOff} !important;
                                  box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
                                }
                                .bubble-button-card-container:active { transform: scale(0.96) !important; }
                                .bubble-content-container {
                                  display: grid !important;
                                  grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important;
                                  width: 100% !important;
                                  position: relative !important;
                                  z-index: 5 !important;
                                  padding-bottom: 10px !important;
                                }
                                .bubble-icon-container {
                                  min-width: 50px !important; min-height: 50px !important;
                                  grid-row: 1 !important; margin: 0 0 4px 0 !important;
                                  border-radius: 15px !important;
                                  display: flex !important; align-items: center !important; justify-content: center !important;
                                  background: ${isOn ? iconBgOn : iconBgOff} !important;
                                  border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                                }
                                .bubble-icon {
                                  --mdc-icon-size: 24px !important;
                                  color: ${isOn ? iconColorOn : iconColorOff} !important;
                                  opacity: ${isOn ? '1' : '0.65'} !important;
                                  filter: none !important;
                                }
                                .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
                                .bubble-name {
                                  font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important;
                                  justify-content: center !important; margin: 0 2px !important;
                                  color: ${isOn ? nameOn : nameOff} !important;
                                }
                              `;
                            })()}

                        # ── Brighten (offset-aware) ──
                        - type: custom:bubble-card
                          card_type: button
                          button_type: state
                          entity: light.living_room_lights
                          name: Brighten
                          icon: mdi:weather-sunny
                          show_name: true
                          show_state: false
                          show_attribute: false
                          scrolling_effect: false
                          tap_action:
                            action: perform-action
                            perform_action: script.oal_global_manual_brighter
                            data:
                              lights: light.living_room_lights
                          hold_action:
                            action: none
                          card_mod:
                            style: >
                              ha-card { background: transparent !important;
                              border: none !important; box-shadow: none
                              !important; }
                          styles: |-
                            ${(() => {
                              const isDark = hass.themes?.darkMode;
                              const roomState = hass.states['sensor.room_living_state'];
                              const offset = parseFloat(roomState?.attributes?.brightness_offset || '0');
                              const direction = roomState?.attributes?.offset_direction || 'neutral';
                              const isActive = direction === 'brighter';
                              const badge = isActive ? '+' + Math.abs(Math.round(offset)) + '%' : '';
                              const accentColor = '#ff9500';
                              const surfaceOn = isDark
                                ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)'
                                : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
                              const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
                              const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
                              const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
                              const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
                              const nameOff = isDark ? 'rgba(255, 255, 255, 0.70)' : 'rgba(0, 0, 0, 0.55)';
                              const iconBgOff = isDark ? 'rgba(255, 149, 0, 0.08)' : 'rgba(255, 149, 0, 0.06)';
                              const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
                              const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
                              if (badge) {
                                const nameEl = card.querySelector('.bubble-name');
                                if (nameEl) nameEl.innerText = badge;
                              }
                              return `
                                .bubble-button-card-container {
                                  position: relative !important; display: grid !important;
                                  grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important; align-items: center !important; text-align: center !important;
                                  min-height: 100px !important; aspect-ratio: 1 / 1 !important;
                                  padding: 10px 6px 8px 6px !important; border-radius: 18px !important;
                                  overflow: hidden !important; clip-path: inset(0 round 18px) !important;
                                  transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important;
                                  background: ${isActive ? surfaceOn : surfaceOff} !important;
                                  border: ${isActive ? borderOn : borderOff} !important;
                                  box-shadow: ${isActive ? boxShadowOn : boxShadowOff} !important;
                                }
                                .bubble-button-card-container:active { transform: scale(0.96) !important; }
                                .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 10px !important; }
                                .bubble-icon-container {
                                  min-width: 50px !important; min-height: 50px !important; grid-row: 1 !important; margin: 0 0 4px 0 !important;
                                  border-radius: 15px !important; display: flex !important; align-items: center !important; justify-content: center !important;
                                  background: ${isActive ? 'rgba(255, 149, 0, 0.14)' : iconBgOff} !important;
                                  border: ${isActive ? '1px solid rgba(255, 149, 0, 0.18)' : '1px solid rgba(255, 149, 0, 0.10)'} !important;
                                }
                                .bubble-icon { --mdc-icon-size: 24px !important; color: ${accentColor} !important; opacity: ${isActive ? '1' : '0.65'} !important; }
                                .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
                                .bubble-name { font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important; justify-content: center !important; margin: 0 2px !important; color: ${isActive ? nameOn : nameOff} !important; }
                              `;
                            })()}

                        # ── Dim (offset-aware) ──
                        - type: custom:bubble-card
                          card_type: button
                          button_type: state
                          entity: light.living_room_lights
                          name: Dim
                          icon: mdi:weather-night
                          show_name: true
                          show_state: false
                          show_attribute: false
                          scrolling_effect: false
                          tap_action:
                            action: perform-action
                            perform_action: script.oal_global_manual_dimmer
                            data:
                              lights: light.living_room_lights
                          hold_action:
                            action: none
                          card_mod:
                            style: >
                              ha-card { background: transparent !important;
                              border: none !important; box-shadow: none
                              !important; }
                          styles: |-
                            ${(() => {
                              const isDark = hass.themes?.darkMode;
                              const roomState = hass.states['sensor.room_living_state'];
                              const offset = parseFloat(roomState?.attributes?.brightness_offset || '0');
                              const direction = roomState?.attributes?.offset_direction || 'neutral';
                              const isActive = direction === 'dimmer';
                              const badge = isActive ? Math.round(offset) + '%' : '';
                              const accentColor = '#5e5ce6';
                              const surfaceOn = isDark
                                ? 'linear-gradient(180deg, rgba(32, 30, 48, 0.95) 0%, rgba(28, 28, 40, 0.93) 100%)'
                                : 'linear-gradient(180deg, rgba(240, 240, 255, 0.97) 0%, rgba(235, 235, 250, 0.95) 100%)';
                              const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
                              const borderOn = isDark ? '1.5px solid rgba(94, 92, 230, 0.14)' : '1.5px solid rgba(94, 92, 230, 0.20)';
                              const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
                              const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
                              const nameOff = isDark ? 'rgba(255, 255, 255, 0.70)' : 'rgba(0, 0, 0, 0.55)';
                              const iconBgOff = isDark ? 'rgba(94, 92, 230, 0.08)' : 'rgba(94, 92, 230, 0.06)';
                              const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
                              const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
                              if (badge) {
                                const nameEl = card.querySelector('.bubble-name');
                                if (nameEl) nameEl.innerText = badge;
                              }
                              return `
                                .bubble-button-card-container {
                                  position: relative !important; display: grid !important;
                                  grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important; align-items: center !important; text-align: center !important;
                                  min-height: 100px !important; aspect-ratio: 1 / 1 !important;
                                  padding: 10px 6px 8px 6px !important; border-radius: 18px !important;
                                  overflow: hidden !important; clip-path: inset(0 round 18px) !important;
                                  transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important;
                                  background: ${isActive ? surfaceOn : surfaceOff} !important;
                                  border: ${isActive ? borderOn : borderOff} !important;
                                  box-shadow: ${isActive ? boxShadowOn : boxShadowOff} !important;
                                }
                                .bubble-button-card-container:active { transform: scale(0.96) !important; }
                                .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 10px !important; }
                                .bubble-icon-container {
                                  min-width: 50px !important; min-height: 50px !important; grid-row: 1 !important; margin: 0 0 4px 0 !important;
                                  border-radius: 15px !important; display: flex !important; align-items: center !important; justify-content: center !important;
                                  background: ${isActive ? 'rgba(94, 92, 230, 0.14)' : iconBgOff} !important;
                                  border: ${isActive ? '1px solid rgba(94, 92, 230, 0.18)' : '1px solid rgba(94, 92, 230, 0.10)'} !important;
                                }
                                .bubble-icon { --mdc-icon-size: 24px !important; color: ${accentColor} !important; opacity: ${isActive ? '1' : '0.65'} !important; }
                                .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
                                .bubble-name { font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important; justify-content: center !important; margin: 0 2px !important; color: ${isActive ? nameOn : nameOff} !important; }
                              `;
                            })()}

                    # ─── RESET MANUAL OVERRIDES (conditional) ───
                    - type: custom:bubble-card
                      card_type: button
                      button_type: state
                      entity: sensor.room_living_state
                      name: Reset Manual Overrides
                      icon: mdi:restore
                      show_name: true
                      show_state: false
                      scrolling_effect: false
                      tap_action:
                        action: perform-action
                        perform_action: adaptive_lighting.set_manual_control
                        data:
                          entity_id:
                            - switch.adaptive_lighting_main_living
                            - switch.adaptive_lighting_accent_spots
                            - switch.adaptive_lighting_column_lights
                            - switch.adaptive_lighting_recessed_ceiling
                          manual_control: false
                      card_mod:
                        style: >
                          ha-card { background: transparent !important;
                          border: none !important; box-shadow: none
                          !important; }
                      styles: |-
                        ${(() => {
                          const isDark = hass.themes?.darkMode;
                          const n = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).length;
                          if (n === 0) return `.bubble-button-card-container { display: none !important; }`;
                          return `
                            .bubble-button-card-container {
                              height: 48px !important; border-radius: 14px !important;
                              background: ${isDark ? 'rgba(255, 59, 48, 0.08)' : 'rgba(255, 59, 48, 0.05)'} !important;
                              border: ${isDark ? '1px solid rgba(255, 59, 48, 0.14)' : '1px solid rgba(255, 59, 48, 0.16)'} !important;
                              display: flex !important; align-items: center !important; padding: 0 16px !important; margin: 0 16px !important;
                            }
                            .bubble-button-card-container:active { transform: scale(0.97) !important; }
                            .bubble-icon-container { min-width: 32px !important; min-height: 32px !important; border-radius: 10px !important; background: rgba(255, 59, 48, 0.12) !important; display: flex !important; align-items: center !important; justify-content: center !important; }
                            .bubble-icon { --mdc-icon-size: 18px !important; color: #ff3b30 !important; }
                            .bubble-name { font-size: 14px !important; font-weight: 550 !important; color: ${isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(25, 25, 25, 0.85)'} !important; }
                            .bubble-button-card-container::after { content: '${n}' !important; position: absolute !important; right: 16px !important; min-width: 22px !important; height: 22px !important; border-radius: 11px !important; background: #ff3b30 !important; color: white !important; font-size: 11px !important; font-weight: 700 !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 6px !important; }
                          `;
                        })()}

                    # ─── SEPARATOR: Media ───
                    - type: custom:bubble-card
                      card_type: separator
                      name: Media
                      icon: ""
                      styles: |
                        .bubble-separator { margin-top: 4px !important; }
                        .bubble-name {
                          font-size: 13px !important;
                          font-weight: 600 !important;
                          text-transform: uppercase !important;
                          letter-spacing: 0.5px !important;
                          opacity: 0.4 !important;
                        }
                        .bubble-icon-container { display: none !important; }
                        .bubble-line { display: none !important; }

                    # ─── SONOS MEDIA PLAYER ───
                    - type: custom:bubble-card
                      card_type: media-player
                      entity: media_player.living_room
                      name: Living Room Sonos
                      icon: mdi:speaker-wireless
                      card_layout: large-2-rows
                      show_state: true
                      show_icon: true
                      show_name: true
                      show_last_changed: false
                      show_attribute: false
                      cover_background: true
                      hide:
                        power_button: true
                        previous_button: true
                        next_button: true
                        volume_button: false
                        play_pause_button: false
                      sub_button:
                        - name: Group All
                          icon: mdi:speaker-multiple
                          entity: media_player.living_room
                          show_state: false
                          show_background: true
                          state_background: false
                          tap_action:
                            action: call-service
                            service: script.sonos_group_all_to_playing
                        - name: Ungroup
                          icon: mdi:speaker-off
                          entity: media_player.living_room
                          show_state: false
                          show_background: true
                          state_background: false
                          tap_action:
                            action: call-service
                            service: script.sonos_ungroup_all
                      card_mod:
                        style: |
                          ha-card {
                            background: transparent !important;
                            border: none !important;
                            box-shadow: none !important;
                            margin: 0 8px !important;
                          }

                    # ─── SEPARATOR: Room Info ───
                    - type: custom:bubble-card
                      card_type: separator
                      name: Room Info
                      icon: ""
                      styles: |
                        .bubble-separator { margin-top: 4px !important; }
                        .bubble-name {
                          font-size: 13px !important;
                          font-weight: 600 !important;
                          text-transform: uppercase !important;
                          letter-spacing: 0.5px !important;
                          opacity: 0.4 !important;
                        }
                        .bubble-icon-container { display: none !important; }
                        .bubble-line { display: none !important; }

                    # ─── Lighting Mode ───
                    - type: custom:button-card
                      entity: input_select.oal_active_configuration
                      name: Lighting Mode
                      icon: mdi:lightbulb-auto
                      show_state: false
                      show_label: true
                      label: |
                        [[[ return entity.state || 'Adaptive'; ]]]
                      tap_action:
                        action: more-info
                      custom_fields:
                        value: |
                          [[[ return entity.state || 'Adaptive'; ]]]
                      styles:
                        card:
                          - background: >-
                              var(--card-background-color, rgba(0, 0, 0,
                              0.035))
                          - border: >-
                              1px solid var(--divider-color, rgba(0, 0, 0,
                              0.04))
                          - border-radius: 16px
                          - height: 52px
                          - padding: 0 16px
                          - margin: 0 12px
                          - box-shadow: none
                        grid:
                          - grid-template-areas: "\"i n value\""
                          - grid-template-columns: 32px 1fr auto
                          - grid-template-rows: 1fr
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: |
                              [[[
                                const colorMap = { 'Adaptive': '#34c759', 'Full Bright': '#ff9500', 'Dim Ambient': '#8e8e93', 'Warm Ambient': '#ff6b35', 'TV Mode': '#af52de', 'Sleep': '#5e5ce6', 'Manual': '#ff3b30' };
                                return colorMap[entity.state] || '#34c759';
                              ]]]
                        name:
                          - font-size: 14px
                          - font-weight: 550
                          - color: var(--primary-text-color)
                          - white-space: nowrap
                          - overflow: hidden
                          - text-overflow: ellipsis
                          - justify-self: start
                        label:
                          - display: none
                        custom_fields:
                          value:
                            - font-size: 13px
                            - font-weight: 600
                            - white-space: nowrap
                            - color: |
                                [[[
                                  const colorMap = { 'Adaptive': '#34c759', 'Full Bright': '#ff9500', 'Dim Ambient': '#8e8e93', 'Warm Ambient': '#ff6b35', 'TV Mode': '#af52de', 'Sleep': '#5e5ce6', 'Manual': '#ff3b30' };
                                  return colorMap[entity.state] || '#34c759';
                                ]]]

                    # ─── Lights Status ───
                    - type: custom:button-card
                      entity: sensor.room_living_state
                      name: Lights On
                      icon: mdi:lightbulb-group-outline
                      show_state: false
                      show_label: false
                      tap_action:
                        action: more-info
                      custom_fields:
                        value: |
                          [[[
                            const lightsOn = entity.attributes?.lights_on || 0;
                            const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
                            const offset = entity.attributes?.brightness_offset || 0;
                            const dir = entity.attributes?.offset_direction || 'neutral';
                            let text = lightsOn + ' / 7';
                            if (hasOverride) text += ' (manual)';
                            else if (dir === 'brighter') text += ' (+' + Math.abs(offset) + '%)';
                            else if (dir === 'dimmer') text += ' (' + offset + '%)';
                            return text;
                          ]]]
                      styles:
                        card:
                          - background: >-
                              var(--card-background-color, rgba(0, 0, 0,
                              0.035))
                          - border: >-
                              1px solid var(--divider-color, rgba(0, 0, 0,
                              0.04))
                          - border-radius: 16px
                          - height: 52px
                          - padding: 0 16px
                          - margin: 0 12px
                          - box-shadow: none
                        grid:
                          - grid-template-areas: "\"i n value\""
                          - grid-template-columns: 32px 1fr auto
                          - grid-template-rows: 1fr
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: |
                              [[[
                                const lightsOn = entity.attributes?.lights_on || 0;
                                const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
                                if (hasOverride) return '#ff3b30';
                                if (lightsOn > 0) return '#ff9500';
                                return 'var(--secondary-text-color)';
                              ]]]
                        name:
                          - font-size: 14px
                          - font-weight: 550
                          - color: var(--primary-text-color)
                          - white-space: nowrap
                          - overflow: hidden
                          - text-overflow: ellipsis
                          - justify-self: start
                        custom_fields:
                          value:
                            - font-size: 13px
                            - font-weight: 600
                            - white-space: nowrap
                            - color: |
                                [[[
                                  const lightsOn = entity.attributes?.lights_on || 0;
                                  const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
                                  if (hasOverride) return '#ff3b30';
                                  if (lightsOn > 0) return '#ff9500';
                                  return 'var(--secondary-text-color)';
                                ]]]

                    # ─── Override Info (conditional) ───
                    - type: custom:button-card
                      entity: sensor.room_living_state
                      name: Override Active
                      icon: mdi:hand-back-left
                      show_state: false
                      show_label: false
                      tap_action:
                        action: more-info
                      custom_fields:
                        value: |
                          [[[
                            const count = (entity.attributes?.manually_controlled_lights || []).length;
                            const timer = states['sensor.oal_main_living_status']?.attributes?.override_remaining_formatted || '';
                            if (count === 0) return '';
                            let text = count + ' light' + (count > 1 ? 's' : '');
                            if (timer && timer !== '0m') text += ' · resets in ' + timer;
                            return text;
                          ]]]
                      styles:
                        card:
                          - background: var(--card-background-color, rgba(0, 0, 0, 0.035))
                          - border: 1px solid rgba(255, 59, 48, 0.15)
                          - border-radius: 16px
                          - height: 52px
                          - padding: 0 16px
                          - margin: 0 12px
                          - box-shadow: none
                          - display: |
                              [[[
                                return (entity.attributes?.manually_controlled_lights || []).length > 0 ? 'flex' : 'none';
                              ]]]
                        grid:
                          - grid-template-areas: "\"i n value\""
                          - grid-template-columns: 32px 1fr auto
                          - grid-template-rows: 1fr
                          - align-items: center
                        icon:
                          - width: 18px
                          - color: "#ff3b30"
                        name:
                          - font-size: 14px
                          - font-weight: 550
                          - color: var(--primary-text-color)
                          - justify-self: start
                        custom_fields:
                          value:
                            - font-size: 13px
                            - font-weight: 600
                            - color: "#ff3b30"

                    # ─── SEPARATOR: Alarms ───
                    - type: custom:bubble-card
                      card_type: separator
                      name: Alarms
                      icon: ""
                      styles: |
                        .bubble-separator { margin-top: 4px !important; }
                        .bubble-name {
                          font-size: 13px !important;
                          font-weight: 600 !important;
                          text-transform: uppercase !important;
                          letter-spacing: 0.5px !important;
                          opacity: 0.4 !important;
                        }
                        .bubble-icon-container { display: none !important; }
                        .bubble-line { display: none !important; }

                    # ─── ALARM CARDS ───
                    - type: horizontal-stack
                      cards:
                        - type: custom:bubble-card
                          card_type: button
                          button_type: switch
                          entity: switch.sonos_alarm_520
                          name: Living Room
                          icon: mdi:alarm
                          show_state: false
                          show_attribute: true
                          attribute: recurrence
                          scrolling_effect: false
                          tap_action:
                            action: toggle
                          hold_action:
                            action: perform-action
                            perform_action: script.sonos_load_alarm_for_edit
                            data:
                              alarm_entity: switch.sonos_alarm_520
                          card_mod:
                            style: |
                              ha-card {
                                background: transparent !important;
                                border: none !important;
                                box-shadow: none !important;
                                margin: 0 4px 0 12px !important;
                              }
                          styles: |-
                            ${(() => {
                              const isOn = state === 'on';
                              const isDark = hass.themes?.darkMode;
                              const accentColor = 'rgb(10, 132, 255)';
                              const surfaceOn = isDark
                                ? 'linear-gradient(145deg, rgba(10, 60, 120, 0.25) 0%, rgba(10, 132, 255, 0.10) 100%)'
                                : 'linear-gradient(145deg, rgba(173, 216, 255, 0.25) 0%, rgba(10, 132, 255, 0.15) 100%)';
                              const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'linear-gradient(145deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04))';
                              const borderOn = isDark ? '1px solid rgba(10, 132, 255, 0.25)' : '1px solid rgba(10, 132, 255, 0.35)';
                              const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.08)' : '1px solid rgba(0,0,0,0.06)';
                              return `
                                :host { --bubble-accent-color: ${accentColor} !important; --bubble-button-background-color: transparent !important; }
                                .bubble-button-background, .bubble-button-background-color, .bubble-background { background: transparent !important; border-radius: 14px !important; }
                                .bubble-button-card-container {
                                  position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important; align-items: center !important; text-align: center !important;
                                  min-height: 100px !important; padding: 14px 8px !important; border-radius: 14px !important;
                                  overflow: hidden !important; clip-path: inset(0 round 14px) !important;
                                  transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                                  background: ${isOn ? surfaceOn : surfaceOff} !important;
                                  border: ${isOn ? borderOn : borderOff} !important;
                                }
                                .bubble-button-card-container:active { transform: scale(0.96) !important; }
                                .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; }
                                .bubble-icon-container { min-width: 42px !important; min-height: 42px !important; grid-row: 1 !important; margin: 0 0 6px 0 !important; border-radius: 13px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? 'rgba(10, 132, 255, 0.14)' : (isDark ? 'rgba(128, 128, 128, 0.10)' : 'rgba(0,0,0,0.04)')} !important; }
                                .bubble-icon { --mdc-icon-size: 22px !important; color: ${isOn ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.40)' : 'rgba(60, 60, 60, 0.45)')} !important; }
                                .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
                                .bubble-name { font-size: 13px !important; font-weight: 600 !important; justify-content: center !important; color: ${isOn ? (isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(20, 20, 20, 0.85)') : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; }
                                .bubble-attribute { font-size: 11px !important; font-weight: 500 !important; justify-content: center !important; margin-top: 2px !important; color: ${isOn ? 'rgba(10, 132, 255, 0.80)' : (isDark ? 'rgba(255, 255, 255, 0.30)' : 'rgba(60, 60, 60, 0.35)')} !important; }
                              `;
                            })()}

                        - type: custom:bubble-card
                          card_type: button
                          button_type: switch
                          entity: switch.sonos_alarm_521
                          name: Bedroom
                          icon: mdi:alarm
                          show_state: false
                          show_attribute: true
                          attribute: recurrence
                          scrolling_effect: false
                          tap_action:
                            action: toggle
                          hold_action:
                            action: perform-action
                            perform_action: script.sonos_load_alarm_for_edit
                            data:
                              alarm_entity: switch.sonos_alarm_521
                          card_mod:
                            style: |
                              ha-card {
                                background: transparent !important;
                                border: none !important;
                                box-shadow: none !important;
                                margin: 0 12px 0 4px !important;
                              }
                          styles: |-
                            ${(() => {
                              const isOn = state === 'on';
                              const isDark = hass.themes?.darkMode;
                              const accentColor = 'rgb(10, 132, 255)';
                              const surfaceOn = isDark
                                ? 'linear-gradient(145deg, rgba(10, 60, 120, 0.25) 0%, rgba(10, 132, 255, 0.10) 100%)'
                                : 'linear-gradient(145deg, rgba(173, 216, 255, 0.25) 0%, rgba(10, 132, 255, 0.15) 100%)';
                              const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'linear-gradient(145deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04))';
                              const borderOn = isDark ? '1px solid rgba(10, 132, 255, 0.25)' : '1px solid rgba(10, 132, 255, 0.35)';
                              const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.08)' : '1px solid rgba(0,0,0,0.06)';
                              return `
                                :host { --bubble-accent-color: ${accentColor} !important; --bubble-button-background-color: transparent !important; }
                                .bubble-button-background, .bubble-button-background-color, .bubble-background { background: transparent !important; border-radius: 14px !important; }
                                .bubble-button-card-container {
                                  position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important;
                                  justify-items: center !important; align-items: center !important; text-align: center !important;
                                  min-height: 100px !important; padding: 14px 8px !important; border-radius: 14px !important;
                                  overflow: hidden !important; clip-path: inset(0 round 14px) !important;
                                  transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
                                  background: ${isOn ? surfaceOn : surfaceOff} !important;
                                  border: ${isOn ? borderOn : borderOff} !important;
                                }
                                .bubble-button-card-container:active { transform: scale(0.96) !important; }
                                .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; }
                                .bubble-icon-container { min-width: 42px !important; min-height: 42px !important; grid-row: 1 !important; margin: 0 0 6px 0 !important; border-radius: 13px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? 'rgba(10, 132, 255, 0.14)' : (isDark ? 'rgba(128, 128, 128, 0.10)' : 'rgba(0,0,0,0.04)')} !important; }
                                .bubble-icon { --mdc-icon-size: 22px !important; color: ${isOn ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.40)' : 'rgba(60, 60, 60, 0.45)')} !important; }
                                .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
                                .bubble-name { font-size: 13px !important; font-weight: 600 !important; justify-content: center !important; color: ${isOn ? (isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(20, 20, 20, 0.85)') : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; }
                                .bubble-attribute { font-size: 11px !important; font-weight: 500 !important; justify-content: center !important; margin-top: 2px !important; color: ${isOn ? 'rgba(10, 132, 255, 0.80)' : (isDark ? 'rgba(255, 255, 255, 0.30)' : 'rgba(60, 60, 60, 0.35)')} !important; }
                              `;
                            })()}

              style:
                "--popup-border-radius": 24px 24px 0 0
                "--popup-padding": 0
              right_button: Close
              dismissable: true
    styles: |-
      ${(() => {
        const isDark = hass.themes?.darkMode;
        const roomState = hass.states['sensor.room_living_state']?.state || 'idle';
        const lightsOn = parseInt(hass.states['sensor.room_living_state']?.attributes?.lights_on || '0');
        const hasAlarm = hass.states['sensor.room_living_state']?.attributes?.has_upcoming_alarm === true;
        const alarmState = hass.states['sensor.hero_button_alarm_state'];
        const alarmEnabled = alarmState?.attributes?.is_enabled === true || alarmState?.attributes?.is_enabled === 'True';
        const alarmTime = alarmState?.attributes?.formatted_time || '';
        let iconColor, iconBg;
        if (roomState === 'playing') {
          iconColor = 'rgb(0, 122, 255)';
          iconBg = 'rgba(0, 122, 255, 0.18)';
        } else if (roomState === 'active' || lightsOn > 0) {
          iconColor = 'rgb(255, 149, 0)';
          iconBg = 'rgba(255, 149, 0, 0.18)';
        } else {
          iconColor = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(60, 60, 60, 0.55)';
          iconBg = isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.06)';
        }
        return `
          ha-card {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 8px 14px 0 14px !important;
          }
          .bubble-icon-container {
            min-width: 52px !important;
            min-height: 52px !important;
            border-radius: 14px !important;
            background: ${iconBg} !important;
            border: 1.5px solid ${iconColor}40 !important;
          }
          .bubble-icon {
            --mdc-icon-size: 30px !important;
            color: ${iconColor} !important;
            ${roomState !== 'idle' ? `filter: drop-shadow(0 0 4px ${iconColor}66) !important;` : ''}
          }
          .bubble-name {
            font-size: 22px !important;
            font-weight: 700 !important;
            letter-spacing: -0.3px !important;
            white-space: normal !important;
            overflow: visible !important;
            color: ${isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(25, 25, 25, 0.95)'} !important;
          }
          .bubble-sub-button-1 {
            ${!hasAlarm ? 'display: none !important;' : `
              position: relative !important;
              background: ${alarmEnabled ? 'rgba(66, 133, 244, 0.10)' : 'rgba(60, 60, 60, 0.08)'} !important;
              border: 1px solid ${alarmEnabled ? 'rgba(66, 133, 244, 0.25)' : 'rgba(60, 60, 60, 0.15)'} !important;
              min-width: 46px !important;
              overflow: visible !important;
            `}
          }
          .bubble-sub-button-1 .bubble-sub-button-icon {
            color: ${alarmEnabled ? 'rgb(66, 133, 244)' : 'rgba(60, 60, 60, 0.6)'} !important;
          }
          .bubble-sub-button-1::after {
            ${hasAlarm && alarmTime ? `
              content: '${alarmEnabled ? alarmTime : alarmTime + " OFF"}' !important;
              position: absolute !important;
              bottom: 1px !important;
              right: 3px !important;
              font-size: 7px !important;
              font-weight: 600 !important;
              color: ${alarmEnabled ? 'rgba(66, 133, 244, 0.9)' : 'rgba(60, 60, 60, 0.5)'} !important;
              white-space: nowrap !important;
            ` : ''}
          }
          .bubble-sub-button-2 .bubble-sub-button-icon {
            color: ${isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.55)'} !important;
          }
        `;
      })()}

  # ═══════════════════════════════════════════════════════════════════════
  # LIGHTS GRID - 6 lights in 3 columns (unchanged from v2)
  # ═══════════════════════════════════════════════════════════════════════
  - type: custom:layout-card
    layout_type: custom:grid-layout
    layout:
      grid-template-columns: repeat(3, 1fr)
      gap: 8px
      padding: 2px 12px 4px 12px
      mediaquery:
        "(max-width: 400px)":
          grid-template-columns: repeat(2, 1fr)
    cards:
      # Note: Light tiles are identical to v2. For brevity, use the same
      # tile definitions from living-rooom-v2.yaml lines 1065-1547.
      # Each tile is a bubble-card button with button_type: slider,
      # state-aware dark/light mode styling, manual control dot indicator,
      # and bottom slider bar. Copy tiles for:
      # 1. Floor Lamp (light.living_room_floor_lamp)
      # 2. Couch (light.living_room_couch_lamp)
      # 3. Corner (light.living_room_corner_accent)
      # 4. Credenza (light.living_room_credenza_light)
      # 5. Spots (light.living_room_spot_lights)
      # 6. Columns (light.living_column_strip_light_matter)
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_floor_lamp
        name: Floor
        icon: mdi:floor-lamp
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_floor_lamp
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_main_living']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.includes('light.living_room_floor_lamp');
            const brightness = hass.states['light.living_room_floor_lamp']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_couch_lamp
        name: Couch
        icon: mdi:lamp
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_couch_lamp
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_main_living']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.includes('light.living_room_couch_lamp');
            const brightness = hass.states['light.living_room_couch_lamp']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_corner_accent
        name: Corner
        icon: mdi:floor-lamp-torchiere
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_corner_accent
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_main_living']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.includes('light.living_room_corner_accent');
            const brightness = hass.states['light.living_room_corner_accent']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_credenza_light
        name: Credenza
        icon: mdi:television-ambient-light
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_credenza_light
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_main_living']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.includes('light.living_room_credenza_light');
            const brightness = hass.states['light.living_room_credenza_light']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_spot_lights
        name: Spots
        icon: mdi:wall-sconce-flat
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_spot_lights
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_accent_spots']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.includes('light.living_room_spot_lights');
            const brightness = hass.states['light.living_room_spot_lights']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_column_strip_light_matter
        name: Columns
        icon: mdi:pillar
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_column_strip_light_matter
          data:
            brightness_pct: 100
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const manualLights = hass.states['switch.adaptive_lighting_column_lights']?.attributes?.manual_control || [];
            const isManual = Array.isArray(manualLights) && manualLights.length > 0;
            const brightness = hass.states['light.living_column_strip_light_matter']?.attributes?.brightness || 0;
            const brightnessPct = Math.round((brightness / 255) * 100);
            const brightnessLabel = isOn ? `${brightnessPct}%` : 'Off';
            const fillColor = isManual ? '#ff9500' : '#e8a000';
            const surfaceOn = isDark ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)' : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const attrOn = isDark ? 'rgba(255, 149, 0, 0.85)' : '#d97b00';
            const attrOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(0, 0, 0, 0.32)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important;
                border-radius: 18px !important;
                overflow: hidden !important;
                clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, border-color 0.2s ease, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container.is-dragging {
                border: 1.5px solid rgba(255, 149, 0, 0.45) !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 8px !important;
                right: 8px !important;
                width: ${isManual ? '7px' : '0px'} !important;
                height: ${isManual ? '7px' : '0px'} !important;
                border-radius: 50% !important;
                background: ${isManual ? 'rgb(255, 59, 48)' : 'transparent'} !important;
                border: ${isManual ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important;
                box-shadow: ${isManual ? '0 0 4px rgba(255, 59, 48, 0.5)' : 'none'} !important;
                transition: all 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-icon-container {
                min-width: 50px !important;
                min-height: 50px !important;
                grid-row: 1 !important;
                margin: 0 0 4px 0 !important;
                border-radius: 15px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn ? iconBgOn : iconBgOff} !important;
                border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important;
                transition: opacity 0.25s ease, background 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 24px !important;
                color: ${isOn ? iconColorOn : iconColorOff} !important;
                opacity: ${isOn ? '1' : '0.65'} !important;
                filter: none !important;
                transition: opacity 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 15px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                margin: 0 2px !important;
                color: ${isOn ? nameOn : nameOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-attribute {
                font-size: 0 !important;
                font-weight: 500 !important;
                margin-top: 1px !important;
                justify-content: center !important;
              }
              .bubble-attribute::after {
                content: '${brightnessLabel}' !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                font-variant-numeric: tabular-nums !important;
                color: ${isOn ? attrOn : attrOff} !important;
                transition: color 0.25s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 18px 18px !important;
                z-index: 10 !important;
                background: ${sliderTrack} !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                border-radius: 0 2px 0 0 !important;
                background: ${fillColor} !important;
                transition: width 0.3s ease !important;
              }
              .bubble-button-card-container.is-dragging .bubble-range-fill {
                transition: width 0.04s linear !important;
              }
              .bubble-range-value {
                position: absolute !important;
                top: unset !important;
                right: unset !important;
                bottom: 58px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                color: ${fillColor} !important;
                background: ${tooltipBg} !important;
                padding: 2px 8px !important;
                border-radius: 8px !important;
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                white-space: nowrap !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-attribute {
                opacity: 0 !important;
              }
            `;
          })()}

  # ═══════════════════════════════════════════════════════════════════════
  # MEDIA GRID - Sonos + Apple TV + Samsung (unchanged from v2)
  # ═══════════════════════════════════════════════════════════════════════
  - type: custom:layout-card
    layout_type: custom:grid-layout
    layout:
      grid-template-columns: 1.4fr 0.8fr 0.8fr
      gap: 6px
      padding: 2px 12px 4px 12px
      mediaquery:
        "(max-width: 400px)":
          grid-template-columns: repeat(2, 1fr)
    cards:
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: media_player.living_room
        name: Sonos
        icon: mdi:speaker
        show_state: false
        show_attribute: true
        attribute: volume_level
        scrolling_effect: false
        tap_action:
          action: perform-action
          perform_action: media_player.media_play_pause
          target:
            entity_id: media_player.living_room
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: script.sonos_toggle_group_membership
          data:
            target_speaker: media_player.living_room
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const inGroup = hass.states['binary_sensor.sonos_living_room_in_playing_group']?.state === 'on';
            const isDark = hass.themes?.darkMode;
            const accentColor = 'rgb(0, 122, 255)';
            const surfaceOn = isDark ? 'rgba(0, 122, 255, 0.14)' : 'rgba(0, 122, 255, 0.10)';
            const surfaceOff = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.9)';
            const borderOn = isDark ? '1px solid rgba(0, 122, 255, 0.30)' : '1px solid rgba(0, 122, 255, 0.35)';
            const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.12)' : '1px solid rgba(0, 0, 0, 0.08)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(20, 20, 20, 0.95)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(40, 40, 40, 0.55)';
            const textOff = isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(60, 60, 60, 0.45)';
            const sliderTrack = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(0, 0, 0, 0.04)';
            const tooltipBg = isDark ? 'rgba(30, 30, 32, 0.92)' : 'rgba(255, 255, 255, 0.92)';
            return `.bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr auto !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; padding: 8px 4px 8px 4px !important; border-radius: 14px !important; overflow: hidden !important; clip-path: inset(0 round 14px) !important; transition: transform 0.15s ease-out, border-color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease !important; background: ${inGroup ? surfaceOn : surfaceOff} !important; backdrop-filter: ${inGroup ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; -webkit-backdrop-filter: ${inGroup ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; border: ${inGroup ? borderOn : borderOff} !important; box-shadow: ${inGroup ? '0 2px 10px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.04)' : '0 1px 4px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.03)'} !important; } .bubble-button-card-container:active { transform: scale(0.95) !important; } .bubble-button-card-container::after { content: '' !important; position: absolute !important; top: 5px !important; right: 5px !important; width: ${inGroup ? '7px' : '0px'} !important; height: ${inGroup ? '7px' : '0px'} !important; border-radius: 50% !important; background: ${inGroup ? accentColor : 'transparent'} !important; border: ${inGroup ? '1.5px solid rgba(255, 255, 255, 0.9)' : 'none'} !important; box-shadow: ${inGroup ? '0 0 4px rgba(0, 122, 255, 0.5)' : 'none'} !important; transition: all 0.2s ease !important; z-index: 25 !important; } .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 8px !important; } .bubble-icon-container { min-width: 36px !important; min-height: 36px !important; grid-row: 1 !important; margin: 1px 0 2px 0 !important; border-radius: 11px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${inGroup ? 'rgba(0, 122, 255, 0.14)' : (isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)')} !important; border: ${inGroup ? '1.5px solid rgba(0, 122, 255, 0.25)' : (isDark ? '1.5px solid rgba(255, 255, 255, 0.12)' : '1.5px solid rgba(0, 0, 0, 0.08)')} !important; backdrop-filter: blur(4px) !important; -webkit-backdrop-filter: blur(4px) !important; transition: background 0.3s ease, border-color 0.3s ease !important; } .bubble-icon { --mdc-icon-size: 24px !important; color: ${inGroup ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; filter: ${inGroup ? 'drop-shadow(0 0 6px rgba(0, 122, 255, 0.45))' : 'none'} !important; transition: color 0.3s ease, filter 0.3s ease !important; } .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; } .bubble-name { font-weight: 650 !important; font-size: 14px !important; line-height: 1.2 !important; justify-content: center !important; color: ${inGroup ? nameOn : nameOff} !important; } .bubble-state { font-size: 13px !important; font-weight: 600 !important; margin-top: 1px !important; justify-content: center !important; color: ${inGroup ? accentColor : textOff} !important; } .bubble-attribute { font-size: 13px !important; font-weight: 600 !important; margin-top: 1px !important; justify-content: center !important; color: ${inGroup ? accentColor : textOff} !important; transition: opacity 0.15s ease !important; } .bubble-range-slider { position: absolute !important; bottom: 0 !important; left: 0 !important; right: 0 !important; width: 100% !important; height: 4px !important; border-radius: 0 0 14px 14px !important; z-index: 10 !important; background: ${sliderTrack} !important; overflow: visible !important; opacity: 1 !important; } .bubble-range-fill { height: 4px !important; border-radius: 0 0 14px 0 !important; background: ${accentColor} !important; } .bubble-range-value { position: absolute !important; top: unset !important; right: unset !important; bottom: 50px !important; left: 50% !important; transform: translateX(-50%) !important; font-size: 14px !important; font-weight: 700 !important; color: ${accentColor} !important; background: ${tooltipBg} !important; padding: 2px 8px !important; border-radius: 8px !important; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.35) !important; opacity: 0 !important; pointer-events: none !important; transition: opacity 0.15s ease !important; z-index: 30 !important; white-space: nowrap !important; } .is-dragging .bubble-range-value { opacity: 1 !important; } .is-dragging .bubble-attribute { opacity: 0 !important; } .is-dragging .bubble-state { opacity: 0 !important; }`;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: media_player.living_room_apple_tv
        name: Apple TV
        icon: mdi:apple
        show_state: false
        tap_action:
          action: perform-action
          perform_action: media_player.media_play_pause
          target:
            entity_id: media_player.living_room_apple_tv
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isPlaying = hass.states['media_player.living_room_apple_tv']?.state === 'playing';
            const isDark = hass.themes?.darkMode;
            const accentColor = 'rgb(0, 122, 255)';
            const surfaceOn = isDark ? 'rgba(0, 122, 255, 0.14)' : 'rgba(0, 122, 255, 0.10)';
            const surfaceOff = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.9)';
            const borderOn = isDark ? '1px solid rgba(0, 122, 255, 0.30)' : '1px solid rgba(0, 122, 255, 0.35)';
            const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.12)' : '1px solid rgba(0, 0, 0, 0.08)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(20, 20, 20, 0.95)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(40, 40, 40, 0.55)';
            return `.bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr auto !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; padding: 8px 4px 8px 4px !important; border-radius: 14px !important; overflow: hidden !important; clip-path: inset(0 round 14px) !important; transition: transform 0.15s ease-out, border-color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease !important; background: ${isPlaying ? surfaceOn : surfaceOff} !important; backdrop-filter: ${isPlaying ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; -webkit-backdrop-filter: ${isPlaying ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; border: ${isPlaying ? borderOn : borderOff} !important; box-shadow: ${isPlaying ? '0 2px 10px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.04)' : '0 1px 4px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.03)'} !important; } .bubble-button-card-container:active { transform: scale(0.95) !important; } .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 8px !important; } .bubble-icon-container { min-width: 36px !important; min-height: 36px !important; grid-row: 1 !important; margin: 1px 0 2px 0 !important; border-radius: 11px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isPlaying ? 'rgba(0, 122, 255, 0.14)' : (isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)')} !important; border: ${isPlaying ? '1.5px solid rgba(0, 122, 255, 0.25)' : (isDark ? '1.5px solid rgba(255, 255, 255, 0.12)' : '1.5px solid rgba(0, 0, 0, 0.08)')} !important; backdrop-filter: blur(4px) !important; -webkit-backdrop-filter: blur(4px) !important; transition: background 0.3s ease, border-color 0.3s ease !important; } .bubble-icon { --mdc-icon-size: 24px !important; color: ${isPlaying ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; filter: ${isPlaying ? 'drop-shadow(0 0 6px rgba(0, 122, 255, 0.45))' : 'none'} !important; transition: color 0.3s ease, filter 0.3s ease !important; } .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; } .bubble-name { font-weight: 650 !important; font-size: 14px !important; line-height: 1.2 !important; justify-content: center !important; color: ${isPlaying ? nameOn : nameOff} !important; }`;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: media_player.living_room_samsung_q60
        name: Samsung
        icon: mdi:television
        show_state: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = hass.states['media_player.living_room_samsung_q60']?.state === 'on';
            const isDark = hass.themes?.darkMode;
            const accentColor = 'rgb(168, 85, 247)';
            const surfaceOn = isDark ? 'rgba(168, 85, 247, 0.14)' : 'rgba(168, 85, 247, 0.10)';
            const surfaceOff = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.9)';
            const borderOn = isDark ? '1px solid rgba(168, 85, 247, 0.30)' : '1px solid rgba(168, 85, 247, 0.35)';
            const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.12)' : '1px solid rgba(0, 0, 0, 0.08)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(20, 20, 20, 0.95)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(40, 40, 40, 0.55)';
            return `.bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr auto !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; padding: 8px 4px 8px 4px !important; border-radius: 14px !important; overflow: hidden !important; clip-path: inset(0 round 14px) !important; transition: transform 0.15s ease-out, border-color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease !important; background: ${isOn ? surfaceOn : surfaceOff} !important; backdrop-filter: ${isOn ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; -webkit-backdrop-filter: ${isOn ? 'blur(12px) saturate(140%)' : 'blur(8px) saturate(110%)'} !important; border: ${isOn ? borderOn : borderOff} !important; box-shadow: ${isOn ? '0 2px 10px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.04)' : '0 1px 4px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.03)'} !important; } .bubble-button-card-container:active { transform: scale(0.95) !important; } .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 8px !important; } .bubble-icon-container { min-width: 36px !important; min-height: 36px !important; grid-row: 1 !important; margin: 1px 0 2px 0 !important; border-radius: 11px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? 'rgba(168, 85, 247, 0.14)' : (isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)')} !important; border: ${isOn ? '1.5px solid rgba(168, 85, 247, 0.25)' : (isDark ? '1.5px solid rgba(255, 255, 255, 0.12)' : '1.5px solid rgba(0, 0, 0, 0.08)')} !important; backdrop-filter: blur(4px) !important; -webkit-backdrop-filter: blur(4px) !important; transition: background 0.3s ease, border-color 0.3s ease !important; } .bubble-icon { --mdc-icon-size: 24px !important; color: ${isOn ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; filter: ${isOn ? 'drop-shadow(0 0 6px rgba(168, 85, 247, 0.45))' : 'none'} !important; transition: color 0.3s ease, filter 0.3s ease !important; } .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; } .bubble-name { font-weight: 650 !important; font-size: 14px !important; line-height: 1.2 !important; justify-content: center !important; color: ${isOn ? nameOn : nameOff} !important; }`;
          })()}
