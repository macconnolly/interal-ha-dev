###############################################################################
#  Sonos & Apple TV Multimedia Control Package                                #
#  Uses Script + Helpers for Sonos Alarm Info Calculation (User Version)      #
#  Includes Apple TV Idle Timeout                                             #
#  Uses Event Trigger for Sonos Alarm Updates                                 #
#  FIXED: Corrected variable definitions in debug/disable scripts             #
#  FIXED: Corrected Apple TV automation conditions                            #
#  FIXED: Removed confusing debug message line                                #
#  UPDATED: Default display entity ID                                         #
#  FIXED: Corrected 'today' undefined error in debug_sonos_alarms script      #
#  FIXED: Corrected final summary logic in debug_sonos_alarms script          #
#  FIXED: Corrected variable definition in evening_alarm_check_notification   #
#  SIMPLIFIED: evening_alarm_check_notification to check only soonest alarm   #
#  FIXED: Corrected attribute access in disable_tomorrows_sonos_alarms        #
#  FIXED: Coordinator sensor now finds largest playing group via group_members[0]
#  FIXED: Binary sensors handle empty/invalid coordinator states properly     #
#  FIXED: Typo 'deault' â†’ 'default' in template                               #
#  FIXED: Changed '| count' to '| length' (count counts chars, not items)     #
#  FIXED: Empty string split bug in alarms_to_reenable ('' â†’ [''] not [])     #
#  FIXED: confirm_actions built dynamically (conditions can't be in actions)  #
#  UPDATED: Scripts use sonos_alarms_for_tomorrow (tomorrow only, not today)  #
#  ADDED: Per-room alarm tracker input_texts (living, kitchen, bedroom)       #
#  ADDED: alarm_entity and tracker params to sonos_toggle_next_alarm script   #
###############################################################################

# The soonest-alarm helpers and their update script are now deprecated and replaced by the centralized sensor.
# All scripts now use 'sensor.sonos_alarms_for_tomorrow' for tomorrow's alarm logic.
# See the 'Sonos Alarms for Tomorrow' sensor for all relevant attributes and debug info.
# All alarm-identification logic is now centralized for maintainability and robustness.

############################
#  USER HELPERS            #
############################
input_select:
  sonos_group_selector:
    name: Sonos group selector
    options:
      - Select room
      - Living
      - Dining
      - Kitchen
      - Bath
      - Bedroom
input_boolean:
  # Sonos Helpers
  sonos_auto_group_enabled:
    name: Sonos Auto-Group Enabled
    icon: mdi:account-music
    initial: true

  sonos_alarm_notifications:
    name: Sonos Alarm Notifications Enabled
    icon: mdi:bell-ring-outline
    initial: on

  # Apple TV Helpers
  apple_tv_no_auto_off:
    name: Apple TV - Prevent Auto Off
    icon: mdi:television-pause
    initial: false

input_number:
  sonos_default_volume:
    name: Sonos Default Volume
    icon: mdi:volume-medium
    min: 0
    max: 1
    step: 0.05
    unit_of_measurement: "vol"
    mode: slider

input_text:
  # Shared helper for push notifications
  notify_target_device_id:
    name: Device-ID for Multimedia Pushes
    icon: mdi:cellphone
    mode: text # Ensure mode is text
    initial: a09d6105c2e90cc42e7264679d34b17a  #  <-- REPLACE with your phone's ID

  # DEPRECATED: soonest_sonos_alarm_entity_id helper is no longer needed.
  # soonest_sonos_alarm_entity_id:
  #   name: Soonest Sonos Alarm Entity ID
  #   icon: mdi:identifier
  #   initial: "None"

  # NEW: Apple TV entity ID helpers (configurable)
  apple_tv_entity_id:
    name: Apple TV Entity ID
    icon: mdi:apple
    initial: media_player.living_room_apple_tv
    mode: text

  apple_tv_display_entity_id:
    name: Apple TV Display Entity ID
    icon: mdi:television
    initial: media_player.living_room_samsung_q60 # UPDATED Default
    mode: text

  # NEW: Helper to store disabled Sonos alarms for re-enabling later
  sonos_alarms_disabled_for_tomorrow:
    name: Sonos Alarms Disabled for Tomorrow
    icon: mdi:alarm-off
    mode: text
    initial: ""

  # Store the last manually toggled alarm entity_id for chip functionality (global)
  sonos_manually_toggled_alarm:
    name: Sonos Manually Toggled Alarm
    icon: mdi:alarm-check
    mode: text
    initial: ""

  # Per-room alarm toggle tracking
  sonos_manually_toggled_alarm_living_room:
    name: Sonos Manually Toggled Alarm - Living Room
    icon: mdi:alarm-off
    mode: text
    initial: ""

  sonos_manually_toggled_alarm_kitchen:
    name: Sonos Manually Toggled Alarm - Kitchen
    icon: mdi:alarm-off
    mode: text
    initial: ""

  sonos_manually_toggled_alarm_bedroom:
    name: Sonos Manually Toggled Alarm - Bedroom
    icon: mdi:alarm-off
    mode: text
    initial: ""

############################

input_datetime:
  apple_tv_last_playing:
    name: Apple TV Last Playing
    has_date: true
    has_time: true

#  SPEAKER GROUP           #
############################
group:
  sonos_all:
    name: All Sonos Speakers
    entities:
      - media_player.living_room
      - media_player.dining_room
      - media_player.kitchen
      - media_player.bath
      - media_player.bedroom



############################
#  TEMPLATE SENSORS        #
############################
template:
  sensor:
    - name: "Sonos Alarms for Tomorrow"
      unique_id: sonos_alarms_for_tomorrow
      icon: mdi:alarm-multiple
      state: >
        {{ state_attr('sensor.sonos_alarms_for_tomorrow', 'alarm_count') | default(0) }} alarm(s) scheduled for tomorrow.
      attributes:
        all_alarms_data: >
          {%- set tomorrow_date_obj = (now() + timedelta(days=1)).date() -%}
          {%- set ns = namespace(collected_alarms_for_tomorrow = []) -%}
          {%- set now_dt = now() -%}

          {# Iterate through Sonos alarm switches that are 'on' and have a 'time' attribute (lowercase) #}
          {%- for alarm_entity in states.switch
              | selectattr('entity_id','search','sonos_alarm_')
              | selectattr('state','eq','on') -%}
            {%- set time_str = alarm_entity.attributes.get('time') -%}
            {%- if not time_str %}{% continue %}{% endif -%}

            {%- set recurrence = (alarm_entity.attributes.get('recurrence') | default('DAILY')) | upper -%}
            {%- set base_time = today_at(time_str) -%}

            {# Check recurrence for up to 7 days ahead #}
            {%- for i in range(7) -%}
              {%- set check_datetime = base_time + timedelta(days=i) -%}
              {%- set weekday_sonos = check_datetime.isoweekday() % 7 -%} {# 0=Sun, 1=Mon, ..., 6=Sat #}
              {%- set day_matches_recurrence = false -%}

              {%- if recurrence == 'DAILY' %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence == 'WEEKDAYS' and 1 <= weekday_sonos <= 5 %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence == 'WEEKENDS' and (weekday_sonos == 0 or weekday_sonos == 6) %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence.startswith('ON_') -%}
                {%- set days_in_recurrence = recurrence.split('_',1)[1] -%}
                {%- if weekday_sonos|string in days_in_recurrence %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- endif -%}

              {# If the alarm is scheduled for this checked day and is in the future #}
              {%- if day_matches_recurrence and check_datetime > now_dt -%}
                {# If this checked day is tomorrow #}
                {%- if check_datetime.date() == tomorrow_date_obj -%}
                  {%- set existing_entity_ids = ns.collected_alarms_for_tomorrow | map(attribute='entity_id') | list -%}
                  {%- if alarm_entity.entity_id not in existing_entity_ids -%}
                    {%- set alarm_item = {
                        'entity_id': alarm_entity.entity_id,
                        'time': time_str,
                        'friendly_name': alarm_entity.attributes.get('friendly_name') | default(alarm_entity.name),
                        'timestamp': check_datetime.timestamp(),
                        'room': area_name(alarm_entity.entity_id) | default('Unknown')
                    } -%}
                    {%- set ns.collected_alarms_for_tomorrow = ns.collected_alarms_for_tomorrow + [alarm_item] -%}
                  {%- endif -%}
                  {# Only break if we found a match for tomorrow #}
                  {%- break -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%} {# End of i in range(7) loop #}
          {%- endfor -%} {# End of alarm_entity loop #}

          {# Post-loop processing #}
          {%- set sorted_alarms = ns.collected_alarms_for_tomorrow | sort(attribute='timestamp') -%}

          {%- set earliest_alarm_item = (sorted_alarms | first) if sorted_alarms else none -%}
          {%- set earliest_ts = earliest_alarm_item.timestamp if earliest_alarm_item else none -%}
          {%- set earliest_dt_local = as_datetime(earliest_ts) if earliest_ts is not none else none %}

          {%- set output_data = {
              'alarm_count': sorted_alarms | length,
              'alarm_entities': sorted_alarms | map(attribute='entity_id') | list,
              'friendly_names': sorted_alarms | map(attribute='friendly_name') | list,
              'rooms': sorted_alarms | map(attribute='room') | unique | list,
              'earliest_alarm_timestamp_tomorrow': earliest_ts,
              'earliest_alarm_time_tomorrow': as_local(as_datetime(earliest_ts)).strftime('%H:%M:%S') if earliest_ts is not none else 'None',
              'raw_alarm_list_sorted': sorted_alarms,
              'debug_tomorrow_date_obj': tomorrow_date_obj.isoformat(),
              'debug_processing_time_utc': now().isoformat()
          } -%}
          {{- output_data -}}
        alarm_count: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('alarm_count', 0) if data is mapping else 0 }}
        alarm_entities: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('alarm_entities', []) if data is mapping else [] }}
        friendly_names: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('friendly_names', []) if data is mapping else [] }}
        earliest_alarm_time_tomorrow: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('earliest_alarm_time_tomorrow', 'None') if data is mapping else 'None' }}
        earliest_alarm_timestamp_tomorrow: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('earliest_alarm_timestamp_tomorrow', none) if data is mapping else none }}
        debug_info: >
          {% set all_data_dict = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {% set output_dict = {} %}
          {% if all_data_dict is mapping %}
            {% set output_dict = {
                'retrieved_alarm_count': all_data_dict.get('alarm_count', 'Error: key missing'),
                'retrieved_earliest_time': all_data_dict.get('earliest_alarm_time_tomorrow', 'Error: key missing'),
                'retrieved_entities_sample': (all_data_dict.get('alarm_entities', []) | list | first) if (all_data_dict.get('alarm_entities', []) | list | length > 0) else 'No entities',
                'all_alarms_data_is_map': true,
                'all_alarms_data_keys': all_data_dict.keys() | list,
                'current_sensor_state': states('sensor.sonos_alarms_for_tomorrow')
               } %}
          {% else %}
            {% set output_dict = {
                'retrieved_alarm_count': 'Error: all_alarms_data not a map',
                'retrieved_earliest_time': 'Error',
                'retrieved_entities_sample': 'Error',
                'all_alarms_data_is_map': false,
                'current_sensor_state': states('sensor.sonos_alarms_for_tomorrow')
               } %}
          {% endif %}
          {{ output_dict | to_json }}
        rooms: >
          {% set data = state_attr('sensor.sonos_alarms_for_tomorrow', 'all_alarms_data') %}
          {{ data.get('rooms', []) if data is mapping else [] }}

    - name: "Sonos Upcoming Alarms"
      unique_id: sonos_upcoming_alarms
      icon: mdi:alarm-multiple
      state: >
        {{ state_attr('sensor.sonos_upcoming_alarms', 'alarm_count') | default(0) }} upcoming alarm(s).
      attributes:
        all_alarms_data: >
          {%- set today_date_obj = now().date() -%}
          {%- set tomorrow_date_obj = (now() + timedelta(days=1)).date() -%}
          {%- set ns = namespace(collected_alarms = []) -%}
          {%- set now_dt = now() -%}

          {# DEBUG: Collect all sonos_alarm_ entities and their attributes for troubleshooting #}
          {%- set debug_alarm_entities = states.switch
              | selectattr('entity_id','search','sonos_alarm_')
              | map(attribute='attributes')
              | list -%}

          {# Iterate through Sonos alarm switches that have a 'time' attribute and are enabled #}
          {%- for alarm_entity in states.switch
              | selectattr('entity_id','search','sonos_alarm_')
              | selectattr('state','eq','on') -%}
            {%- set time_str = alarm_entity.attributes.get('time') -%}
            {%- if not time_str %}{% continue %}{% endif -%}

            {%- set recurrence = (alarm_entity.attributes.get('recurrence') | default('DAILY')) | upper -%}
            {%- set base_time = today_at(time_str) -%}

            {# Check recurrence for today and tomorrow only #}
            {%- for i in range(2) -%}
              {%- set check_datetime = base_time + timedelta(days=i) -%}
              {%- set weekday_sonos = check_datetime.isoweekday() % 7 -%} {# 0=Sun, 1=Mon, ..., 6=Sat #}
              {%- set day_matches_recurrence = false -%}

              {%- if recurrence == 'DAILY' %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence == 'WEEKDAYS' and 1 <= weekday_sonos <= 5 %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence == 'WEEKENDS' and (weekday_sonos == 0 or weekday_sonos == 6) %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- if recurrence.startswith('ON_') -%}
                {%- set days_in_recurrence = recurrence.split('_',1)[1] -%}
                {%- if weekday_sonos|string in days_in_recurrence %}{% set day_matches_recurrence = true %}{% endif -%}
              {%- endif -%}

              {# If the alarm is scheduled for this checked day and is in the future #}
              {%- if day_matches_recurrence and check_datetime > now_dt -%}
                {%- set alarm_item = {
                    'entity_id': alarm_entity.entity_id,
                    'time': time_str,
                    'friendly_name': alarm_entity.attributes.get('friendly_name') | default(alarm_entity.name),
                    'timestamp': check_datetime.timestamp(),
                    'date': check_datetime.date().isoformat(),
                    'recurrence': recurrence,
                    'room': area_name(alarm_entity.entity_id) | default('Unknown')
                } -%}
                {%- set ns.collected_alarms = ns.collected_alarms + [alarm_item] -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}

          {# Post-loop processing #}
          {%- set sorted_alarms = ns.collected_alarms | sort(attribute='timestamp') -%}
          {%- set earliest_alarm_item = (sorted_alarms | first) if sorted_alarms else none -%}
          {%- set earliest_ts = earliest_alarm_item.timestamp if earliest_alarm_item else none -%}
          {%- set earliest_dt_local = as_datetime(earliest_ts) if earliest_ts is not none else none %}

          {%- set output_data = {
              'alarm_count': sorted_alarms | length,
              'alarm_entities': sorted_alarms | map(attribute='entity_id') | list,
              'friendly_names': sorted_alarms | map(attribute='friendly_name') | list,
              'rooms': sorted_alarms | map(attribute='room') | unique | list,
              'earliest_alarm_timestamp': earliest_ts,
              'earliest_alarm_time': earliest_dt_local.strftime('%Y-%m-%d %H:%M:%S') if earliest_dt_local else 'None',
              'raw_alarm_list_sorted': sorted_alarms,
              'debug_today_date_obj': today_date_obj.isoformat(),
              'debug_tomorrow_date_obj': tomorrow_date_obj.isoformat(),
              'debug_processing_time_utc': now().isoformat(),
              'debug_all_alarm_entities': debug_alarm_entities
          } -%}
          {{- output_data -}}
        alarm_count: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('alarm_count', 0) if data is mapping else 0 }}
        alarm_entities: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('alarm_entities', []) if data is mapping else [] }}
        friendly_names: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('friendly_names', []) if data is mapping else [] }}
        earliest_alarm_time: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('earliest_alarm_time', 'None') if data is mapping else 'None' }}
        earliest_alarm_timestamp: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('earliest_alarm_timestamp', none) if data is mapping else none }}
        earliest_alarm_room: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {% set alarms = data.get('raw_alarm_list_sorted', []) if data is mapping else [] %}
          {{ alarms[0].room if alarms | length > 0 and alarms[0] is mapping else 'Unknown' }}
        rooms: >
          {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {{ data.get('rooms', []) if data is mapping else [] }}
        debug_info: >
          {% set all_data_dict = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
          {% set output_dict = {} %}
          {% if all_data_dict is mapping %}
            {% set output_dict = {
                'retrieved_alarm_count': all_data_dict.get('alarm_count', 'Error: key missing'),
                'retrieved_earliest_time': all_data_dict.get('earliest_alarm_time', 'Error: key missing'),
                'retrieved_entities_sample': (all_data_dict.get('alarm_entities', []) | list | first) if (all_data_dict.get('alarm_entities', []) | list | length > 0) else 'No entities',
                'all_alarms_data_is_map': true,
                'all_alarms_data_keys': all_data_dict.keys() | list,
                'current_sensor_state': states('sensor.sonos_upcoming_alarms')
               } %}
          {% else %}
            {% set output_dict = {
                'retrieved_alarm_count': 'Error: all_alarms_data not a map',
                'retrieved_earliest_time': 'Error',
                'retrieved_entities_sample': 'Error',
                'all_alarms_data_is_map': false,
                'current_sensor_state': states('sensor.sonos_upcoming_alarms')
               } %}
          {% endif %}
          {{ output_dict | to_json }}

    - name: "Soonest Sonos Alarm Info"
      unique_id: soonest_sonos_alarm_info
      icon: mdi:alarm
      state: >
        {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
        {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
        {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
        {{ soonest.time if soonest is mapping and 'time' in soonest else 'unknown' }}
      attributes:
        entity_id: >
          {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
          {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
          {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
          {{ soonest.entity_id if soonest is mapping and 'entity_id' in soonest else none }}
        friendly_name: >
          {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
          {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
          {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
          {{ soonest.friendly_name if soonest is mapping and 'friendly_name' in soonest else 'Soonest Sonos Alarm Info' }}
        room: >
          {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
          {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
          {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
          {{ soonest.room if soonest is mapping and 'room' in soonest else 'Unknown' }}
        timestamp: >
          {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
          {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
          {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
          {{ soonest.timestamp if soonest is mapping and 'timestamp' in soonest else none }}
        debug_info: >
          {%- set all_data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') | default({}, true) -%}
          {%- set alarms = all_data.get('raw_alarm_list_sorted', []) if all_data is mapping else [] -%}
          {%- set soonest = alarms[0] if alarms|length > 0 else none -%}
          {{ soonest | to_json if soonest is mapping else '{}' }}

    # -----------------------------------------------------------------------
    # Next Alarm Chip Status - for dashboard toggle chip
    # Shows the next alarm time and whether it's enabled/disabled
    # -----------------------------------------------------------------------
    - name: "Sonos Next Alarm Chip"
      unique_id: sonos_next_alarm_chip
      icon: >
        {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
        {% if entity_id and states(entity_id) == 'on' %}
          mdi:alarm
        {% elif entity_id and states(entity_id) == 'off' %}
          mdi:alarm-off
        {% else %}
          mdi:alarm-note-off
        {% endif %}
      state: >
        {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
        {% set time_str = states('sensor.soonest_sonos_alarm_info') %}
        {% if entity_id and time_str not in ['unknown', 'unavailable', ''] %}
          {% if states(entity_id) == 'on' %}
            {{ time_str }}
          {% else %}
            Off
          {% endif %}
        {% else %}
          None
        {% endif %}
      attributes:
        entity_id: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') }}
        is_enabled: >
          {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
          {{ entity_id and states(entity_id) == 'on' }}
        time: >
          {{ states('sensor.soonest_sonos_alarm_info') }}
        room: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'room') | default('Unknown') }}
        friendly_name: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'friendly_name') | default('No alarm') }}
        timestamp: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'timestamp') }}
        hours_until: >
          {% set ts = state_attr('sensor.soonest_sonos_alarm_info', 'timestamp') %}
          {% if ts %}
            {{ ((ts - now().timestamp()) / 3600) | round(1) }}
          {% else %}
            0
          {% endif %}
        was_manually_disabled: >
          {% set toggled = states('input_text.sonos_manually_toggled_alarm') %}
          {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
          {{ toggled == entity_id and entity_id and states(entity_id) == 'off' }}
        display_text: >
          {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
          {% set time_str = states('sensor.soonest_sonos_alarm_info') %}
          {% set room = state_attr('sensor.soonest_sonos_alarm_info', 'room') | default('') %}
          {% if entity_id and time_str not in ['unknown', 'unavailable', ''] %}
            {% if states(entity_id) == 'on' %}
              â° {{ time_str }}{% if room %} ({{ room }}){% endif %}
            {% else %}
              ðŸ”• {{ time_str }} OFF
            {% endif %}
          {% else %}
            No alarms
          {% endif %}

    # ------------------------------------------------------------------
    # Sonos Current Playing Group Coordinator
    # Returns the coordinator of the LARGEST playing group
    # Coordinator is always group_members[0] in Sonos
    # ------------------------------------------------------------------
    - name: "Sonos Current Playing Group Coordinator"
      unique_id: sonos_current_playing_group
      icon: mdi:speaker-multiple
      state: >-
        {% set speakers = [
          'media_player.living_room',
          'media_player.kitchen',
          'media_player.bedroom',
          'media_player.bath',
          'media_player.dining_room'
        ] %}
        {% set playing = speakers | select('is_state', 'playing') | list %}
        {% if playing | length == 0 %}
          none
        {% else %}
          {% set ns = namespace(best_coord='none', best_size=0) %}
          {% for speaker in playing %}
            {% set members = state_attr(speaker, 'group_members') or [] %}
            {% if members | length > ns.best_size %}
              {% set ns.best_coord = members[0] %}
              {% set ns.best_size = members | length %}
            {% endif %}
          {% endfor %}
          {{ ns.best_coord if ns.best_coord != 'none' else playing[0] }}
        {% endif %}
      attributes:
        playing_state: >
          {% set coord = this.state %}
          {{ states(coord) if coord and coord != 'none' else 'idle' }}
        media_title: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'media_title') | default('', true) if coord and coord != 'none' else '' }}
        media_artist: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'media_artist') | default('', true) if coord and coord != 'none' else '' }}
        source: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'source') | default('', true) if coord and coord != 'none' else '' }}
        room: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'friendly_name') | default('', true) if coord and coord != 'none' else '' }}
        volume: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'volume_level') | float(0) if coord and coord != 'none' else 0 }}
        group_members: >
          {% set coord = this.state %}
          {{ state_attr(coord, 'group_members') | default([], true) if coord and coord != 'none' else [] }}

    - name: "Sonos Living Room Group Label"
      unique_id: sonos_living_room_group_label
      icon: mdi:account-multiple-outline
      state: >
        {% set group = state_attr('media_player.living_room', 'group_members') or [] %}
        {% if group | length <= 1 %}
          Not grouped
        {% else %}
          {% set others = group | reject('eq', 'media_player.living_room') | list %}
          {% set names = expand(others) | map(attribute='name') | list %}
          In group with: {{ names | join(', ') }}
        {% endif %}

    - name: "Sonos Dining Room Group Label"
      unique_id: sonos_dining_room_group_label
      icon: mdi:account-multiple-outline
      state: >
        {% set group = state_attr('media_player.dining_room', 'group_members') or [] %}
        {% if group | length <= 1 %}
          Not grouped
        {% else %}
          {% set others = group | reject('eq', 'media_player.dining_room') | list %}
          {% set names = expand(others) | map(attribute='name') | list %}
          In group with: {{ names | join(', ') }}
        {% endif %}

    - name: "Sonos Kitchen Group Label"
      unique_id: sonos_kitchen_group_label
      icon: mdi:account-multiple-outline
      state: >
        {% set group = state_attr('media_player.kitchen', 'group_members') or [] %}
        {% if group | length <= 1 %}
          Not grouped
        {% else %}
          {% set others = group | reject('eq', 'media_player.kitchen') | list %}
          {% set names = expand(others) | map(attribute='name') | list %}
          In group with: {{ names | join(', ') }}
        {% endif %}

    - name: "Sonos Bath Group Label"
      unique_id: sonos_bath_group_label
      icon: mdi:account-multiple-outline
      state: >
        {% set group = state_attr('media_player.bath', 'group_members') or [] %}
        {% if group | length <= 1 %}
          Not grouped
        {% else %}
          {% set others = group | reject('eq', 'media_player.bath') | list %}
          {% set names = expand(others) | map(attribute='name') | list %}
          In group with: {{ names | join(', ') }}
        {% endif %}

    - name: "Sonos Bedroom Group Label"
      unique_id: sonos_bedroom_group_label
      icon: mdi:account-multiple-outline
      state: >
        {% set group = state_attr('media_player.bedroom', 'group_members') or [] %}
        {% if group | length <= 1 %}
          Not grouped
        {% else %}
          {% set others = group | reject('eq', 'media_player.bedroom') | list %}
          {% set names = expand(others) | map(attribute='name') | list %}
          In group with: {{ names | join(', ') }}
        {% endif %}

  binary_sensor:
    - name: "Sonos Living Room In Playing Group"
      unique_id: sonos_living_room_in_playing_group
      icon: mdi:speaker
      state: >
        {% set target = 'media_player.living_room' %}
        {% set main_group = states('sensor.sonos_current_playing_group_coordinator') %}
        {% if not main_group or main_group in ['none', 'unknown', 'unavailable', ''] %}
          false
        {% else %}
          {% set members = state_attr(main_group, 'group_members') or [] %}
          {{ target in members }}
        {% endif %}

    - name: "Sonos Dining Room In Playing Group"
      unique_id: sonos_dining_room_in_playing_group
      icon: mdi:speaker
      state: >
        {% set target = 'media_player.dining_room' %}
        {% set main_group = states('sensor.sonos_current_playing_group_coordinator') %}
        {% if not main_group or main_group in ['none', 'unknown', 'unavailable', ''] %}
          false
        {% else %}
          {% set members = state_attr(main_group, 'group_members') or [] %}
          {{ target in members }}
        {% endif %}

    - name: "Sonos Kitchen In Playing Group"
      unique_id: sonos_kitchen_in_playing_group
      icon: mdi:speaker
      state: >
        {% set target = 'media_player.kitchen' %}
        {% set main_group = states('sensor.sonos_current_playing_group_coordinator') %}
        {% if not main_group or main_group in ['none', 'unknown', 'unavailable', ''] %}
          false
        {% else %}
          {% set members = state_attr(main_group, 'group_members') or [] %}
          {{ target in members }}
        {% endif %}

    - name: "Sonos Bath In Playing Group"
      unique_id: sonos_bath_in_playing_group
      icon: mdi:speaker
      state: >
        {% set target = 'media_player.bath' %}
        {% set main_group = states('sensor.sonos_current_playing_group_coordinator') %}
        {% if not main_group or main_group in ['none', 'unknown', 'unavailable', ''] %}
          false
        {% else %}
          {% set members = state_attr(main_group, 'group_members') or [] %}
          {{ target in members }}
        {% endif %}

    - name: "Sonos Bedroom In Playing Group"
      unique_id: sonos_bedroom_in_playing_group
      icon: mdi:speaker
      state: >
        {% set target = 'media_player.bedroom' %}
        {% set main_group = states('sensor.sonos_current_playing_group_coordinator') %}
        {% if not main_group or main_group in ['none', 'unknown', 'unavailable', ''] %}
          false
        {% else %}
          {% set members = state_attr(main_group, 'group_members') or [] %}
          {{ target in members }}
        {% endif %}

    # ------------------------------------------------------------------
    # Sonos Playing Status (for OAL dashboard)
    # Uses explicit speaker list for reliability
    # ------------------------------------------------------------------
    - name: "Sonos Playing Status"
      unique_id: sonos_playing_status
      icon: mdi:speaker-multiple
      state: >
        {% set speakers = {
          'media_player.living_room': 'Living',
          'media_player.kitchen': 'Kitchen',
          'media_player.bedroom': 'Bedroom',
          'media_player.bath': 'Bath',
          'media_player.dining_room': 'Dining'
        } %}
        {% set playing = namespace(rooms=[]) %}
        {% for entity_id, name in speakers.items() %}
          {% if is_state(entity_id, 'playing') %}
            {% set playing.rooms = playing.rooms + [name] %}
          {% endif %}
        {% endfor %}
        {% if playing.rooms | length == 0 %}
          Off
        {% elif playing.rooms | length == 1 %}
          {{ playing.rooms[0] }}
        {% else %}
          {{ playing.rooms | length }} rooms
        {% endif %}
      attributes:
        playing_rooms: >
          {% set speakers = [
            'media_player.living_room',
            'media_player.kitchen',
            'media_player.bedroom',
            'media_player.bath',
            'media_player.dining_room'
          ] %}
          {% set playing = namespace(rooms=[]) %}
          {% for entity_id in speakers %}
            {% if is_state(entity_id, 'playing') %}
              {% set playing.rooms = playing.rooms + [entity_id] %}
            {% endif %}
          {% endfor %}
          {{ playing.rooms }}
        is_playing: >
          {{ is_state('media_player.living_room', 'playing')
             or is_state('media_player.kitchen', 'playing')
             or is_state('media_player.bedroom', 'playing')
             or is_state('media_player.bath', 'playing')
             or is_state('media_player.dining_room', 'playing') }}

############################
#  SCRIPTS                 #
############################

script:
  sonos_toggle_group_membership:
    alias: Sonos - Toggle Room In Current Group (with fallback)
    mode: queued
    fields:
      target_speaker:
        description: Sonos speaker to toggle
        example: media_player.kitchen
    sequence:
      # Validate target_speaker before proceeding
      - condition: template
        value_template: >-
          {{ target_speaker is defined and
             target_speaker | string | trim not in ['', 'none', 'None', 'unknown', 'unavailable'] and
             (target_speaker | string | trim).startswith('media_player.') }}
      - variables:
          fallback_hub: "media_player.living_room"
          target_speaker: "{{ target_speaker }}"
          playing_group: "{{ states('sensor.sonos_current_playing_group_coordinator') }}"

          # Step 1 â€“ decide the hub candidate (playing coordinator or LR)
          hub_candidate: >-
            {% if playing_group not in ['none', 'unknown', 'unavailable', ''] %}
              {{ playing_group }}
            {% else %}
              {{ fallback_hub }}
            {% endif %}

          # Step 2 â€“ from the hub candidate, derive the real coordinator
          # If the candidate is in a Sonos group, coordinator is group_members[0]; else the candidate itself
          hub_members_raw: >-
            {% set m = state_attr(hub_candidate, 'group_members') %}
            {{ m if m is not none else [hub_candidate] }}
          main_group_coordinator: >-
            {{ hub_members_raw[0] if hub_members_raw | length > 0 else hub_candidate }}

          # Step 3 â€“ group membership snapshot for the coordinator's group
          main_group_members: >-
            {% set members = state_attr(main_group_coordinator, 'group_members') %}
            {{ members if members is not none else [main_group_coordinator] }}

      - choose:
          # Case 1: target is already in the main group and the group has >1 member â†’ unjoin just that room
          - conditions:
              - condition: template
                value_template: >
                  {{ target_speaker in main_group_members and (main_group_members | length) > 1 }}
            sequence:
              - service: media_player.unjoin
                target:
                  entity_id: "{{ target_speaker }}"
              - service: logbook.log
                data:
                  name: "Sonos toggle"
                  message: >-
                    Unjoin {{ target_speaker }} from {{ main_group_coordinator }}.
                    Members before: {{ main_group_members }}

          # Case 2: target is in the main group but is the only member â†’ no-op
          - conditions:
              - condition: template
                value_template: >
                  {{ target_speaker in main_group_members and (main_group_members | length) == 1 }}
            sequence:
              - service: logbook.log
                data:
                  name: "Sonos toggle"
                  message: >-
                    No-op for {{ target_speaker }} â€“ only member in {{ main_group_coordinator }}.
                    Members before: {{ main_group_members }}

        # Case 3 (default): target is not in the main group â†’ join it
        default:
          - service: media_player.join
            target:
              entity_id: "{{ main_group_coordinator }}"
            data:
              group_members: >-
                {% set new_members = (main_group_members + [target_speaker]) | unique | list %}
                {{ new_members }}
          - service: logbook.log
            data:
              name: "Sonos toggle"
              message: >-
                Join {{ target_speaker }} to {{ main_group_coordinator }}.
                Members before: {{ main_group_members }}
              
  sonos_group_all_to_playing:
    alias: Sonos - Group all to current playing or Living Room hub
    mode: single
    sequence:
      - variables:
          fallback_hub: "media_player.living_room"
          playing_group: "{{ states('sensor.sonos_current_playing_group_coordinator') }}"
          all_speakers:
            - media_player.living_room
            - media_player.dining_room
            - media_player.kitchen
            - media_player.bath
            - media_player.bedroom

          # Same hub/coord logic as toggle, for consistency
          hub_candidate: >-
            {% if playing_group not in ['none', 'unknown', 'unavailable', ''] %}
              {{ playing_group }}
            {% else %}
              {{ fallback_hub }}
            {% endif %}
          hub_members_raw: >-
            {% set m = state_attr(hub_candidate, 'group_members') %}
            {{ m if m is not none else [hub_candidate] }}
          main_group_coordinator: >-
            {{ hub_members_raw[0] if hub_members_raw | length > 0 else hub_candidate }}
          main_group_members_before: >-
            {% set members = state_attr(main_group_coordinator, 'group_members') %}
            {{ members if members is not none else [main_group_coordinator] }}

      - service: media_player.join
        target:
          entity_id: "{{ main_group_coordinator }}"
        data:
          group_members: "{{ all_speakers }}"

      - service: logbook.log
        data:
          name: "Sonos group-all"
          message: >-
            Group all speakers to {{ main_group_coordinator }}.
            Members before: {{ main_group_members_before }}.
            All speakers: {{ all_speakers }}



  # 4) Ungroup all speakers
  sonos_ungroup_all:
    alias: Sonos - Ungroup All Speakers
    mode: single
    sequence:
      - service: media_player.unjoin
        target:
          entity_id:
            - media_player.living_room
            - media_player.dining_room
            - media_player.kitchen
            - media_player.bath
            - media_player.bedroom

  # 5) Pause all speakers
  sonos_all_pause:
    alias: Sonos - Pause All Speakers
    mode: single
    sequence:
      - service: media_player.media_pause
        target:
          entity_id:
            - media_player.living_room
            - media_player.dining_room
            - media_player.kitchen
            - media_player.bath
            - media_player.bedroom


  confirmable_notification:
    alias: Generic Confirmable Notification
    mode: parallel # Allows multiple notifications to be handled concurrently
    icon: mdi:message-alert-outline
    fields:
      notify_device:
        description: "The target notification device ID. Defaults to input_text.notify_target_device_id if not provided or invalid."
        example: "mobile_app_your_device_id"
      title:
        description: "The title of the notification."
        example: "Confirm Action"
      message:
        description: "The main message body of the notification."
        example: "Do you want to proceed?"
      confirm_text:
        description: "Text for the confirmation button."
        example: "Yes, Proceed"
      confirm_actions:
        description: "A list of actions (service calls) to perform on confirmation."
        example: |
          - service: light.turn_on
            target:
              entity_id: light.living_room
      dismiss_text:
        description: "Text for the dismissal button."
        example: "No, Cancel"
      dismiss_actions:
        description: "A list of actions (service calls) to perform on dismissal (optional)."
        example: |
          - service: script.log_dismissal
      timeout_actions:
        description: "A list of actions (service calls) to perform on timeout (optional)."
        example: |
          - service: system_log.write
            data:
              message: "Notification timed out by script."
      timeout_seconds:
        description: "Timeout in seconds to wait for a response."
        example: 3600
        default: 3600 # Default to 1 hour
      notification_tag:
        description: "Optional tag for the notification (e.g., for replacing or clearing)."
        example: "confirm_power_off"
    sequence:
      - variables:
          action_confirm_event: "{{ 'CONFIRM_EVENT_' ~ context.id }}"
          action_dismiss_event: "{{ 'DISMISS_EVENT_' ~ context.id }}"
          effective_notify_device: >
            {% if notify_device is defined and notify_device not in ['', none, 'unavailable', 'unknown'] %}
              {{ notify_device }}
            {% else %}
              {{ states('input_text.notify_target_device_id') }}
            {% endif %}
          effective_tag: >
            {% if notification_tag is defined and notification_tag | string | length > 0 %}
              {{ notification_tag }}
            {% else %}
              {{ 'confirmable_notification_' ~ context.id.split('.')[0] }}
            {% endif %}

      - condition: template
        value_template: "{{ effective_notify_device not in ['', none, 'unavailable', 'unknown'] }}"
        alias: "Check if target device ID is valid"

      - service: notify.notify
        data:
          title: "{{ title }}"
          message: "{{ message }}"
          data:
            tag: "{{ effective_tag }}"
            actions:
              - action: "{{ action_confirm_event }}"
                title: "{{ confirm_text }}"
              - action: "{{ action_dismiss_event }}"
                title: "{{ dismiss_text }}"

      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_confirm_event }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_dismiss_event }}"
        timeout:
          seconds: "{{ timeout_seconds }}"
        continue_on_timeout: true

      - choose:
          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == action_confirm_event }}"
            alias: "User confirmed"
            sequence:
              - repeat:
                  for_each: "{{ confirm_actions | default([]) }}"
                  sequence:
                    - service: "{{ repeat.item.service }}"
                      data: "{{ repeat.item.data | default({}) }}"
                      target: "{{ repeat.item.target | default({}) }}"
              - service: notify.notify
                data:
                  message: "Confirmed: {{ title }}."
                  data:
                    tag: "{{ effective_tag }}_receipt"

          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == action_dismiss_event }}"
            alias: "User dismissed"
            sequence:
              - repeat:
                  for_each: "{{ dismiss_actions | default([]) }}"
                  sequence:
                    - service: "{{ repeat.item.service }}"
                      data: "{{ repeat.item.data | default({}) }}"
                      target: "{{ repeat.item.target | default({}) }}"
              - service: notify.notify
                data:
                  message: "Dismissed: {{ title }}."
                  data:
                    tag: "{{ effective_tag }}_receipt"
        default: # Timeout
          - service: system_log.write
            data:
              message: "Confirmable notification '{{ title }}' timed out. Tag: {{ effective_tag }}"
              level: warning
          - repeat:
              for_each: "{{ timeout_actions | default([]) }}"
              sequence:
                - service: "{{ repeat.item.service }}"
                  data: "{{ repeat.item.data | default({}) }}"
                  target: "{{ repeat.item.target | default({}) }}"

  # --- Debug Sonos Alarms (Removed: now fully centralized in sensor) ---
  # debug_sonos_alarms script has been removed; use the centralized sensor for all alarm debug info.

  # --- Calculate Soonest Alarm and Update Helpers ---
  # DEPRECATED: update_soonest_sonos_alarm_info script is no longer needed.
  # update_soonest_sonos_alarm_info:
  #   alias: Update Soonest Sonos Alarm Info Helpers
  #   icon: mdi:alarm-sync
  #   mode: single
  #   sequence:
  #     - variables:
  #         debug_lines: "Debug output temporarily disabled for update_soonest_sonos_alarm_info."
  #         soonest_entity_id: "" # Placeholder
  #         next_alarm_date: "{{ now().strftime('%Y-%m-%d') }}" # Placeholder
  #         next_alarm_time: "00:00:00" # Placeholder
  #     - service: persistent_notification.create
  #       data:
  #         title: Sonos Alarm Debug (Update Script - TEMPORARILY SIMPLIFIED)
  #         message: "{{ debug_lines }}" 
  #         notification_id: sonos_alarm_update_debug_simplified
  #     - choose:
  #         - conditions:
  #             - condition: template # This will likely be false with placeholder
  #               value_template: "{{ soonest_entity_id | length > 0 }}" 
  #           sequence:
  #             - service: input_datetime.set_datetime
  #               target:
  #                 entity_id: input_datetime.soonest_sonos_alarm_timestamp
  #               data:
  #                 date: "{{ next_alarm_date }}" 
  #                 time: "{{ next_alarm_time }}" 
  #             - service: input_text.set_value
  #               target:
  #                 entity_id: input_text.soonest_sonos_alarm_entity_id
  #               data:
  #                 value: "{{ soonest_entity_id }}"
  #       default: # This will likely always run with placeholders
  #         - service: input_text.set_value
  #           target:
  #             entity_id: input_text.soonest_sonos_alarm_entity_id
  #           data:
  #             value: "None (update_soonest_sonos_alarm_info is simplified)"
  #         - service: input_datetime.set_datetime
  #           target:
  #             entity_id: input_datetime.soonest_sonos_alarm_timestamp
  #           data:
  #             date: "{{ now().strftime('%Y-%m-%d') }}"
  #             time: "00:00:01" 

  # --- Group all speakers and set baseline volume --------------------------
  # Using version from user-provided working script
  sonos_group_all_speakers_old:
    alias: Sonos Group All Speakers
    mode: single
    icon: mdi:speaker-multiple
    sequence:
      - condition: state
        entity_id: input_boolean.sonos_auto_group_enabled
        state: "on"
      - variables:
          master: >
            {{ expand('group.sonos_all') | selectattr('state','ne','unavailable') | map(attribute='entity_id') | first | default(none) }}
      - choose:
          - conditions: "{{ master != none }}"
            sequence:
              - service: media_player.join
                target: { entity_id: "{{ master }}" }
                data:
                  group_members: >
                    {{ expand('group.sonos_all') | selectattr('state','ne','unavailable') | map(attribute='entity_id') | list }}
              - service: media_player.volume_set
                target:
                  entity_id: >
                    {{ expand('group.sonos_all') | selectattr('state','ne','unavailable') | map(attribute='entity_id') | list }}
                data:
                  volume_level: "{{ states('input_number.sonos_default_volume') | float(0.2) }}"
        default:
          - service: system_log.write
            data:
              message: "Sonos Group All: Could not find an available master speaker in group.sonos_all."
              level: warning

  # --- Disable only the alarms that ring tomorrow --------------------------
  # Uses sensor.sonos_alarms_for_tomorrow (tomorrow only, not today)
  disable_tomorrows_sonos_alarms:
    alias: Disable Tomorrow's Sonos Alarms
    mode: single
    icon: mdi:alarm-off
    sequence:
      - variables:
          alarms_to_disable: >
            {{ state_attr('sensor.sonos_alarms_for_tomorrow', 'alarm_entities') | default([]) }}
          # Build a comma-separated string of entity_ids up to 255 chars
          max_chars: 255
          entity_ids_str: >
            {%- set ns = namespace(s='') -%}
            {%- for eid in alarms_to_disable -%}
              {%- set next = (ns.s ~ (',' if ns.s else '') ~ eid) -%}
              {%- if next | length <= max_chars -%}
                {%- set ns.s = next -%}
              {%- else -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.s }}
          skipped_alarms: >
            {%- set ns = namespace(s='') -%}
            {%- set used = entity_ids_str.split(',') if entity_ids_str else [] -%}
            {%- for eid in alarms_to_disable -%}
              {%- if eid not in used -%}
                {%- set ns.s = ns.s ~ (',' if ns.s else '') ~ eid -%}
              {%- endif -%}
            {%- endfor -%}
            {{ ns.s }}
      - service: input_text.set_value
        target:
          entity_id: input_text.sonos_alarms_disabled_for_tomorrow
        data:
          value: "{{ entity_ids_str }}"
      - service: system_log.write
        data:
          message: |
            Sonos Alarm Disable Debug: Alarms to disable (from centralized sensor): {{ alarms_to_disable }}. Stored: {{ entity_ids_str }}. Skipped (due to 255-char limit): {{ skipped_alarms }}
          level: info
      - choose:
          - conditions: "{{ entity_ids_str | length > 0 }}"
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: "{{ entity_ids_str.split(',') }}"
              - service: system_log.write
                data:
                  message: "Disabled tomorrow's Sonos alarms: {{ entity_ids_str }}"
                  level: info
        default:
          - service: system_log.write
            data:
              message: "No active Sonos alarms found scheduled for tomorrow to disable."
              level: info

  # --- Nightly confirmable notification ---
  # UPDATED: Removed target from notify.notify calls. Uses simplified update script.
  evening_alarm_check_notification:
    alias: Evening Alarm Check Notification
    mode: single
    icon: mdi:bell-check-outline
    sequence:
      # Step 1: (No longer call update script, logic is centralized)
      # Step 2: Condition for notifications enabled
      - condition: state 
        entity_id: input_boolean.sonos_alarm_notifications
        state: "on"
      # Step 3: Define variables using the tomorrow-specific sensor
      - variables:
          dev_id_check: "{{ states('input_text.notify_target_device_id') }}"
          alarms_for_tomorrow: >
            {{ state_attr('sensor.sonos_alarms_for_tomorrow', 'alarm_entities') | default([]) }}
          count: "{{ state_attr('sensor.sonos_alarms_for_tomorrow', 'alarm_count') | int(0) }}"
          earliest_time_str: "{{ state_attr('sensor.sonos_alarms_for_tomorrow', 'earliest_alarm_time_tomorrow') | default('unknown') }}"
          notification_title: "Sonos Alarm Check (Tomorrow)"
          notification_message: >
            {{ count }} alarm{{ 's' if count != 1 else '' }} will ring tomorrow (earliest at {{ earliest_time_str }}). Disable them?
          action_confirm: "{{ 'SONOS_CONFIRM_' ~ context.id }}"
          action_dismiss: "{{ 'SONOS_DISMISS_' ~ context.id }}"
          confirm_button_text: "Disable"
          dismiss_button_text: "Keep Enabled"
      # Step 4: Check if there are alarms for tomorrow and if ANY device ID is set
      - condition: template
        value_template: >
          {{ count > 0 }}
      - condition: template
        value_template: "{{ dev_id_check != '' and dev_id_check != none and dev_id_check != 'unavailable' and dev_id_check != 'unknown' }}"
      # Step 5: Send the actionable notification
      - service: notify.notify
        data:
          title: "{{ notification_title }}"
          message: "{{ notification_message }}"
          data:
            actions:
              - action: "{{ action_confirm }}"
                title: "{{ confirm_button_text }}"
              - action: "{{ action_dismiss }}"
                title: "{{ dismiss_button_text }}"
      # Step 6: Wait for the user to tap an action
      - wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_confirm }}"
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_dismiss }}"
        timeout: 
          hours: 1
        continue_on_timeout: false 
      # Step 7: Perform action based on the trigger
      - choose:
          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == action_confirm }}"
            sequence:
              - service: script.disable_tomorrows_sonos_alarms
              - service: notify.notify 
                data:
                  message: "OK, tomorrow's Sonos alarms have been disabled."
          - conditions: "{{ wait.trigger and wait.trigger.event.data.action == action_dismiss }}"
            sequence:
              - service: notify.notify 
                data:
                  message: "OK, tomorrow's Sonos alarms will remain enabled."
        default: 
          - service: system_log.write
            data:
              message: "Sonos alarm notification confirmation timed out."
              level: warning
      # Step 8: Log if no alarms were found initially
      - condition: template 
        value_template: >
          {{ count == 0 }}
      - service: system_log.write
        data:
          message: "Evening Alarm Check: No Sonos alarms found scheduled for tomorrow (count was {{ count }})."
          level: info

  # --- Apple TV Auto Off Notification Script (with configurable entity IDs) ---
  apple_tv_auto_off_notification:
    alias: Apple TV Auto Off Notification
    mode: single
    icon: mdi:television-off
    fields:
      apple_tv_entity_id: # Field to accept from automation
        description: "The entity ID of the Apple TV that triggered the inactivity."
        example: "media_player.living_room_apple_tv"
      display_entity_id: # Field to accept from automation
        description: "The entity ID of the display associated with the Apple TV."
        example: "media_player.living_room_samsung_q60"
    sequence:
      - variables:
          dev_id: "{{ states('input_text.notify_target_device_id') }}"
          # Use entity_ids passed from automation via fields, otherwise fallback to global helpers
          effective_apple_tv_entity: "{{ apple_tv_entity_id if apple_tv_entity_id is defined else states('input_text.apple_tv_entity_id') }}"
          effective_display_entity: "{{ display_entity_id if display_entity_id is defined else states('input_text.apple_tv_display_entity_id') }}"
          apple_tv_friendly_name: "{{ state_attr(effective_apple_tv_entity, 'friendly_name') | default('The Apple TV') }}"
          # Check if display should also be turned off
          should_turn_off_display: >
            {{ effective_display_entity != '' and
               effective_display_entity != none and
               states(effective_display_entity) not in ['unavailable', 'unknown'] and
               effective_display_entity != effective_apple_tv_entity }}
          # Build confirm_actions dynamically - only service calls, no conditions
          confirm_actions_list: >
            {% set actions = [{'service': 'media_player.turn_off', 'target': {'entity_id': effective_apple_tv_entity}}] %}
            {% if should_turn_off_display %}
              {% set actions = actions + [{'service': 'media_player.turn_off', 'target': {'entity_id': effective_display_entity}}] %}
            {% endif %}
            {{ actions }}

      - choose:
          # Condition 1: Check if a valid notification device ID is available
          - conditions:
              - condition: template
                value_template: "{{ dev_id not in ['', none, 'unavailable', 'unknown'] }}"
              # Condition 2: Check if the Apple TV entity to control is valid
              - condition: template
                value_template: "{{ effective_apple_tv_entity not in ['', none] and states(effective_apple_tv_entity) not in ['unavailable', 'unknown'] }}"
            sequence:
              - service: script.confirmable_notification
                data:
                  notify_device: "{{ dev_id }}"
                  title: "{{ apple_tv_friendly_name }} Inactive"
                  message: "{{ apple_tv_friendly_name }} has been paused or idle for over 30 minutes. Would you like to turn it and the display off?"
                  confirm_text: "Yes, Turn Off"
                  confirm_actions: "{{ confirm_actions_list }}"
                  dismiss_text: "No, Keep On"
                  notification_tag: "apple_tv_auto_off_{{ effective_apple_tv_entity | replace('media_player.','') }}"
                  timeout_seconds: 1800
        default:
          - service: system_log.write
            data:
              message: "Apple TV Auto Off Notification: Not sent. Invalid notify_device ('{{ dev_id }}') or Apple TV entity ('{{ effective_apple_tv_entity }}')."
              level: warning

  soonest_sonos_alarm_info:
    alias: Soonest Sonos Alarm Info
    mode: single
    icon: mdi:alarm
    sequence:
      - variables:
          alarms: >
            {{ state_attr('sensor.sonos_upcoming_alarms', 'raw_alarm_list_sorted') | default([], true) }}
          soonest_alarm: >
            {{ alarms[0] if alarms|length > 0 else none }}
          soonest_entity_id: >
            {{ soonest_alarm.entity_id if soonest_alarm is mapping and 'entity_id' in soonest_alarm else 'None' }}
          soonest_time: >
            {{ soonest_alarm.time if soonest_alarm is mapping and 'time' in soonest_alarm else 'None' }}
          soonest_room: >
            {{ soonest_alarm.room if soonest_alarm is mapping and 'room' in soonest_alarm else 'Unknown' }}
          soonest_friendly_name: >
            {{ soonest_alarm.friendly_name if soonest_alarm is mapping and 'friendly_name' in soonest_alarm else soonest_entity_id }}
      - service: system_log.write
        data:
          message: |
            Soonest Sonos Alarm Info: Entity: {{ soonest_entity_id }}, Time: {{ soonest_time }}, Room: {{ soonest_room }}, Name: {{ soonest_friendly_name }}
          level: info

  # -----------------------------------------------------------------------
  # Toggle Next Alarm - for dashboard chip tap action
  # Toggles the soonest upcoming alarm on/off and tracks it for re-enabling
  # Supports optional alarm_entity and tracker parameters for per-room control
  # -----------------------------------------------------------------------
  sonos_toggle_next_alarm:
    alias: Sonos Toggle Next Alarm
    mode: single
    icon: mdi:alarm-check
    fields:
      alarm_entity:
        description: "Optional: Specific alarm entity to toggle. If omitted, uses global soonest alarm."
        required: false
        selector:
          entity:
            domain: switch
      tracker:
        description: "Optional: input_text entity to track toggled alarm. If omitted, uses global tracker."
        required: false
        selector:
          entity:
            domain: input_text
    sequence:
      - variables:
          # Use provided alarm_entity or fall back to global soonest
          alarm_entity_id: >
            {% if alarm_entity is defined and alarm_entity and alarm_entity not in ['none', 'None', ''] %}
              {{ alarm_entity }}
            {% else %}
              {{ state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') }}
            {% endif %}
          # Use provided tracker or fall back to global
          tracker_entity: >
            {{ tracker if tracker is defined and tracker else 'input_text.sonos_manually_toggled_alarm' }}
          # Check if we have a previously toggled alarm to re-enable
          previously_toggled: >
            {{ states(tracker_entity) | default('', true) }}
          # Determine which entity to work with (previously toggled takes priority)
          target_entity: >
            {% if previously_toggled and previously_toggled not in ['', 'unknown', 'unavailable', 'None'] %}
              {{ previously_toggled }}
            {% else %}
              {{ alarm_entity_id }}
            {% endif %}
          # Check if target is currently enabled
          is_currently_enabled: >
            {{ target_entity and states(target_entity) == 'on' }}

      - choose:
          # Case 1: We have a previously disabled alarm - re-enable it
          - conditions:
              - condition: template
                value_template: >
                  {{ previously_toggled and previously_toggled not in ['', 'unknown', 'unavailable', 'None'] }}
            sequence:
              # Turn on the previously disabled alarm
              - service: switch.turn_on
                target:
                  entity_id: "{{ previously_toggled }}"
              # Clear the tracking helper
              - service: input_text.set_value
                target:
                  entity_id: "{{ tracker_entity }}"
                data:
                  value: ""
              - service: system_log.write
                data:
                  message: "Sonos Toggle Next Alarm: Re-enabled {{ previously_toggled }} (tracker: {{ tracker_entity }})"
                  level: info

          # Case 2: No alarm found at all
          - conditions:
              - condition: template
                value_template: "{{ not alarm_entity_id or alarm_entity_id in ['None', none, 'none', ''] }}"
            sequence:
              - service: system_log.write
                data:
                  message: "Sonos Toggle Next Alarm: No upcoming alarm found to toggle."
                  level: info

          # Case 3: Alarm is currently ON - disable it
          - conditions:
              - condition: template
                value_template: "{{ is_currently_enabled }}"
            sequence:
              # Store which alarm we're disabling
              - service: input_text.set_value
                target:
                  entity_id: "{{ tracker_entity }}"
                data:
                  value: "{{ alarm_entity_id }}"
              # Turn off the alarm
              - service: switch.turn_off
                target:
                  entity_id: "{{ alarm_entity_id }}"
              - service: system_log.write
                data:
                  message: "Sonos Toggle Next Alarm: Disabled {{ alarm_entity_id }} (tracker: {{ tracker_entity }})"
                  level: info

        # Default: Alarm exists but is OFF and wasn't toggled by us - enable it
        default:
          - service: switch.turn_on
            target:
              entity_id: "{{ alarm_entity_id }}"
          - service: system_log.write
            data:
              message: "Sonos Toggle Next Alarm: Enabled {{ alarm_entity_id }}"
              level: info

############################
#  AUTOMATION              #
############################
automation:
  - alias: Sonos - Group selector dropdown handler
    id: sonos_group_selector_dropdown_handler
    mode: queued
    trigger:
      - platform: state
        entity_id: input_select.sonos_group_selector
    condition:
      - condition: template
        value_template: >
          {{ trigger.to_state.state not in ['unknown', 'unavailable', 'Select room'] }}
    action:
      - variables:
          selected: "{{ trigger.to_state.state }}"
          target_speaker: >-
            {% if selected == 'Living' %}
              media_player.living_room
            {% elif selected == 'Dining' %}
              media_player.dining_room
            {% elif selected == 'Kitchen' %}
              media_player.kitchen
            {% elif selected == 'Bath' %}
              media_player.bath
            {% elif selected == 'Bedroom' %}
              media_player.bedroom
            {% else %}
              none
            {% endif %}
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ target_speaker != 'none' }}"
            sequence:
              - service: script.sonos_toggle_group_membership
                data:
                  target_speaker: "{{ target_speaker }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.sonos_group_selector
        data:
          option: Select room
          
  # Event-based trigger for Sonos alarm updates
  - id: sonos_alarm_trigger_update
    alias: Sonos Alarm State Change Trigger Update
    description: "Updates soonest alarm info helpers when any Sonos alarm switch changes."
    mode: queued
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id:
          - switch.sonos_alarm_living_room
          - switch.sonos_alarm_bedroom
          - switch.sonos_alarm_kitchen
          - switch.sonos_alarm_office
          - switch.sonos_alarm_bath
    condition: []
    action:
      # Removed deprecated script.update_soonest_sonos_alarm_info call
      - service: system_log.write
        data:
          message: "Sonos alarm update triggered by: {{ trigger.entity_id }}"
          level: info

  # Sonos nightly prompt automation
  - id: sonos_nightly_prompt
    alias: Sonos Nightly Alarm Prompt 21:30
    description: "Triggers the evening alarm check notification script daily."
    mode: single
    trigger:
      - platform: time
        at: "21:30:00"
    condition: [] # Conditions can be added here if needed
    action:
      - service: script.evening_alarm_check_notification

  # Apple TV Auto-Off Automation with configurable entity ID

  # Track last genuine Apple TV playback for debounce / session gating
  # NOTE: If you change input_text.apple_tv_entity_id, update entity_id here to match
  - id: apple_tv_track_last_playing
    alias: Apple TV Track Last Playing
    description: "Stores the last time Apple TV was in playing state"
    mode: restart
    trigger:
      - platform: state
        entity_id: media_player.living_room_apple_tv
        to: "playing"
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.apple_tv_last_playing
        data:
          datetime: "{{ now().isoformat() }}"

  - id: apple_tv_auto_off_after_inactivity
    alias: Apple TV Auto Off After Inactivity
    description: "Turns off Apple TV and display after 30 minutes of inactivity (paused/idle)."
    mode: single
    trigger:
      # Check every 5 minutes
      - platform: time_pattern
        minutes: "/5"
    condition:
      # AND conditions:
      - condition: state
        entity_id: input_boolean.apple_tv_no_auto_off
        state: 'off' # Only run if manual override is OFF
      # CORRECTED: Use template condition to check state of dynamic entity ID
      - condition: template
        value_template: >
          {% set apple_tv_id = states('input_text.apple_tv_entity_id') %}
          {% set display_id = states('input_text.apple_tv_display_entity_id') %}
          {% set apple_tv_state = states(apple_tv_id) %}
          {% set display_state = states(display_id) %}
          {% set apple_tv_obj = states[apple_tv_id] if apple_tv_id and apple_tv_state not in ['unavailable', 'unknown'] else none %}

          {# 1. Apple TV entity is valid and not unavailable/unknown/off/standby #}
          {% set apple_tv_valid = apple_tv_state not in ['unavailable', 'unknown', 'off', 'standby'] %}

          {# 2. Apple TV is paused or idle for 30+ minutes #}
          {% set is_inactive = apple_tv_obj is not none
                               and apple_tv_state in ['paused', 'idle']
                               and (now() - apple_tv_obj.last_changed).total_seconds() >= 1800 %}

          {# 3. TV display is actually ON #}
          {% set display_is_on = display_state not in ['unavailable', 'unknown', 'off', 'standby'] %}

          {# 4. Apple TV was genuinely playing recently (prevents phantom paused while TV left on) #}
          {% set last_playing = states('input_datetime.apple_tv_last_playing') %}
          {% set last_playing_ok = last_playing not in ['unknown','unavailable','none','']
                                   and (as_timestamp(now()) - as_timestamp(last_playing)) <= 12*3600 %}

          {{ apple_tv_valid and is_inactive and display_is_on and last_playing_ok }}
    action:
      - service: script.apple_tv_auto_off_notification
        data:
          # Pass the entity ID to the script if needed
          apple_tv_entity_id: "{{ states('input_text.apple_tv_entity_id') }}"
          display_entity_id: "{{ states('input_text.apple_tv_display_entity_id') }}"
      # Log the action taken
      - service: system_log.write
        data:
          message: "Apple TV Auto Off: Apple TV has been inactive for 30+ minutes. Notification sent."
          level: warning

  - id: sonos_reenable_tomorrows_alarms
    alias: Sonos Re-Enable Tomorrow's Alarms at 21:00
    description: "Re-enables Sonos alarms that were disabled for tomorrow."
    mode: single
    trigger:
      - platform: time
        at: "21:00:00"
    condition: []
    action:
      - variables:
          alarms_to_reenable: >
            {% set stored = states('input_text.sonos_alarms_disabled_for_tomorrow') | trim %}
            {{ stored.split(',') if stored else [] }}
      - choose:
          - conditions: "{{ alarms_to_reenable | length > 0 and alarms_to_reenable[0] | length > 0 }}"
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: "{{ alarms_to_reenable }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.sonos_alarms_disabled_for_tomorrow
                data:
                  value: ""
              - service: system_log.write
                data:
                  message: "Re-enabled Sonos alarms: {{ alarms_to_reenable }}"
                  level: info
        default:
          - service: system_log.write
            data:
              message: "No Sonos alarms to re-enable at 21:00."
              level: info

###############################################################################
#  SONOS ALARM MANAGEMENT SECTION                                              #
#  Uses the sonos.update_alarm service for advanced alarm modifications        #
#                                                                              #
#  The sonos.update_alarm service accepts:                                     #
#    - alarm_id (required): Integer ID from switch.sonos_alarm_XXX entity      #
#    - time: New alarm time (HH:MM:SS format)                                  #
#    - volume: Float between 0.0 and 1.0                                       #
#    - enabled: Boolean to enable/disable the alarm                            #
#    - include_linked_zones: Boolean for grouped speaker playback              #
#                                                                              #
#  Alarm switch entities expose these attributes:                              #
#    - alarm_id: The Sonos internal alarm ID                                   #
#    - time: Current scheduled time                                            #
#    - duration: How long the alarm plays                                      #
#    - recurrence: DAILY, WEEKDAYS, WEEKENDS, or ON_# patterns                 #
#    - volume: Current volume level (0.0-1.0)                                  #
#    - play_mode: Playback mode (NORMAL, SHUFFLE, etc.)                        #
#    - scheduled_today: Boolean if alarm is scheduled for today                #
#    - include_linked_zones: Boolean for group playback                        #
###############################################################################

# ============================================================================
# ALARM MANAGEMENT SCRIPTS
# ============================================================================
# These scripts use the sonos.update_alarm service for advanced modifications
# that go beyond simple enable/disable (which uses switch.turn_on/off)
# ============================================================================

script:
  # -------------------------------------------------------------------------
  # Update Alarm Time - Change when an alarm triggers
  # -------------------------------------------------------------------------
  sonos_update_alarm_time:
    alias: Sonos - Update Alarm Time
    description: "Updates the time for a specific Sonos alarm using sonos.update_alarm"
    icon: mdi:alarm-plus
    mode: single
    fields:
      alarm_entity:
        description: "The switch.sonos_alarm_XXX entity to modify"
        required: true
        example: "switch.sonos_alarm_938"
        selector:
          entity:
            domain: switch
            integration: sonos
      new_time:
        description: "New alarm time in HH:MM or HH:MM:SS format"
        required: true
        example: "07:30:00"
        selector:
          time:
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') | int(0) }}"
          current_time: "{{ state_attr(alarm_entity, 'time') }}"
          # Ensure time format includes seconds
          formatted_time: >
            {% set parts = new_time.split(':') %}
            {% if parts | length == 2 %}
              {{ new_time }}:00
            {% else %}
              {{ new_time }}
            {% endif %}
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
        alias: "Verify alarm_id is valid"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          time: "{{ formatted_time }}"
      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_entity }} (ID: {{ alarm_id }}) time updated from {{ current_time }} to {{ formatted_time }}"
          level: info

  # -------------------------------------------------------------------------
  # Update Alarm Volume - Change how loud an alarm plays
  # -------------------------------------------------------------------------
  sonos_update_alarm_volume:
    alias: Sonos - Update Alarm Volume
    description: "Updates the volume for a specific Sonos alarm"
    icon: mdi:volume-high
    mode: single
    fields:
      alarm_entity:
        description: "The switch.sonos_alarm_XXX entity to modify"
        required: true
        example: "switch.sonos_alarm_938"
        selector:
          entity:
            domain: switch
            integration: sonos
      volume:
        description: "New volume level (0.0 to 1.0, or 0 to 100 as percentage)"
        required: true
        example: 0.25
        selector:
          number:
            min: 0
            max: 100
            step: 1
            unit_of_measurement: "%"
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') | int(0) }}"
          current_volume: "{{ state_attr(alarm_entity, 'volume') | float(0) }}"
          # Normalize volume: if > 1, treat as percentage
          normalized_volume: >
            {% if volume | float > 1 %}
              {{ (volume | float / 100) | round(2) }}
            {% else %}
              {{ volume | float | round(2) }}
            {% endif %}
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
        alias: "Verify alarm_id is valid"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          volume: "{{ normalized_volume }}"
      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_entity }} (ID: {{ alarm_id }}) volume updated from {{ (current_volume * 100) | int }}% to {{ (normalized_volume * 100) | int }}%"
          level: info

  # -------------------------------------------------------------------------
  # Update Alarm Linked Zones - Enable/disable group playback
  # -------------------------------------------------------------------------
  sonos_update_alarm_linked_zones:
    alias: Sonos - Update Alarm Linked Zones
    description: "Enable or disable playing alarm on all grouped speakers"
    icon: mdi:speaker-multiple
    mode: single
    fields:
      alarm_entity:
        description: "The switch.sonos_alarm_XXX entity to modify"
        required: true
        example: "switch.sonos_alarm_938"
        selector:
          entity:
            domain: switch
            integration: sonos
      include_linked_zones:
        description: "Whether to play on all grouped speakers"
        required: true
        example: true
        selector:
          boolean:
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') | int(0) }}"
          current_linked: "{{ state_attr(alarm_entity, 'include_linked_zones') | default(false) }}"
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
        alias: "Verify alarm_id is valid"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          include_linked_zones: "{{ include_linked_zones }}"
      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_entity }} (ID: {{ alarm_id }}) linked zones changed from {{ current_linked }} to {{ include_linked_zones }}"
          level: info

  # -------------------------------------------------------------------------
  # Generic Alarm Update - Update multiple properties at once
  # -------------------------------------------------------------------------
  sonos_update_alarm:
    alias: Sonos - Update Alarm (Generic)
    description: "Update any combination of alarm properties using sonos.update_alarm"
    icon: mdi:alarm-check
    mode: single
    fields:
      alarm_entity:
        description: "The switch.sonos_alarm_XXX entity to modify"
        required: true
        example: "switch.sonos_alarm_938"
        selector:
          entity:
            domain: switch
            integration: sonos
      time:
        description: "New alarm time (optional, HH:MM:SS)"
        required: false
        example: "07:30:00"
        selector:
          time:
      volume:
        description: "New volume level (optional, 0.0-1.0 or 0-100)"
        required: false
        example: 25
        selector:
          number:
            min: 0
            max: 100
            step: 1
            unit_of_measurement: "%"
      enabled:
        description: "Enable or disable the alarm (optional)"
        required: false
        example: true
        selector:
          boolean:
      include_linked_zones:
        description: "Play on grouped speakers (optional)"
        required: false
        example: false
        selector:
          boolean:
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') | int(0) }}"
          # Build service data dynamically based on provided parameters
          service_data: >
            {% set data = {'alarm_id': alarm_id} %}
            {% if time is defined and time %}
              {% set parts = time.split(':') %}
              {% if parts | length == 2 %}
                {% set data = dict(data, time=time ~ ':00') %}
              {% else %}
                {% set data = dict(data, time=time) %}
              {% endif %}
            {% endif %}
            {% if volume is defined and volume is not none %}
              {% set vol = volume | float %}
              {% if vol > 1 %}
                {% set vol = (vol / 100) | round(2) %}
              {% endif %}
              {% set data = dict(data, volume=vol) %}
            {% endif %}
            {% if enabled is defined and enabled is not none %}
              {% set data = dict(data, enabled=enabled) %}
            {% endif %}
            {% if include_linked_zones is defined and include_linked_zones is not none %}
              {% set data = dict(data, include_linked_zones=include_linked_zones) %}
            {% endif %}
            {{ data }}
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
        alias: "Verify alarm_id is valid"
      - service: sonos.update_alarm
        data: "{{ service_data }}"
      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_entity }} (ID: {{ alarm_id }}) updated with: {{ service_data }}"
          level: info

  # -------------------------------------------------------------------------
  # Snooze Alarm - Delay the next alarm by a specified amount
  # -------------------------------------------------------------------------
  sonos_snooze_alarm:
    alias: Sonos - Snooze/Delay Alarm
    description: "Delays an alarm by adding minutes to its current time"
    icon: mdi:alarm-snooze
    mode: single
    fields:
      alarm_entity:
        description: "The switch.sonos_alarm_XXX entity to snooze"
        required: true
        example: "switch.sonos_alarm_938"
        selector:
          entity:
            domain: switch
            integration: sonos
      snooze_minutes:
        description: "Minutes to delay the alarm (default: 9)"
        required: false
        default: 9
        example: 15
        selector:
          number:
            min: 1
            max: 120
            step: 1
            unit_of_measurement: "min"
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') | int(0) }}"
          current_time: "{{ state_attr(alarm_entity, 'time') }}"
          minutes_to_add: "{{ snooze_minutes | default(9) | int }}"
          # Calculate new time
          new_time: >
            {% set parts = current_time.split(':') %}
            {% set h = parts[0] | int %}
            {% set m = parts[1] | int %}
            {% set s = parts[2] | int if parts | length > 2 else 0 %}
            {% set total_minutes = h * 60 + m + minutes_to_add %}
            {% set new_h = (total_minutes // 60) % 24 %}
            {% set new_m = total_minutes % 60 %}
            {{ '%02d:%02d:%02d' | format(new_h, new_m, s) }}
      - condition: template
        value_template: "{{ alarm_id > 0 and current_time is not none }}"
        alias: "Verify alarm_id and current time are valid"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          time: "{{ new_time }}"
      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_entity }} (ID: {{ alarm_id }}) snoozed from {{ current_time }} to {{ new_time }} (+{{ minutes_to_add }} min)"
          level: info

  # -------------------------------------------------------------------------
  # Set Soonest Alarm Volume - Quick volume adjustment for next alarm
  # -------------------------------------------------------------------------
  sonos_set_next_alarm_volume:
    alias: Sonos - Set Next Alarm Volume
    description: "Sets the volume for the soonest upcoming alarm"
    icon: mdi:volume-medium
    mode: single
    fields:
      volume:
        description: "Volume level (0-100 as percentage)"
        required: true
        example: 30
        selector:
          number:
            min: 0
            max: 100
            step: 5
            unit_of_measurement: "%"
    sequence:
      - variables:
          alarm_entity: "{{ state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') }}"
          alarm_id: >
            {% if alarm_entity %}
              {{ state_attr(alarm_entity, 'alarm_id') | int(0) }}
            {% else %}
              0
            {% endif %}
          normalized_volume: "{{ (volume | float / 100) | round(2) }}"
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
        alias: "Verify we have a valid upcoming alarm"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          volume: "{{ normalized_volume }}"
      - service: system_log.write
        data:
          message: "Soonest Sonos alarm {{ alarm_entity }} volume set to {{ volume }}%"
          level: info

  # -------------------------------------------------------------------------
  # Bulk Update All Alarm Volumes - Set volume for all alarms on a speaker
  # -------------------------------------------------------------------------
  sonos_set_all_alarm_volumes_by_room:
    alias: Sonos - Set All Alarm Volumes by Room
    description: "Sets volume for all alarms on a specific Sonos speaker"
    icon: mdi:volume-equal
    mode: single
    fields:
      room:
        description: "Room/speaker name to filter alarms (e.g., 'Bath', 'Kitchen', 'Bedroom')"
        required: true
        example: "Bath"
        selector:
          text:
      volume:
        description: "Volume level (0-100 as percentage)"
        required: true
        example: 25
        selector:
          number:
            min: 0
            max: 100
            step: 5
            unit_of_measurement: "%"
    sequence:
      - variables:
          normalized_volume: "{{ (volume | float / 100) | round(2) }}"
          room_lower: "{{ room | lower }}"
          # Find all alarm switches matching the room
          matching_alarms: >
            {{ states.switch
                | selectattr('entity_id', 'search', 'sonos_alarm_')
                | selectattr('attributes.friendly_name', 'defined')
                | selectattr('attributes.friendly_name', 'search', room, ignorecase=True)
                | map(attribute='entity_id')
                | list }}
      - condition: template
        value_template: "{{ matching_alarms | length > 0 }}"
        alias: "Verify we found matching alarms"
      - repeat:
          for_each: "{{ matching_alarms }}"
          sequence:
            - variables:
                current_alarm_id: "{{ state_attr(repeat.item, 'alarm_id') | int(0) }}"
            - condition: template
              value_template: "{{ current_alarm_id > 0 }}"
            - service: sonos.update_alarm
              data:
                alarm_id: "{{ current_alarm_id }}"
                volume: "{{ normalized_volume }}"
      - service: system_log.write
        data:
          message: "Updated volume to {{ volume }}% for {{ matching_alarms | length }} alarm(s) in {{ room }}: {{ matching_alarms }}"
          level: info

# ============================================================================
# ALARM MANAGEMENT SENSORS
# ============================================================================
# Enhanced sensors providing detailed alarm information for dashboards
# ============================================================================

template:
  sensor:
    # -----------------------------------------------------------------------
    # Detailed Alarm Info Sensor - Shows comprehensive alarm details
    # -----------------------------------------------------------------------
    - name: "Sonos Alarm Details"
      unique_id: sonos_alarm_details
      icon: mdi:alarm-note
      state: >
        {% set data = state_attr('sensor.sonos_upcoming_alarms', 'all_alarms_data') %}
        {% set count = data.get('alarm_count', 0) if data is mapping else 0 %}
        {{ count }} upcoming alarm{{ 's' if count != 1 else '' }}
      attributes:
        # Next alarm quick info
        next_alarm_time: >
          {{ states('sensor.soonest_sonos_alarm_info') }}
        next_alarm_room: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'room') | default('Unknown') }}
        next_alarm_volume: >
          {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
          {% if entity_id %}
            {{ (state_attr(entity_id, 'volume') | float(0) * 100) | int }}
          {% else %}
            0
          {% endif %}
        next_alarm_entity: >
          {{ state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') }}
        next_alarm_id: >
          {% set entity_id = state_attr('sensor.soonest_sonos_alarm_info', 'entity_id') %}
          {% if entity_id %}
            {{ state_attr(entity_id, 'alarm_id') | default('unknown') }}
          {% else %}
            unknown
          {% endif %}
        # All alarms with full details
        all_alarms_detailed: >
          {%- set ns = namespace(alarms=[]) -%}
          {%- for alarm in states.switch | selectattr('entity_id', 'search', 'sonos_alarm_') -%}
            {%- set alarm_info = {
                'entity_id': alarm.entity_id,
                'enabled': alarm.state == 'on',
                'alarm_id': alarm.attributes.get('alarm_id', 'unknown'),
                'time': alarm.attributes.get('time', 'unknown'),
                'duration': alarm.attributes.get('duration', 'unknown'),
                'recurrence': alarm.attributes.get('recurrence', 'unknown'),
                'volume': (alarm.attributes.get('volume', 0) | float * 100) | int,
                'include_linked_zones': alarm.attributes.get('include_linked_zones', false),
                'scheduled_today': alarm.attributes.get('scheduled_today', false),
                'friendly_name': alarm.attributes.get('friendly_name', alarm.name),
                'room': alarm.attributes.get('friendly_name', '').split(' ')[0] if alarm.attributes.get('friendly_name') else 'Unknown'
            } -%}
            {%- set ns.alarms = ns.alarms + [alarm_info] -%}
          {%- endfor -%}
          {{ ns.alarms | sort(attribute='time') }}
        # Counts by state
        enabled_count: >
          {{ states.switch | selectattr('entity_id', 'search', 'sonos_alarm_') | selectattr('state', 'eq', 'on') | list | length }}
        disabled_count: >
          {{ states.switch | selectattr('entity_id', 'search', 'sonos_alarm_') | selectattr('state', 'eq', 'off') | list | length }}
        total_count: >
          {{ states.switch | selectattr('entity_id', 'search', 'sonos_alarm_') | list | length }}
        # Alarms by room
        alarms_by_room: >
          {%- set ns = namespace(rooms={}) -%}
          {%- for alarm in states.switch | selectattr('entity_id', 'search', 'sonos_alarm_') | selectattr('state', 'eq', 'on') -%}
            {%- set name = alarm.attributes.get('friendly_name', '') -%}
            {%- set room = name.split(' ')[0] if name else 'Unknown' -%}
            {%- if room in ns.rooms -%}
              {%- set ns.rooms = dict(ns.rooms, **{room: ns.rooms[room] + 1}) -%}
            {%- else -%}
              {%- set ns.rooms = dict(ns.rooms, **{room: 1}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.rooms }}

    # -----------------------------------------------------------------------
    # Per-Room Alarm Sensors for Dashboard Cards
    # -----------------------------------------------------------------------
    - name: "Sonos Alarms - Bath"
      unique_id: sonos_alarms_bath
      icon: mdi:alarm
      state: >
        {% set alarms = states.switch
            | selectattr('entity_id', 'search', 'sonos_alarm_')
            | selectattr('attributes.friendly_name', 'defined')
            | selectattr('attributes.friendly_name', 'search', 'Bath', ignorecase=True)
            | selectattr('state', 'eq', 'on')
            | list %}
        {{ alarms | length }} enabled
      attributes:
        enabled_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bath', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        all_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bath', ignorecase=True)
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        next_alarm_time: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bath', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.time', 'defined')
              | sort(attribute='attributes.time')
              | list %}
          {{ alarms[0].attributes.time if alarms | length > 0 else 'None' }}

    - name: "Sonos Alarms - Kitchen"
      unique_id: sonos_alarms_kitchen
      icon: mdi:alarm
      state: >
        {% set alarms = states.switch
            | selectattr('entity_id', 'search', 'sonos_alarm_')
            | selectattr('attributes.friendly_name', 'defined')
            | selectattr('attributes.friendly_name', 'search', 'Kitchen', ignorecase=True)
            | selectattr('state', 'eq', 'on')
            | list %}
        {{ alarms | length }} enabled
      attributes:
        enabled_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Kitchen', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        all_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Kitchen', ignorecase=True)
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        next_alarm_time: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Kitchen', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.time', 'defined')
              | sort(attribute='attributes.time')
              | list %}
          {{ alarms[0].attributes.time if alarms | length > 0 else 'None' }}

    - name: "Sonos Alarms - Bedroom"
      unique_id: sonos_alarms_bedroom
      icon: mdi:alarm
      state: >
        {% set alarms = states.switch
            | selectattr('entity_id', 'search', 'sonos_alarm_')
            | selectattr('attributes.friendly_name', 'defined')
            | selectattr('attributes.friendly_name', 'search', 'Bedroom', ignorecase=True)
            | selectattr('state', 'eq', 'on')
            | list %}
        {{ alarms | length }} enabled
      attributes:
        enabled_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bedroom', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        all_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bedroom', ignorecase=True)
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        next_alarm_time: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Bedroom', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.time', 'defined')
              | sort(attribute='attributes.time')
              | list %}
          {{ alarms[0].attributes.time if alarms | length > 0 else 'None' }}

    - name: "Sonos Alarms - Living Room"
      unique_id: sonos_alarms_living_room
      icon: mdi:alarm
      state: >
        {% set alarms = states.switch
            | selectattr('entity_id', 'search', 'sonos_alarm_')
            | selectattr('attributes.friendly_name', 'defined')
            | selectattr('attributes.friendly_name', 'search', 'Living', ignorecase=True)
            | selectattr('state', 'eq', 'on')
            | list %}
        {{ alarms | length }} enabled
      attributes:
        enabled_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Living', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        all_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Living', ignorecase=True)
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        next_alarm_time: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Living', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.time', 'defined')
              | sort(attribute='attributes.time')
              | list %}
          {{ alarms[0].attributes.time if alarms | length > 0 else 'None' }}

    - name: "Sonos Alarms - Dining Room"
      unique_id: sonos_alarms_dining_room
      icon: mdi:alarm
      state: >
        {% set alarms = states.switch
            | selectattr('entity_id', 'search', 'sonos_alarm_')
            | selectattr('attributes.friendly_name', 'defined')
            | selectattr('attributes.friendly_name', 'search', 'Dining', ignorecase=True)
            | selectattr('state', 'eq', 'on')
            | list %}
        {{ alarms | length }} enabled
      attributes:
        enabled_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Dining', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        all_alarms: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Dining', ignorecase=True)
              | list %}
          {{ alarms | map(attribute='entity_id') | list }}
        next_alarm_time: >
          {% set alarms = states.switch
              | selectattr('entity_id', 'search', 'sonos_alarm_')
              | selectattr('attributes.friendly_name', 'defined')
              | selectattr('attributes.friendly_name', 'search', 'Dining', ignorecase=True)
              | selectattr('state', 'eq', 'on')
              | selectattr('attributes.time', 'defined')
              | sort(attribute='attributes.time')
              | list %}
          {{ alarms[0].attributes.time if alarms | length > 0 else 'None' }}

# =============================================================================
# SONOS ALARM EDIT - UI HELPERS
# =============================================================================
# These helpers support the alarm edit popup workflow
# =============================================================================

input_datetime:
  sonos_alarm_edit_time:
    name: "Sonos Alarm Edit Time"
    has_date: false
    has_time: true
    icon: mdi:clock-edit

input_number:
  sonos_alarm_edit_volume:
    name: "Sonos Alarm Edit Volume"
    min: 0
    max: 100
    step: 5
    unit_of_measurement: "%"
    icon: mdi:volume-high
    mode: slider

input_text:
  sonos_alarm_edit_id:
    name: "Sonos Editing Alarm ID"
    max: 10
    icon: mdi:identifier
    initial: ""

  sonos_alarm_edit_entity:
    name: "Sonos Editing Alarm Entity"
    max: 50
    icon: mdi:toggle-switch
    initial: ""

  sonos_alarm_edit_speaker:
    name: "Sonos Editing Alarm Speaker"
    max: 50
    icon: mdi:speaker
    initial: ""

  sonos_alarm_edit_name:
    name: "Sonos Editing Alarm Name"
    max: 100
    icon: mdi:label
    initial: ""

input_boolean:
  sonos_alarm_edit_linked_zones:
    name: "Sonos Alarm Edit Linked Zones"
    icon: mdi:speaker-multiple
    initial: false

# =============================================================================
# SONOS ALARM EDIT - DISPLAY SENSORS
# =============================================================================

template:
  sensor:
    # -------------------------------------------------------------------------
    # Enabled Alarm Count - for popup header
    # -------------------------------------------------------------------------
    - name: "Sonos Enabled Alarm Count"
      unique_id: sonos_enabled_alarm_count
      icon: >
        {{ 'mdi:alarm-check' if this.state | int(0) > 0 else 'mdi:alarm-off' }}
      state: >
        {{ states.switch
           | selectattr('entity_id', 'match', 'switch.sonos_alarm_')
           | selectattr('state', 'eq', 'on')
           | list | count }}

    # -------------------------------------------------------------------------
    # Next Enabled Alarm - shows time and room
    # -------------------------------------------------------------------------
    - name: "Sonos Next Alarm"
      unique_id: sonos_next_alarm_ui
      icon: mdi:alarm
      state: >
        {% set ns = namespace(next_time='99:99:99', next_entity=none, next_room='') %}
        {% for entity in states.switch %}
          {% if entity.entity_id.startswith('switch.sonos_alarm_') and entity.state == 'on' %}
            {% set alarm_time = state_attr(entity.entity_id, 'time') | default('99:99:99') %}
            {% if alarm_time < ns.next_time %}
              {% set ns.next_time = alarm_time %}
              {% set ns.next_entity = entity.entity_id %}
              {% set friendly = state_attr(entity.entity_id, 'friendly_name') | default('') %}
              {% set ns.next_room = friendly.split(' ')[0] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if ns.next_entity %}
          {{ ns.next_time[:5] }} Â· {{ ns.next_room }}
        {% else %}
          No alarms
        {% endif %}
      attributes:
        next_alarm_entity: >
          {% set ns = namespace(next_time='99:99:99', next_entity=none) %}
          {% for entity in states.switch %}
            {% if entity.entity_id.startswith('switch.sonos_alarm_') and entity.state == 'on' %}
              {% set alarm_time = state_attr(entity.entity_id, 'time') | default('99:99:99') %}
              {% if alarm_time < ns.next_time %}
                {% set ns.next_time = alarm_time %}
                {% set ns.next_entity = entity.entity_id %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ ns.next_entity }}

    # -------------------------------------------------------------------------
    # Edit Display Helper - shows current editing alarm time
    # -------------------------------------------------------------------------
    - name: "Sonos Edit Alarm Display"
      unique_id: sonos_edit_alarm_display
      icon: mdi:alarm-plus
      state: >
        {% set entity = states('input_text.sonos_alarm_edit_entity') %}
        {% if entity and entity != 'unknown' and entity != '' %}
          {% set time = state_attr(entity, 'time') | default('--:--') %}
          {{ time[:5] }}
        {% else %}
          --:--
        {% endif %}

    # -------------------------------------------------------------------------
    # Recurrence Display - Human-readable recurrence
    # -------------------------------------------------------------------------
    - name: "Sonos Edit Recurrence Display"
      unique_id: sonos_edit_recurrence_display
      icon: mdi:calendar-repeat
      state: >
        {% set entity = states('input_text.sonos_alarm_edit_entity') %}
        {% set recurrence = state_attr(entity, 'recurrence') | default('') %}
        {% set map = {
          'DAILY': 'Every day',
          'WEEKDAYS': 'Weekdays',
          'WEEKENDS': 'Weekends',
          'ONCE': 'Once',
          'ON_0': 'Sunday',
          'ON_1': 'Monday',
          'ON_2': 'Tuesday',
          'ON_3': 'Wednesday',
          'ON_4': 'Thursday',
          'ON_5': 'Friday',
          'ON_6': 'Saturday'
        } %}
        {{ map.get(recurrence, recurrence) }}

# =============================================================================
# SONOS ALARM EDIT - SCRIPTS
# =============================================================================

script:
  # ---------------------------------------------------------------------------
  # Load Alarm For Edit - Populate helpers and open edit popup
  # ---------------------------------------------------------------------------
  sonos_load_alarm_for_edit:
    alias: "Sonos - Load Alarm For Edit"
    description: "Populate edit helpers with alarm data, then open edit popup"
    icon: mdi:pencil
    mode: restart
    fields:
      alarm_entity:
        description: "The switch entity for the alarm"
        example: "switch.sonos_alarm_182"
        required: true
        selector:
          entity:
            domain: switch
    sequence:
      - variables:
          alarm_id: "{{ state_attr(alarm_entity, 'alarm_id') }}"
          alarm_time: "{{ state_attr(alarm_entity, 'time') | default('06:00:00') }}"
          alarm_volume: "{{ (state_attr(alarm_entity, 'volume') | default(0.25) * 100) | int }}"
          alarm_name: "{{ state_attr(alarm_entity, 'friendly_name') | default('Alarm') }}"
          alarm_linked: "{{ state_attr(alarm_entity, 'include_linked_zones') | default(false) }}"
          speaker: >
            {% set name = state_attr(alarm_entity, 'friendly_name') | default('') %}
            {% if 'Bedroom' in name %}media_player.bedroom
            {% elif 'Bath' in name %}media_player.bath
            {% elif 'Kitchen' in name %}media_player.kitchen
            {% elif 'Living' in name %}media_player.living_room
            {% elif 'Dining' in name %}media_player.dining_room
            {% else %}media_player.living_room{% endif %}

      - service: input_text.set_value
        target:
          entity_id: input_text.sonos_alarm_edit_id
        data:
          value: "{{ alarm_id }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.sonos_alarm_edit_entity
        data:
          value: "{{ alarm_entity }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.sonos_alarm_edit_speaker
        data:
          value: "{{ speaker }}"

      - service: input_text.set_value
        target:
          entity_id: input_text.sonos_alarm_edit_name
        data:
          value: "{{ alarm_name }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.sonos_alarm_edit_time
        data:
          time: "{{ alarm_time }}"

      - service: input_number.set_value
        target:
          entity_id: input_number.sonos_alarm_edit_volume
        data:
          value: "{{ alarm_volume }}"

      - service: >
          {{ 'input_boolean.turn_on' if alarm_linked else 'input_boolean.turn_off' }}
        target:
          entity_id: input_boolean.sonos_alarm_edit_linked_zones

      # Small delay to ensure helpers are populated
      - delay:
          milliseconds: 100

      # Fire event for navigation (can be caught by automation if needed)
      - event: sonos_alarm_edit_ready
        event_data:
          alarm_entity: "{{ alarm_entity }}"
          alarm_id: "{{ alarm_id }}"

  # ---------------------------------------------------------------------------
  # Save Alarm Changes - Apply edits via sonos.update_alarm
  # ---------------------------------------------------------------------------
  sonos_save_alarm_changes:
    alias: "Sonos - Save Alarm Changes"
    description: "Save edited alarm settings via sonos.update_alarm"
    icon: mdi:content-save
    mode: single
    sequence:
      - variables:
          alarm_id: "{{ states('input_text.sonos_alarm_edit_id') | int }}"
          speaker: "{{ states('input_text.sonos_alarm_edit_speaker') }}"
          new_time: "{{ states('input_datetime.sonos_alarm_edit_time') }}"
          new_volume: "{{ states('input_number.sonos_alarm_edit_volume') | float / 100 }}"
          linked_zones: "{{ is_state('input_boolean.sonos_alarm_edit_linked_zones', 'on') }}"

      - condition: template
        value_template: "{{ alarm_id > 0 }}"

      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          time: "{{ new_time }}"
          volume: "{{ new_volume }}"
          include_linked_zones: "{{ linked_zones }}"

      - service: system_log.write
        data:
          message: "Sonos alarm {{ alarm_id }} updated: time={{ new_time }}, volume={{ (new_volume * 100) | int }}%, linked={{ linked_zones }}"
          level: info

  # ---------------------------------------------------------------------------
  # Adjust Edit Time - Add/subtract minutes from edit helper
  # ---------------------------------------------------------------------------
  sonos_adjust_edit_time:
    alias: "Sonos - Adjust Edit Time"
    description: "Add or subtract minutes from the edit time helper"
    icon: mdi:clock-fast
    mode: restart
    fields:
      minutes:
        description: "Minutes to add (negative to subtract)"
        required: true
        selector:
          number:
            min: -60
            max: 60
            step: 5
    sequence:
      - variables:
          current: "{{ states('input_datetime.sonos_alarm_edit_time') }}"
          parts: "{{ current.split(':') }}"
          total_mins: "{{ (parts[0] | int) * 60 + (parts[1] | int) + minutes }}"
          adjusted_mins: >
            {% set m = total_mins | int %}
            {% if m < 0 %}{{ m + 1440 }}
            {% elif m >= 1440 %}{{ m - 1440 }}
            {% else %}{{ m }}{% endif %}
          new_time: "{{ '%02d:%02d:00' | format(adjusted_mins // 60, adjusted_mins % 60) }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.sonos_alarm_edit_time
        data:
          time: "{{ new_time }}"

  # ---------------------------------------------------------------------------
  # Enable Weekday Alarms - Quick preset
  # ---------------------------------------------------------------------------
  sonos_enable_weekday_alarms:
    alias: "Sonos - Enable Weekday Alarms"
    description: "Enable all weekday-scheduled alarms"
    icon: mdi:alarm-check
    mode: single
    sequence:
      - service: switch.turn_on
        target:
          entity_id: >
            {{ states.switch
                | selectattr('entity_id', 'search', 'sonos_alarm_')
                | selectattr('attributes.recurrence', 'defined')
                | selectattr('attributes.recurrence', 'eq', 'WEEKDAYS')
                | map(attribute='entity_id')
                | list }}
      - service: system_log.write
        data:
          message: "Enabled all Sonos weekday alarms"
          level: info

  # ---------------------------------------------------------------------------
  # Enable Weekend Alarms - Quick preset
  # ---------------------------------------------------------------------------
  sonos_enable_weekend_alarms:
    alias: "Sonos - Enable Weekend Alarms"
    description: "Enable all weekend-scheduled alarms"
    icon: mdi:weather-sunny
    mode: single
    sequence:
      - service: switch.turn_on
        target:
          entity_id: >
            {{ states.switch
                | selectattr('entity_id', 'search', 'sonos_alarm_')
                | selectattr('attributes.recurrence', 'defined')
                | selectattr('attributes.recurrence', 'eq', 'WEEKENDS')
                | map(attribute='entity_id')
                | list }}
      - service: system_log.write
        data:
          message: "Enabled all Sonos weekend alarms"
          level: info

  # ---------------------------------------------------------------------------
  # Disable All Alarms - Quick preset
  # ---------------------------------------------------------------------------
  sonos_disable_all_alarms:
    alias: "Sonos - Disable All Alarms"
    description: "Disable all Sonos alarms"
    icon: mdi:alarm-off
    mode: single
    sequence:
      - service: switch.turn_off
        target:
          entity_id: >
            {{ states.switch
                | selectattr('entity_id', 'search', 'sonos_alarm_')
                | map(attribute='entity_id')
                | list }}
      - service: system_log.write
        data:
          message: "Disabled all Sonos alarms"
          level: info

  # ---------------------------------------------------------------------------
  # Snooze Next Alarm - Delay by 15 minutes
  # ---------------------------------------------------------------------------
  sonos_snooze_next_alarm:
    alias: "Sonos - Snooze Next Alarm"
    description: "Snooze the next upcoming alarm by 15 minutes"
    icon: mdi:alarm-snooze
    mode: single
    sequence:
      - variables:
          next_alarm: "{{ state_attr('sensor.sonos_next_alarm_ui', 'next_alarm_entity') }}"
      - condition: template
        value_template: "{{ next_alarm is not none and next_alarm != '' and next_alarm != 'None' }}"
      - variables:
          alarm_id: "{{ state_attr(next_alarm, 'alarm_id') | int(0) }}"
          current: "{{ state_attr(next_alarm, 'time') }}"
          parts: "{{ current.split(':') }}"
          total_mins: "{{ (parts[0] | int) * 60 + (parts[1] | int) + 15 }}"
          new_mins: "{{ total_mins if total_mins < 1440 else total_mins - 1440 }}"
          new_time: "{{ '%02d:%02d:00' | format(new_mins // 60, new_mins % 60) }}"
      - condition: template
        value_template: "{{ alarm_id > 0 }}"
      - service: sonos.update_alarm
        data:
          alarm_id: "{{ alarm_id }}"
          time: "{{ new_time }}"
      - service: system_log.write
        data:
          message: "Snoozed Sonos alarm {{ next_alarm }} from {{ current }} to {{ new_time }}"
          level: info
