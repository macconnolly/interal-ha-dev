# Inovelli VZM31-SN mmWave Presence Package
#
# Prerequisites:
#   - mmWaveTargetInfoReport must be set to "Enable" on the device
#   - manuSpecificInovelliMMWave cluster must be bound to EP1
#   - Visualizer add-on handles target tracking display

# ==============================================================================
# Automations
# ==============================================================================
automation:
  - alias: "Master Presence: Dynamic mmWave Tuning"
    id: master_presence_dynamic_mmwave_tuning
    description: "Adjusts Stay Life and Hold Time for sleep vs daytime use."
    trigger:
      - platform: time
        at: "23:00:00"
        id: "night"
      - platform: time
        at: "10:00:00"
        id: "day"
    action:
      - choose:
          # NIGHT MODE: High sensitivity, long stay life
          - conditions:
              - condition: trigger
                id: "night"
            sequence:
              - action: number.set_value
                target:
                  entity_id: number.master_presence_mmwavestaylife
                data:
                  value: 36000
              - action: number.set_value
                target:
                  entity_id: number.master_presence_mmwaveholdtime
                data:
                  value: 300
              - action: select.select_option
                target:
                  entity_id: select.master_presence_mmwavedetectsensitivity
                data:
                  option: "High (default)"

          # DAY MODE: Standard sensitivity, fast turn-off
          - conditions:
              - condition: trigger
                id: "day"
            sequence:
              - action: number.set_value
                target:
                  entity_id: number.master_presence_mmwavestaylife
                data:
                  value: 600
              - action: number.set_value
                target:
                  entity_id: number.master_presence_mmwaveholdtime
                data:
                  value: 30
              - action: select.select_option
                target:
                  entity_id: select.master_presence_mmwavedetectsensitivity
                data:
                  option: "Medium"
    mode: restart

  # ---------------------------------------------------------------------------
  # Config Button: Toggle All Adaptive Lights
  # ---------------------------------------------------------------------------
  - alias: "Master Presence: Config Button Toggle All Lights"
    id: master_presence_config_toggle_lights
    description: "Toggle all adaptive lights on/off via config button"
    trigger:
      - platform: device
        domain: mqtt
        device_id: 73df96f7362fcc1c190293c15970b548
        type: action
        subtype: config_single
    action:
      - variables:
          on_lights: >
            {{ expand('light.all_adaptive_lights')
               | selectattr('state', 'eq', 'on')
               | map(attribute='entity_id') | list }}
      - if: "{{ on_lights | length > 0 }}"
        then:
          - action: light.turn_off
            target:
              entity_id: "{{ on_lights }}"
        else:
          - action: light.turn_on
            target:
              entity_id: light.all_adaptive_lights
    mode: single
