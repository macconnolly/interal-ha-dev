# Living Room Settings Pop-up (v4) - Native Bubble Card
# ═══════════════════════════════════════════════════════════════════════
# Native Bubble Card pop-up triggered by hash #living-room-settings
# PLACEMENT: Must be added to the dashboard view AFTER all other cards.
# The pop-up is hidden by default and slides up when hash matches.
#
# Triggered by: gear sub-button in living_room_card_v4.yaml
#   tap_action: { action: navigate, navigation_path: "#living-room-settings" }
#
# Features:
# - Swipe-to-dismiss, hash-routed, deep-linkable
# - iOS bottom sheet styling
# - Room brightness slider
# - Offset-aware Brighten/Dim tiles
# - Conditional Reset Manual button
# - Sonos media player with group/ungroup
# - Room info rows
# - Alarm cards
# ═══════════════════════════════════════════════════════════════════════

type: vertical-stack
cards:
  # ─── POP-UP DEFINITION ───
  # This MUST be the first card in the vertical-stack.
  # All subsequent cards become the pop-up's content body.
  - type: custom:bubble-card
    card_type: pop-up
    hash: "#living-room-settings"
    name: Living Room
    icon: mdi:sofa
    entity: light.living_room_lights
    show_header: true
    close_on_click: false
    close_by_clicking_outside: true
    bg_opacity: 88
    bg_blur: 14
    width_desktop: 540px
    margin_top_mobile: 18vh
    margin_top_desktop: 18vh
    styles: |-
      ${(() => {
        const isDark = hass.themes?.darkMode;
        const lightsOn = parseInt(hass.states['sensor.room_living_state']?.attributes?.lights_on || '0');
        const hasOverride = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).length > 0;
        const iconColor = lightsOn > 0 ? 'rgb(255, 149, 0)' : (isDark ? 'rgba(255, 255, 255, 0.35)' : 'rgba(60, 60, 60, 0.55)');
        const iconBg = lightsOn > 0 ? 'rgba(255, 149, 0, 0.14)' : (isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)');
        return `
          .bubble-pop-up {
            background: ${isDark ? 'rgba(28, 28, 30, 0.98)' : 'rgba(248, 248, 250, 0.98)'} !important;
            border-radius: 24px 24px 0 0 !important;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.15), 0 -8px 40px rgba(0, 0, 0, 0.35) !important;
            border-top: 1px solid ${isDark ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.04)'} !important;
            padding-bottom: env(safe-area-inset-bottom, 24px) !important;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
          }
          .bubble-pop-up-backdrop {
            background: ${isDark ? 'rgba(0, 0, 0, 0.45)' : 'rgba(0, 0, 0, 0.25)'} !important;
            backdrop-filter: blur(16px) saturate(1.5) !important;
            -webkit-backdrop-filter: blur(16px) saturate(1.5) !important;
          }
          .bubble-header-container {
            padding: 0 16px !important;
          }
          .bubble-icon-container {
            min-width: 44px !important;
            min-height: 44px !important;
            border-radius: 13px !important;
            background: ${iconBg} !important;
          }
          .bubble-icon {
            --mdc-icon-size: 24px !important;
            color: ${iconColor} !important;
          }
          .bubble-name {
            font-size: 20px !important;
            font-weight: 700 !important;
            letter-spacing: -0.3px !important;
            color: ${isDark ? 'rgba(255, 255, 255, 0.95)' : 'rgba(0, 0, 0, 0.90)'} !important;
          }
          .bubble-state {
            color: ${isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(0, 0, 0, 0.40)'} !important;
            font-size: 13px !important;
          }
        `;
      })()}

  # ═══════════════════════════════════════════════════════════════════════
  # POP-UP CONTENT (all cards below are inside the pop-up)
  # ═══════════════════════════════════════════════════════════════════════

  # ─── ROOM BRIGHTNESS SLIDER ───
  - type: custom:bubble-card
    card_type: button
    button_type: slider
    entity: light.living_room_lights
    name: Room Brightness
    icon: mdi:brightness-7
    show_state: false
    show_attribute: true
    attribute: brightness
    scrolling_effect: false
    tap_action:
      action: perform-action
      perform_action: light.toggle
      target:
        entity_id: light.living_room_lights
    hold_action:
      action: more-info
    card_mod:
      style: |
        ha-card {
          background: transparent !important;
          border: none !important;
          box-shadow: none !important;
          margin: 0 12px !important;
        }

  # ─── QUICK ACTIONS GRID (3-col) ───
  - type: custom:layout-card
    layout_type: custom:grid-layout
    layout:
      grid-template-columns: repeat(3, 1fr)
      gap: 8px
      padding: 4px 16px
    cards:
      # ── All Off / All On ──
      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: light.living_room_lights
        name: All Off
        icon: mdi:lightbulb-group
        show_name: true
        show_state: false
        show_attribute: false
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: none
        card_mod:
          style: |
            ha-card { background: transparent !important; border: none !important; box-shadow: none !important; }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const lightsOn = hass.states['sensor.room_living_state']?.attributes?.lights_on || 0;
            const tileName = isOn ? 'All Off' : 'All On';
            const tileIcon = isOn ? 'lightbulb-group' : 'lightbulb-group-outline';
            const surfaceOn = isDark
              ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)'
              : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.55)' : 'rgba(0, 0, 0, 0.45)';
            const iconBgOn = 'rgba(255, 149, 0, 0.14)';
            const iconBgOff = isDark ? 'rgba(128, 128, 128, 0.14)' : 'rgba(0, 0, 0, 0.06)';
            const iconColorOn = '#ff9500';
            const iconColorOff = isDark ? 'rgba(255, 255, 255, 0.50)' : 'rgba(60, 60, 60, 0.55)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            card.querySelector('.bubble-icon')?.setAttribute('icon', 'mdi:' + tileIcon);
            const nameEl = card.querySelector('.bubble-name');
            if (nameEl) nameEl.innerText = tileName;
            return `
              .bubble-button-card-container {
                position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important;
                justify-items: center !important; align-items: center !important; text-align: center !important;
                min-height: 100px !important; aspect-ratio: 1 / 1 !important;
                padding: 10px 6px 8px 6px !important; border-radius: 18px !important;
                overflow: hidden !important; clip-path: inset(0 round 18px) !important;
                transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important;
                background: ${isOn ? surfaceOn : surfaceOff} !important;
                border: ${isOn ? borderOn : borderOff} !important;
                box-shadow: ${isOn ? boxShadowOn : boxShadowOff} !important;
              }
              .bubble-button-card-container:active { transform: scale(0.96) !important; }
              .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 10px !important; }
              .bubble-icon-container { min-width: 50px !important; min-height: 50px !important; grid-row: 1 !important; margin: 0 0 4px 0 !important; border-radius: 15px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? iconBgOn : iconBgOff} !important; border: ${isOn ? '1px solid rgba(255, 149, 0, 0.18)' : 'none'} !important; }
              .bubble-icon { --mdc-icon-size: 24px !important; color: ${isOn ? iconColorOn : iconColorOff} !important; opacity: ${isOn ? '1' : '0.65'} !important; }
              .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
              .bubble-name { font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important; justify-content: center !important; margin: 0 2px !important; color: ${isOn ? nameOn : nameOff} !important; }
            `;
          })()}

      # ── Brighten (offset-aware) ──
      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: light.living_room_lights
        name: Brighten
        icon: mdi:weather-sunny
        show_name: true
        show_state: false
        show_attribute: false
        scrolling_effect: false
        tap_action:
          action: perform-action
          perform_action: script.oal_global_manual_brighter
          data:
            lights: light.living_room_lights
        hold_action:
          action: none
        card_mod:
          style: >
            ha-card { background: transparent !important; border: none !important; box-shadow: none !important; }
        styles: |-
          ${(() => {
            const isDark = hass.themes?.darkMode;
            const roomState = hass.states['sensor.room_living_state'];
            const offset = parseFloat(roomState?.attributes?.brightness_offset || '0');
            const direction = roomState?.attributes?.offset_direction || 'neutral';
            const isActive = direction === 'brighter';
            const badge = isActive ? '+' + Math.abs(Math.round(offset)) + '%' : '';
            const accentColor = '#ff9500';
            const surfaceOn = isDark
              ? 'linear-gradient(180deg, rgba(48, 40, 28, 0.95) 0%, rgba(36, 33, 28, 0.93) 100%)'
              : 'linear-gradient(180deg, rgba(255, 250, 240, 0.97) 0%, rgba(255, 248, 235, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(255, 149, 0, 0.14)' : '1.5px solid rgba(255, 149, 0, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.70)' : 'rgba(0, 0, 0, 0.55)';
            const iconBgOff = isDark ? 'rgba(255, 149, 0, 0.08)' : 'rgba(255, 149, 0, 0.06)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            if (badge) { const nameEl = card.querySelector('.bubble-name'); if (nameEl) nameEl.innerText = badge; }
            return `
              .bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; aspect-ratio: 1 / 1 !important; padding: 10px 6px 8px 6px !important; border-radius: 18px !important; overflow: hidden !important; clip-path: inset(0 round 18px) !important; transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important; background: ${isActive ? surfaceOn : surfaceOff} !important; border: ${isActive ? borderOn : borderOff} !important; box-shadow: ${isActive ? boxShadowOn : boxShadowOff} !important; }
              .bubble-button-card-container:active { transform: scale(0.96) !important; }
              .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 10px !important; }
              .bubble-icon-container { min-width: 50px !important; min-height: 50px !important; grid-row: 1 !important; margin: 0 0 4px 0 !important; border-radius: 15px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isActive ? 'rgba(255, 149, 0, 0.14)' : iconBgOff} !important; border: ${isActive ? '1px solid rgba(255, 149, 0, 0.18)' : '1px solid rgba(255, 149, 0, 0.10)'} !important; }
              .bubble-icon { --mdc-icon-size: 24px !important; color: ${accentColor} !important; opacity: ${isActive ? '1' : '0.65'} !important; }
              .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
              .bubble-name { font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important; justify-content: center !important; margin: 0 2px !important; color: ${isActive ? nameOn : nameOff} !important; }
            `;
          })()}

      # ── Dim (offset-aware) ──
      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: light.living_room_lights
        name: Dim
        icon: mdi:weather-night
        show_name: true
        show_state: false
        show_attribute: false
        scrolling_effect: false
        tap_action:
          action: perform-action
          perform_action: script.oal_global_manual_dimmer
          data:
            lights: light.living_room_lights
        hold_action:
          action: none
        card_mod:
          style: >
            ha-card { background: transparent !important; border: none !important; box-shadow: none !important; }
        styles: |-
          ${(() => {
            const isDark = hass.themes?.darkMode;
            const roomState = hass.states['sensor.room_living_state'];
            const offset = parseFloat(roomState?.attributes?.brightness_offset || '0');
            const direction = roomState?.attributes?.offset_direction || 'neutral';
            const isActive = direction === 'dimmer';
            const badge = isActive ? Math.round(offset) + '%' : '';
            const accentColor = '#5e5ce6';
            const surfaceOn = isDark
              ? 'linear-gradient(180deg, rgba(32, 30, 48, 0.95) 0%, rgba(28, 28, 40, 0.93) 100%)'
              : 'linear-gradient(180deg, rgba(240, 240, 255, 0.97) 0%, rgba(235, 235, 250, 0.95) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'rgba(246, 246, 248, 0.95)';
            const borderOn = isDark ? '1.5px solid rgba(94, 92, 230, 0.14)' : '1.5px solid rgba(94, 92, 230, 0.20)';
            const borderOff = isDark ? '1.5px solid rgba(255, 255, 255, 0.08)' : '1.5px solid rgba(0, 0, 0, 0.04)';
            const nameOn = isDark ? 'rgba(255, 255, 255, 0.92)' : 'rgba(30, 30, 30, 0.9)';
            const nameOff = isDark ? 'rgba(255, 255, 255, 0.70)' : 'rgba(0, 0, 0, 0.55)';
            const iconBgOff = isDark ? 'rgba(94, 92, 230, 0.08)' : 'rgba(94, 92, 230, 0.06)';
            const boxShadowOn = isDark ? '0 2px 10px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.12)';
            const boxShadowOff = isDark ? '0 1px 4px rgba(0, 0, 0, 0.15)' : '0 1px 4px rgba(0, 0, 0, 0.08)';
            if (badge) { const nameEl = card.querySelector('.bubble-name'); if (nameEl) nameEl.innerText = badge; }
            return `
              .bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; aspect-ratio: 1 / 1 !important; padding: 10px 6px 8px 6px !important; border-radius: 18px !important; overflow: hidden !important; clip-path: inset(0 round 18px) !important; transition: transform 0.15s ease-out, background 0.3s ease, box-shadow 0.3s ease !important; background: ${isActive ? surfaceOn : surfaceOff} !important; border: ${isActive ? borderOn : borderOff} !important; box-shadow: ${isActive ? boxShadowOn : boxShadowOff} !important; }
              .bubble-button-card-container:active { transform: scale(0.96) !important; }
              .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; padding-bottom: 10px !important; }
              .bubble-icon-container { min-width: 50px !important; min-height: 50px !important; grid-row: 1 !important; margin: 0 0 4px 0 !important; border-radius: 15px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isActive ? 'rgba(94, 92, 230, 0.14)' : iconBgOff} !important; border: ${isActive ? '1px solid rgba(94, 92, 230, 0.18)' : '1px solid rgba(94, 92, 230, 0.10)'} !important; }
              .bubble-icon { --mdc-icon-size: 24px !important; color: ${accentColor} !important; opacity: ${isActive ? '1' : '0.65'} !important; }
              .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
              .bubble-name { font-weight: 600 !important; font-size: 15px !important; line-height: 1.2 !important; justify-content: center !important; margin: 0 2px !important; color: ${isActive ? nameOn : nameOff} !important; }
            `;
          })()}

  # ─── RESET MANUAL OVERRIDES (conditional) ───
  - type: custom:bubble-card
    card_type: button
    button_type: state
    entity: sensor.room_living_state
    name: Reset Manual Overrides
    icon: mdi:restore
    show_name: true
    show_state: false
    scrolling_effect: false
    tap_action:
      action: perform-action
      perform_action: adaptive_lighting.set_manual_control
      data:
        entity_id:
          - switch.adaptive_lighting_main_living
          - switch.adaptive_lighting_accent_spots
          - switch.adaptive_lighting_column_lights
          - switch.adaptive_lighting_recessed_ceiling
        manual_control: false
    card_mod:
      style: >
        ha-card { background: transparent !important; border: none !important; box-shadow: none !important; }
    styles: |-
      ${(() => {
        const isDark = hass.themes?.darkMode;
        const n = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).length;
        if (n === 0) return `.bubble-button-card-container { display: none !important; }`;
        return `
          .bubble-button-card-container {
            height: 48px !important; border-radius: 14px !important;
            background: ${isDark ? 'rgba(255, 59, 48, 0.08)' : 'rgba(255, 59, 48, 0.05)'} !important;
            border: ${isDark ? '1px solid rgba(255, 59, 48, 0.14)' : '1px solid rgba(255, 59, 48, 0.16)'} !important;
            display: flex !important; align-items: center !important; padding: 0 16px !important; margin: 0 16px !important;
          }
          .bubble-button-card-container:active { transform: scale(0.97) !important; }
          .bubble-icon-container { min-width: 32px !important; min-height: 32px !important; border-radius: 10px !important; background: rgba(255, 59, 48, 0.12) !important; display: flex !important; align-items: center !important; justify-content: center !important; }
          .bubble-icon { --mdc-icon-size: 18px !important; color: #ff3b30 !important; }
          .bubble-name { font-size: 14px !important; font-weight: 550 !important; color: ${isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(25, 25, 25, 0.85)'} !important; }
          .bubble-button-card-container::after { content: '${n}' !important; position: absolute !important; right: 16px !important; min-width: 22px !important; height: 22px !important; border-radius: 11px !important; background: #ff3b30 !important; color: white !important; font-size: 11px !important; font-weight: 700 !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 6px !important; }
        `;
      })()}

  # ─── SEPARATOR: Media ───
  - type: custom:bubble-card
    card_type: separator
    name: Media
    icon: ""
    styles: |
      .bubble-separator { margin-top: 4px !important; }
      .bubble-name { font-size: 13px !important; font-weight: 600 !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; opacity: 0.4 !important; }
      .bubble-icon-container { display: none !important; }
      .bubble-line { display: none !important; }

  # ─── SONOS MEDIA PLAYER ───
  - type: custom:bubble-card
    card_type: media-player
    entity: media_player.living_room
    name: Living Room Sonos
    icon: mdi:speaker-wireless
    card_layout: large-2-rows
    show_state: true
    show_icon: true
    show_name: true
    show_last_changed: false
    show_attribute: false
    cover_background: true
    hide:
      power_button: true
      previous_button: true
      next_button: true
      volume_button: false
      play_pause_button: false
    sub_button:
      - name: Group All
        icon: mdi:speaker-multiple
        entity: media_player.living_room
        show_state: false
        show_background: true
        state_background: false
        tap_action:
          action: call-service
          service: script.sonos_group_all_to_playing
      - name: Ungroup
        icon: mdi:speaker-off
        entity: media_player.living_room
        show_state: false
        show_background: true
        state_background: false
        tap_action:
          action: call-service
          service: script.sonos_ungroup_all
    card_mod:
      style: |
        ha-card {
          background: transparent !important;
          border: none !important;
          box-shadow: none !important;
          margin: 0 8px !important;
        }

  # ─── SEPARATOR: Room Info ───
  - type: custom:bubble-card
    card_type: separator
    name: Room Info
    icon: ""
    styles: |
      .bubble-separator { margin-top: 4px !important; }
      .bubble-name { font-size: 13px !important; font-weight: 600 !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; opacity: 0.4 !important; }
      .bubble-icon-container { display: none !important; }
      .bubble-line { display: none !important; }

  # ─── Lighting Mode ───
  - type: custom:button-card
    entity: input_select.oal_active_configuration
    name: Lighting Mode
    icon: mdi:lightbulb-auto
    show_state: false
    show_label: true
    label: |
      [[[ return entity.state || 'Adaptive'; ]]]
    tap_action:
      action: more-info
    custom_fields:
      value: |
        [[[ return entity.state || 'Adaptive'; ]]]
    styles:
      card:
        - background: var(--card-background-color, rgba(0, 0, 0, 0.035))
        - border: 1px solid var(--divider-color, rgba(0, 0, 0, 0.04))
        - border-radius: 16px
        - height: 52px
        - padding: 0 16px
        - margin: 0 12px
        - box-shadow: none
      grid:
        - grid-template-areas: "\"i n value\""
        - grid-template-columns: 32px 1fr auto
        - grid-template-rows: 1fr
        - align-items: center
      icon:
        - width: 18px
        - color: |
            [[[
              const colorMap = { 'Adaptive': '#34c759', 'Full Bright': '#ff9500', 'Dim Ambient': '#8e8e93', 'Warm Ambient': '#ff6b35', 'TV Mode': '#af52de', 'Sleep': '#5e5ce6', 'Manual': '#ff3b30' };
              return colorMap[entity.state] || '#34c759';
            ]]]
      name:
        - font-size: 14px
        - font-weight: 550
        - color: var(--primary-text-color)
        - justify-self: start
      label:
        - display: none
      custom_fields:
        value:
          - font-size: 13px
          - font-weight: 600
          - color: |
              [[[
                const colorMap = { 'Adaptive': '#34c759', 'Full Bright': '#ff9500', 'Dim Ambient': '#8e8e93', 'Warm Ambient': '#ff6b35', 'TV Mode': '#af52de', 'Sleep': '#5e5ce6', 'Manual': '#ff3b30' };
                return colorMap[entity.state] || '#34c759';
              ]]]

  # ─── Lights Status ───
  - type: custom:button-card
    entity: sensor.room_living_state
    name: Lights On
    icon: mdi:lightbulb-group-outline
    show_state: false
    show_label: false
    tap_action:
      action: more-info
    custom_fields:
      value: |
        [[[
          const lightsOn = entity.attributes?.lights_on || 0;
          const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
          const offset = entity.attributes?.brightness_offset || 0;
          const dir = entity.attributes?.offset_direction || 'neutral';
          let text = lightsOn + ' / 7';
          if (hasOverride) text += ' (manual)';
          else if (dir === 'brighter') text += ' (+' + Math.abs(offset) + '%)';
          else if (dir === 'dimmer') text += ' (' + offset + '%)';
          return text;
        ]]]
    styles:
      card:
        - background: var(--card-background-color, rgba(0, 0, 0, 0.035))
        - border: 1px solid var(--divider-color, rgba(0, 0, 0, 0.04))
        - border-radius: 16px
        - height: 52px
        - padding: 0 16px
        - margin: 0 12px
        - box-shadow: none
      grid:
        - grid-template-areas: "\"i n value\""
        - grid-template-columns: 32px 1fr auto
        - grid-template-rows: 1fr
        - align-items: center
      icon:
        - width: 18px
        - color: |
            [[[
              const lightsOn = entity.attributes?.lights_on || 0;
              const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
              if (hasOverride) return '#ff3b30';
              if (lightsOn > 0) return '#ff9500';
              return 'var(--secondary-text-color)';
            ]]]
      name:
        - font-size: 14px
        - font-weight: 550
        - color: var(--primary-text-color)
        - justify-self: start
      custom_fields:
        value:
          - font-size: 13px
          - font-weight: 600
          - color: |
              [[[
                const lightsOn = entity.attributes?.lights_on || 0;
                const hasOverride = (entity.attributes?.manually_controlled_lights || []).length > 0;
                if (hasOverride) return '#ff3b30';
                if (lightsOn > 0) return '#ff9500';
                return 'var(--secondary-text-color)';
              ]]]

  # ─── Override Info (conditional) ───
  - type: custom:button-card
    entity: sensor.room_living_state
    name: Override Active
    icon: mdi:hand-back-left
    show_state: false
    show_label: false
    tap_action:
      action: more-info
    custom_fields:
      value: |
        [[[
          const count = (entity.attributes?.manually_controlled_lights || []).length;
          const timer = states['sensor.oal_main_living_status']?.attributes?.override_remaining_formatted || '';
          if (count === 0) return '';
          let text = count + ' light' + (count > 1 ? 's' : '');
          if (timer && timer !== '0m') text += ' · resets in ' + timer;
          return text;
        ]]]
    styles:
      card:
        - background: var(--card-background-color, rgba(0, 0, 0, 0.035))
        - border: 1px solid rgba(255, 59, 48, 0.15)
        - border-radius: 16px
        - height: 52px
        - padding: 0 16px
        - margin: 0 12px
        - box-shadow: none
        - display: |
            [[[
              return (entity.attributes?.manually_controlled_lights || []).length > 0 ? 'flex' : 'none';
            ]]]
      grid:
        - grid-template-areas: "\"i n value\""
        - grid-template-columns: 32px 1fr auto
        - grid-template-rows: 1fr
        - align-items: center
      icon:
        - width: 18px
        - color: "#ff3b30"
      name:
        - font-size: 14px
        - font-weight: 550
        - color: var(--primary-text-color)
        - justify-self: start
      custom_fields:
        value:
          - font-size: 13px
          - font-weight: 600
          - color: "#ff3b30"

  # ─── SEPARATOR: Alarms ───
  - type: custom:bubble-card
    card_type: separator
    name: Alarms
    icon: ""
    styles: |
      .bubble-separator { margin-top: 4px !important; }
      .bubble-name { font-size: 13px !important; font-weight: 600 !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; opacity: 0.4 !important; }
      .bubble-icon-container { display: none !important; }
      .bubble-line { display: none !important; }

  # ─── ALARM CARDS ───
  - type: horizontal-stack
    cards:
      - type: custom:bubble-card
        card_type: button
        button_type: switch
        entity: switch.sonos_alarm_520
        name: Living Room
        icon: mdi:alarm
        show_state: false
        show_attribute: true
        attribute: recurrence
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: perform-action
          perform_action: script.sonos_load_alarm_for_edit
          data:
            alarm_entity: switch.sonos_alarm_520
        card_mod:
          style: |
            ha-card { background: transparent !important; border: none !important; box-shadow: none !important; margin: 0 4px 0 12px !important; }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const accentColor = 'rgb(10, 132, 255)';
            const surfaceOn = isDark ? 'linear-gradient(145deg, rgba(10, 60, 120, 0.25) 0%, rgba(10, 132, 255, 0.10) 100%)' : 'linear-gradient(145deg, rgba(173, 216, 255, 0.25) 0%, rgba(10, 132, 255, 0.15) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'linear-gradient(145deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04))';
            const borderOn = isDark ? '1px solid rgba(10, 132, 255, 0.25)' : '1px solid rgba(10, 132, 255, 0.35)';
            const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.08)' : '1px solid rgba(0,0,0,0.06)';
            return `
              :host { --bubble-accent-color: ${accentColor} !important; --bubble-button-background-color: transparent !important; }
              .bubble-button-background, .bubble-button-background-color, .bubble-background { background: transparent !important; border-radius: 14px !important; }
              .bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; padding: 14px 8px !important; border-radius: 14px !important; overflow: hidden !important; clip-path: inset(0 round 14px) !important; transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1) !important; background: ${isOn ? surfaceOn : surfaceOff} !important; border: ${isOn ? borderOn : borderOff} !important; }
              .bubble-button-card-container:active { transform: scale(0.96) !important; }
              .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; }
              .bubble-icon-container { min-width: 42px !important; min-height: 42px !important; grid-row: 1 !important; margin: 0 0 6px 0 !important; border-radius: 13px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? 'rgba(10, 132, 255, 0.14)' : (isDark ? 'rgba(128, 128, 128, 0.10)' : 'rgba(0,0,0,0.04)')} !important; }
              .bubble-icon { --mdc-icon-size: 22px !important; color: ${isOn ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.40)' : 'rgba(60, 60, 60, 0.45)')} !important; }
              .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
              .bubble-name { font-size: 13px !important; font-weight: 600 !important; justify-content: center !important; color: ${isOn ? (isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(20, 20, 20, 0.85)') : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; }
              .bubble-attribute { font-size: 11px !important; font-weight: 500 !important; justify-content: center !important; margin-top: 2px !important; color: ${isOn ? 'rgba(10, 132, 255, 0.80)' : (isDark ? 'rgba(255, 255, 255, 0.30)' : 'rgba(60, 60, 60, 0.35)')} !important; }
            `;
          })()}

      - type: custom:bubble-card
        card_type: button
        button_type: switch
        entity: switch.sonos_alarm_521
        name: Bedroom
        icon: mdi:alarm
        show_state: false
        show_attribute: true
        attribute: recurrence
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: perform-action
          perform_action: script.sonos_load_alarm_for_edit
          data:
            alarm_entity: switch.sonos_alarm_521
        card_mod:
          style: |
            ha-card { background: transparent !important; border: none !important; box-shadow: none !important; margin: 0 12px 0 4px !important; }
        styles: |-
          ${(() => {
            const isOn = state === 'on';
            const isDark = hass.themes?.darkMode;
            const accentColor = 'rgb(10, 132, 255)';
            const surfaceOn = isDark ? 'linear-gradient(145deg, rgba(10, 60, 120, 0.25) 0%, rgba(10, 132, 255, 0.10) 100%)' : 'linear-gradient(145deg, rgba(173, 216, 255, 0.25) 0%, rgba(10, 132, 255, 0.15) 100%)';
            const surfaceOff = isDark ? 'rgba(32, 32, 34, 0.7)' : 'linear-gradient(145deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04))';
            const borderOn = isDark ? '1px solid rgba(10, 132, 255, 0.25)' : '1px solid rgba(10, 132, 255, 0.35)';
            const borderOff = isDark ? '1px solid rgba(255, 255, 255, 0.08)' : '1px solid rgba(0,0,0,0.06)';
            return `
              :host { --bubble-accent-color: ${accentColor} !important; --bubble-button-background-color: transparent !important; }
              .bubble-button-background, .bubble-button-background-color, .bubble-background { background: transparent !important; border-radius: 14px !important; }
              .bubble-button-card-container { position: relative !important; display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; align-items: center !important; text-align: center !important; min-height: 100px !important; padding: 14px 8px !important; border-radius: 14px !important; overflow: hidden !important; clip-path: inset(0 round 14px) !important; transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1) !important; background: ${isOn ? surfaceOn : surfaceOff} !important; border: ${isOn ? borderOn : borderOff} !important; }
              .bubble-button-card-container:active { transform: scale(0.96) !important; }
              .bubble-content-container { display: grid !important; grid-template-rows: auto auto 1fr !important; justify-items: center !important; width: 100% !important; position: relative !important; z-index: 5 !important; }
              .bubble-icon-container { min-width: 42px !important; min-height: 42px !important; grid-row: 1 !important; margin: 0 0 6px 0 !important; border-radius: 13px !important; display: flex !important; align-items: center !important; justify-content: center !important; background: ${isOn ? 'rgba(10, 132, 255, 0.14)' : (isDark ? 'rgba(128, 128, 128, 0.10)' : 'rgba(0,0,0,0.04)')} !important; }
              .bubble-icon { --mdc-icon-size: 22px !important; color: ${isOn ? accentColor : (isDark ? 'rgba(255, 255, 255, 0.40)' : 'rgba(60, 60, 60, 0.45)')} !important; }
              .bubble-name-container { grid-row: 2 !important; margin: 0 !important; width: 100% !important; }
              .bubble-name { font-size: 13px !important; font-weight: 600 !important; justify-content: center !important; color: ${isOn ? (isDark ? 'rgba(255, 255, 255, 0.90)' : 'rgba(20, 20, 20, 0.85)') : (isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(60, 60, 60, 0.45)')} !important; }
              .bubble-attribute { font-size: 11px !important; font-weight: 500 !important; justify-content: center !important; margin-top: 2px !important; color: ${isOn ? 'rgba(10, 132, 255, 0.80)' : (isDark ? 'rgba(255, 255, 255, 0.30)' : 'rgba(60, 60, 60, 0.35)')} !important; }
            `;
          })()}
