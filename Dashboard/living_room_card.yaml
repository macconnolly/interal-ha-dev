type: vertical-stack
cards:
  # ── SEPARATOR HEADER ──
  - type: custom:bubble-card
    card_type: separator
    entity: light.living_room_lights
    name: Living Room
    icon: mdi:sofa
    sub_button:
      main:
        - entity: switch.adaptive_lighting_main_living
          icon: mdi:refresh
          show_state: false
          show_background: true
          visibility:
            - condition: state
              entity: sensor.room_living_state
              attribute: has_override
              state: true
          tap_action:
            action: call-service
            service: adaptive_lighting.set_manual_control
            data:
              entity_id: switch.adaptive_lighting_main_living
              manual_control: false
          name: Clear Override
        - entity: media_player.living_room
          icon: mdi:play-pause
          show_state: false
          show_background: true
          visibility:
            - condition: or
              conditions:
                - condition: state
                  entity: media_player.living_room
                  state: playing
                - condition: state
                  entity: media_player.living_room
                  state: paused
          tap_action:
            action: perform-action
            perform_action: media_player.media_play_pause
            target:
              entity_id: media_player.living_room
          name: Play Pause Sonos
        - entity: light.living_room_lights
          sub_button_type: slider
          name: Brightness
          icon: mdi:brightness-7
          hold_action:
            action: toggle
      bottom: []
    styles: |-
      ${(() => {
        const lightsOn = hass.states['light.living_room_lights']?.state === 'on';
        const isPlaying = hass.states['media_player.living_room']?.state === 'playing';
        let iconColor, iconBg;
        if (isPlaying) {
          iconColor = 'rgb(66, 133, 244)';
          iconBg = 'rgba(66, 133, 244, 0.15)';
        } else if (lightsOn) {
          iconColor = 'rgb(255, 149, 0)';
          iconBg = 'rgba(255, 149, 0, 0.15)';
        } else {
          iconColor = 'rgba(100, 100, 110, 0.5)';
          iconBg = 'rgba(100, 100, 110, 0.08)';
        }
        return `
          ha-card {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 12px 16px 6px 16px !important;
            margin: 0 !important;
          }
          .bubble-icon-container {
            background: ${iconBg} !important;
            border-radius: 50% !important;
            min-width: 44px !important;
            min-height: 44px !important;
            transition: background 0.25s ease !important;
          }
          .bubble-icon {
            color: ${iconColor} !important;
            --mdc-icon-size: 28px !important;
            transition: color 0.25s ease, filter 0.25s ease !important;
            ${(lightsOn || isPlaying) ? 'filter: drop-shadow(0 0 5px ' + iconColor.replace('rgb', 'rgba').replace(')', ', 0.35)') + ') !important;' : ''}
          }
          .bubble-name {
            font-size: 18px !important;
            font-weight: 700 !important;
            color: rgba(25, 25, 30, 0.92) !important;
            letter-spacing: -0.01em !important;
          }
          .bubble-sub-button-container {
            gap: 8px !important;
          }
          .bubble-sub-button {
            background: ${iconBg} !important;
            border: 1px solid ${iconColor.replace('rgb', 'rgba').replace(')', ', 0.25)')} !important;
            border-radius: 50% !important;
            min-width: 40px !important;
            min-height: 40px !important;
            transition: transform 0.1s ease, background 0.15s ease !important;
          }
          .bubble-sub-button:active {
            transform: scale(0.9) !important;
          }
          .bubble-sub-button ha-icon {
            color: ${iconColor} !important;
            --mdc-icon-size: 20px !important;
          }
          .bubble-sub-button-1 {
            background: rgba(255, 110, 90, 0.12) !important;
            border: 1px solid rgba(255, 110, 90, 0.35) !important;
          }
          .bubble-sub-button-1 ha-icon {
            color: rgb(255, 110, 90) !important;
          }
          .bubble-sub-button-2 {
            background: rgba(66, 133, 244, 0.12) !important;
            border: 1px solid rgba(66, 133, 244, 0.35) !important;
          }
          .bubble-sub-button-2 ha-icon {
            color: rgb(66, 133, 244) !important;
          }
        `;
      })()}

  # ── LIGHTS GRID (2 columns) ──
  - type: custom:layout-card
    layout_type: custom:grid-layout
    layout:
      grid-template-columns: repeat(2, 1fr)
      gap: 10px
      padding: 4px 16px 12px 16px
      mediaquery:
        "(max-width: 600px)":
          grid-template-columns: repeat(2, 1fr)
    cards:
      # ── Floor Lamp ──
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_floor_lamp
        name: Floor
        icon: mdi:floor-lamp
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_floor_lamp
          data:
            brightness_pct: 100
        sub_button:
          main:
            - entity: switch.adaptive_lighting_main_living
              icon: mdi:sync
              show_state: false
              show_name: false
              show_background: true
              tap_action:
                action: call-service
                service: adaptive_lighting.set_manual_control
                data:
                  entity_id: switch.adaptive_lighting_main_living
                  lights:
                    - light.living_room_floor_lamp
                  manual_control: false
          bottom: []
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isManual = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).includes('light.living_room_floor_lamp');
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${state === 'on' ? '#ffffff' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${state === 'on' ? '1.5px solid rgba(255, 149, 0, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${state === 'on'
                  ? '0 2px 12px rgba(255, 149, 0, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-sub-button-container {
                position: absolute !important;
                top: 5px !important;
                right: 5px !important;
                z-index: 25 !important;
              }
              .bubble-sub-button-1 {
                display: ${isManual ? 'flex' : 'none'} !important;
                background: rgba(255, 110, 90, 0.12) !important;
                border: 1.5px solid rgba(255, 110, 90, 0.4) !important;
                border-radius: 50% !important;
                min-width: 28px !important;
                min-height: 28px !important;
                max-width: 28px !important;
                max-height: 28px !important;
                padding: 0 !important;
                transition: transform 0.1s ease, background 0.15s ease !important;
              }
              .bubble-sub-button-1:active {
                transform: scale(0.85) !important;
                background: rgba(255, 110, 90, 0.25) !important;
              }
              .bubble-sub-button-1 ha-icon {
                color: rgb(255, 110, 90) !important;
                --mdc-icon-size: 15px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${state === 'on'
                  ? 'linear-gradient(135deg, rgba(255, 149, 0, 0.14), rgba(255, 180, 60, 0.07))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${state === 'on'
                  ? '1.5px solid rgba(255, 149, 0, 0.2)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${state === 'on' ? 'rgb(255, 149, 0)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${state === 'on' ? 'drop-shadow(0 0 5px rgba(255, 149, 0, 0.3))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${state === 'on' ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
              .bubble-state {
                font-size: 12px !important;
                font-weight: 600 !important;
                justify-content: center !important;
                margin-top: 1px !important;
                color: ${state === 'on' ? 'rgb(200, 120, 0)' : 'rgba(120, 120, 130, 0.4)'} !important;
                transition: color 0.2s ease, opacity 0.15s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 16px 16px !important;
                z-index: 10 !important;
                background: rgba(0, 0, 0, 0.05) !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                background: rgb(255, 149, 0) !important;
              }
              .bubble-range-value {
                position: absolute !important;
                bottom: 48px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(30, 30, 35, 0.88) !important;
                color: #fff !important;
                padding: 2px 10px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-state {
                opacity: 0 !important;
              }
            `;
          })()}

      # ── Couch Lamp ──
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_couch_lamp
        name: Couch
        icon: mdi:lamp
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_couch_lamp
          data:
            brightness_pct: 100
        sub_button:
          main:
            - entity: switch.adaptive_lighting_main_living
              icon: mdi:sync
              show_state: false
              show_name: false
              show_background: true
              tap_action:
                action: call-service
                service: adaptive_lighting.set_manual_control
                data:
                  entity_id: switch.adaptive_lighting_main_living
                  lights:
                    - light.living_room_couch_lamp
                  manual_control: false
          bottom: []
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isManual = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).includes('light.living_room_couch_lamp');
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${state === 'on' ? '#ffffff' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${state === 'on' ? '1.5px solid rgba(255, 149, 0, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${state === 'on'
                  ? '0 2px 12px rgba(255, 149, 0, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-sub-button-container {
                position: absolute !important;
                top: 5px !important;
                right: 5px !important;
                z-index: 25 !important;
              }
              .bubble-sub-button-1 {
                display: ${isManual ? 'flex' : 'none'} !important;
                background: rgba(255, 110, 90, 0.12) !important;
                border: 1.5px solid rgba(255, 110, 90, 0.4) !important;
                border-radius: 50% !important;
                min-width: 28px !important;
                min-height: 28px !important;
                max-width: 28px !important;
                max-height: 28px !important;
                padding: 0 !important;
                transition: transform 0.1s ease, background 0.15s ease !important;
              }
              .bubble-sub-button-1:active {
                transform: scale(0.85) !important;
                background: rgba(255, 110, 90, 0.25) !important;
              }
              .bubble-sub-button-1 ha-icon {
                color: rgb(255, 110, 90) !important;
                --mdc-icon-size: 15px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${state === 'on'
                  ? 'linear-gradient(135deg, rgba(255, 149, 0, 0.14), rgba(255, 180, 60, 0.07))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${state === 'on'
                  ? '1.5px solid rgba(255, 149, 0, 0.2)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${state === 'on' ? 'rgb(255, 149, 0)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${state === 'on' ? 'drop-shadow(0 0 5px rgba(255, 149, 0, 0.3))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${state === 'on' ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
              .bubble-state {
                font-size: 12px !important;
                font-weight: 600 !important;
                justify-content: center !important;
                margin-top: 1px !important;
                color: ${state === 'on' ? 'rgb(200, 120, 0)' : 'rgba(120, 120, 130, 0.4)'} !important;
                transition: color 0.2s ease, opacity 0.15s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 16px 16px !important;
                z-index: 10 !important;
                background: rgba(0, 0, 0, 0.05) !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                background: rgb(255, 149, 0) !important;
              }
              .bubble-range-value {
                position: absolute !important;
                bottom: 48px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(30, 30, 35, 0.88) !important;
                color: #fff !important;
                padding: 2px 10px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-state {
                opacity: 0 !important;
              }
            `;
          })()}

      # ── Entry Lamp ──
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.entryway_lamp
        name: Entry
        icon: mdi:desk-lamp
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.entryway_lamp
          data:
            brightness_pct: 100
        sub_button:
          main:
            - entity: switch.adaptive_lighting_main_living
              icon: mdi:sync
              show_state: false
              show_name: false
              show_background: true
              tap_action:
                action: call-service
                service: adaptive_lighting.set_manual_control
                data:
                  entity_id: switch.adaptive_lighting_main_living
                  lights:
                    - light.entryway_lamp
                  manual_control: false
          bottom: []
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isManual = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).includes('light.entryway_lamp');
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${state === 'on' ? '#ffffff' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${state === 'on' ? '1.5px solid rgba(255, 149, 0, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${state === 'on'
                  ? '0 2px 12px rgba(255, 149, 0, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-sub-button-container {
                position: absolute !important;
                top: 5px !important;
                right: 5px !important;
                z-index: 25 !important;
              }
              .bubble-sub-button-1 {
                display: ${isManual ? 'flex' : 'none'} !important;
                background: rgba(255, 110, 90, 0.12) !important;
                border: 1.5px solid rgba(255, 110, 90, 0.4) !important;
                border-radius: 50% !important;
                min-width: 28px !important;
                min-height: 28px !important;
                max-width: 28px !important;
                max-height: 28px !important;
                padding: 0 !important;
                transition: transform 0.1s ease, background 0.15s ease !important;
              }
              .bubble-sub-button-1:active {
                transform: scale(0.85) !important;
                background: rgba(255, 110, 90, 0.25) !important;
              }
              .bubble-sub-button-1 ha-icon {
                color: rgb(255, 110, 90) !important;
                --mdc-icon-size: 15px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${state === 'on'
                  ? 'linear-gradient(135deg, rgba(255, 149, 0, 0.14), rgba(255, 180, 60, 0.07))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${state === 'on'
                  ? '1.5px solid rgba(255, 149, 0, 0.2)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${state === 'on' ? 'rgb(255, 149, 0)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${state === 'on' ? 'drop-shadow(0 0 5px rgba(255, 149, 0, 0.3))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${state === 'on' ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
              .bubble-state {
                font-size: 12px !important;
                font-weight: 600 !important;
                justify-content: center !important;
                margin-top: 1px !important;
                color: ${state === 'on' ? 'rgb(200, 120, 0)' : 'rgba(120, 120, 130, 0.4)'} !important;
                transition: color 0.2s ease, opacity 0.15s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 16px 16px !important;
                z-index: 10 !important;
                background: rgba(0, 0, 0, 0.05) !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                background: rgb(255, 149, 0) !important;
              }
              .bubble-range-value {
                position: absolute !important;
                bottom: 48px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(30, 30, 35, 0.88) !important;
                color: #fff !important;
                padding: 2px 10px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-state {
                opacity: 0 !important;
              }
            `;
          })()}

      # ── Recessed / Hallway ──
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: light.living_room_hallway_lights
        name: Recessed
        icon: mdi:light-recessed
        show_state: false
        show_attribute: true
        attribute: brightness
        scrolling_effect: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: light.turn_on
          target:
            entity_id: light.living_room_hallway_lights
          data:
            brightness_pct: 100
        sub_button:
          main:
            - entity: switch.adaptive_lighting_main_living
              icon: mdi:sync
              show_state: false
              show_name: false
              show_background: true
              tap_action:
                action: call-service
                service: adaptive_lighting.set_manual_control
                data:
                  entity_id: switch.adaptive_lighting_main_living
                  lights:
                    - light.living_room_hallway_lights
                  manual_control: false
          bottom: []
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isManual = (hass.states['sensor.room_living_state']?.attributes?.manually_controlled_lights || []).includes('light.living_room_hallway_lights');
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${state === 'on' ? '#ffffff' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${state === 'on' ? '1.5px solid rgba(255, 149, 0, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${state === 'on'
                  ? '0 2px 12px rgba(255, 149, 0, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-sub-button-container {
                position: absolute !important;
                top: 5px !important;
                right: 5px !important;
                z-index: 25 !important;
              }
              .bubble-sub-button-1 {
                display: ${isManual ? 'flex' : 'none'} !important;
                background: rgba(255, 110, 90, 0.12) !important;
                border: 1.5px solid rgba(255, 110, 90, 0.4) !important;
                border-radius: 50% !important;
                min-width: 28px !important;
                min-height: 28px !important;
                max-width: 28px !important;
                max-height: 28px !important;
                padding: 0 !important;
                transition: transform 0.1s ease, background 0.15s ease !important;
              }
              .bubble-sub-button-1:active {
                transform: scale(0.85) !important;
                background: rgba(255, 110, 90, 0.25) !important;
              }
              .bubble-sub-button-1 ha-icon {
                color: rgb(255, 110, 90) !important;
                --mdc-icon-size: 15px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${state === 'on'
                  ? 'linear-gradient(135deg, rgba(255, 149, 0, 0.14), rgba(255, 180, 60, 0.07))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${state === 'on'
                  ? '1.5px solid rgba(255, 149, 0, 0.2)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${state === 'on' ? 'rgb(255, 149, 0)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${state === 'on' ? 'drop-shadow(0 0 5px rgba(255, 149, 0, 0.3))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${state === 'on' ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
              .bubble-state {
                font-size: 12px !important;
                font-weight: 600 !important;
                justify-content: center !important;
                margin-top: 1px !important;
                color: ${state === 'on' ? 'rgb(200, 120, 0)' : 'rgba(120, 120, 130, 0.4)'} !important;
                transition: color 0.2s ease, opacity 0.15s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 16px 16px !important;
                z-index: 10 !important;
                background: rgba(0, 0, 0, 0.05) !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                background: rgb(255, 149, 0) !important;
              }
              .bubble-range-value {
                position: absolute !important;
                bottom: 48px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(30, 30, 35, 0.88) !important;
                color: #fff !important;
                padding: 2px 10px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-state {
                opacity: 0 !important;
              }
            `;
          })()}

  # ── MEDIA GRID (3 columns) ──
  - type: custom:layout-card
    layout_type: custom:grid-layout
    layout:
      grid-template-columns: repeat(3, 1fr)
      gap: 10px
      padding: 4px 16px 12px 16px
      mediaquery:
        "(max-width: 500px)":
          grid-template-columns: repeat(2, 1fr)
    cards:
      # ── Sonos Speaker ──
      - type: custom:bubble-card
        card_type: button
        button_type: slider
        entity: media_player.living_room
        name: Sonos
        icon: mdi:speaker
        show_state: false
        show_attribute: true
        attribute: volume_level
        scrolling_effect: false
        tap_action:
          action: perform-action
          perform_action: media_player.media_play_pause
          target:
            entity_id: media_player.living_room
        hold_action:
          action: more-info
        double_tap_action:
          action: call-service
          service: script.sonos_toggle_group_membership
          data:
            target_speaker: media_player.living_room
        sub_button:
          main: []
          bottom: []
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const inGroup = hass.states['binary_sensor.sonos_living_room_in_playing_group']?.state === 'on';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${inGroup ? 'rgba(66, 133, 244, 0.08)' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${inGroup ? '1.5px solid rgba(66, 133, 244, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${inGroup
                  ? '0 2px 12px rgba(66, 133, 244, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-button-card-container::after {
                content: '' !important;
                position: absolute !important;
                top: 6px !important;
                right: 6px !important;
                width: ${inGroup ? '8px' : '0px'} !important;
                height: ${inGroup ? '8px' : '0px'} !important;
                border-radius: 50% !important;
                background: rgb(66, 133, 244) !important;
                border: 1.5px solid rgba(255, 255, 255, 0.9) !important;
                box-shadow: 0 0 4px rgba(66, 133, 244, 0.5) !important;
                transition: width 0.2s ease, height 0.2s ease !important;
                z-index: 25 !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${inGroup
                  ? 'linear-gradient(135deg, rgba(66, 133, 244, 0.16), rgba(100, 160, 244, 0.08))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${inGroup
                  ? '1.5px solid rgba(66, 133, 244, 0.25)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${inGroup ? 'rgb(66, 133, 244)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${inGroup ? 'drop-shadow(0 0 5px rgba(66, 133, 244, 0.35))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${inGroup ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
              .bubble-state {
                font-size: 12px !important;
                font-weight: 600 !important;
                justify-content: center !important;
                margin-top: 1px !important;
                color: ${inGroup ? 'rgb(50, 100, 200)' : 'rgba(120, 120, 130, 0.4)'} !important;
                transition: color 0.2s ease, opacity 0.15s ease !important;
              }
              .bubble-range-slider {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 4px !important;
                border-radius: 0 0 16px 16px !important;
                z-index: 10 !important;
                background: rgba(0, 0, 0, 0.05) !important;
                overflow: visible !important;
                opacity: 1 !important;
              }
              .bubble-range-fill {
                height: 4px !important;
                background: rgb(66, 133, 244) !important;
              }
              .bubble-range-value {
                position: absolute !important;
                bottom: 48px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(30, 30, 35, 0.88) !important;
                color: #fff !important;
                padding: 2px 10px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.15s ease !important;
                z-index: 30 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
              }
              .is-dragging .bubble-range-value {
                opacity: 1 !important;
              }
              .is-dragging .bubble-state {
                opacity: 0 !important;
              }
            `;
          })()}

      # ── Apple TV ──
      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: media_player.living_room_apple_tv
        name: Apple TV
        icon: mdi:apple
        show_state: false
        tap_action:
          action: perform-action
          perform_action: media_player.media_play_pause
          target:
            entity_id: media_player.living_room_apple_tv
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isPlaying = hass.states['media_player.living_room_apple_tv']?.state === 'playing';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${isPlaying ? 'rgba(66, 133, 244, 0.08)' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${isPlaying ? '1.5px solid rgba(66, 133, 244, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${isPlaying
                  ? '0 2px 12px rgba(66, 133, 244, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isPlaying
                  ? 'linear-gradient(135deg, rgba(66, 133, 244, 0.16), rgba(100, 160, 244, 0.08))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${isPlaying
                  ? '1.5px solid rgba(66, 133, 244, 0.25)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${isPlaying ? 'rgb(66, 133, 244)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${isPlaying ? 'drop-shadow(0 0 5px rgba(66, 133, 244, 0.35))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${isPlaying ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
            `;
          })()}

      # ── Samsung TV ──
      - type: custom:bubble-card
        card_type: button
        button_type: state
        entity: media_player.living_room_samsung_q60
        name: Samsung
        icon: mdi:television
        show_state: false
        tap_action:
          action: toggle
        hold_action:
          action: more-info
        card_mod:
          style: |
            ha-card {
              background: transparent !important;
              border: none !important;
              box-shadow: none !important;
            }
        styles: |-
          ${(() => {
            const isOn = hass.states['media_player.living_room_samsung_q60']?.state === 'on';
            return `
              .bubble-button-card-container {
                position: relative !important;
                display: grid !important;
                grid-template-rows: auto auto 1fr auto !important;
                justify-items: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 110px !important;
                padding: 14px 6px 10px 6px !important;
                border-radius: 16px !important;
                overflow: visible !important;
                transition: transform 0.12s ease-out, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease !important;
                background: ${isOn ? 'rgba(66, 133, 244, 0.08)' : 'rgba(245, 245, 247, 0.85)'} !important;
                border: ${isOn ? '1.5px solid rgba(66, 133, 244, 0.45)' : '1.5px solid rgba(210, 210, 215, 0.5)'} !important;
                box-shadow: ${isOn
                  ? '0 2px 12px rgba(66, 133, 244, 0.1), 0 1px 3px rgba(0,0,0,0.03)'
                  : '0 1px 3px rgba(0, 0, 0, 0.04)'} !important;
              }
              .bubble-button-card-container:active {
                transform: scale(0.96) !important;
              }
              .bubble-content-container {
                display: grid !important;
                grid-template-rows: auto auto 1fr !important;
                justify-items: center !important;
                width: 100% !important;
                position: relative !important;
                z-index: 5 !important;
                padding-bottom: 10px !important;
              }
              .bubble-icon-container {
                min-width: 48px !important;
                min-height: 48px !important;
                grid-row: 1 !important;
                margin: 2px 0 6px 0 !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                background: ${isOn
                  ? 'linear-gradient(135deg, rgba(66, 133, 244, 0.16), rgba(100, 160, 244, 0.08))'
                  : 'rgba(160, 160, 170, 0.12)'} !important;
                border: ${isOn
                  ? '1.5px solid rgba(66, 133, 244, 0.25)'
                  : '1.5px solid rgba(160, 160, 170, 0.2)'} !important;
                transition: background 0.25s ease, border 0.25s ease !important;
              }
              .bubble-icon {
                --mdc-icon-size: 26px !important;
                color: ${isOn ? 'rgb(66, 133, 244)' : 'rgba(100, 100, 110, 0.45)'} !important;
                filter: ${isOn ? 'drop-shadow(0 0 5px rgba(66, 133, 244, 0.35))' : 'none'} !important;
                transition: color 0.25s ease, filter 0.25s ease !important;
              }
              .bubble-name-container {
                grid-row: 2 !important;
                margin: 0 !important;
                width: 100% !important;
              }
              .bubble-name {
                font-weight: 600 !important;
                font-size: 13px !important;
                line-height: 1.2 !important;
                justify-content: center !important;
                color: ${isOn ? 'rgba(25, 25, 30, 0.9)' : 'rgba(80, 80, 90, 0.55)'} !important;
                transition: color 0.2s ease !important;
              }
            `;
          })()}

# ── OUTER CARD CONTAINER ──
card_mod:
  style: |
    :host {
      display: block !important;
      background: rgba(255, 255, 255, 0.98) !important;
      border-radius: 24px !important;
      padding: 6px 0 12px 0 !important;
      margin-bottom: 16px !important;
      box-shadow: 0 1px 12px rgba(0, 0, 0, 0.07), 0 0 1px rgba(0, 0, 0, 0.04) !important;
      border: 1px solid rgba(0, 0, 0, 0.03) !important;
      overflow: hidden !important;
    }
